<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PadPad Poker | Tables</title>
  <style>
    :root {
      --bg: #0b1224;
      --panel: #0f172a;
      --panel-border: #1f2937;
      --accent: #22c55e;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --btn: #2563eb;
      --btn-hover: #1d4ed8;
      --danger: #dc2626;
      --gold: #c8a36b;
      --card: #11192e;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .legal-footer {
      position: fixed;
      right: 16px;
      bottom: 16px;
      font-size: 11px;
      color: var(--text-muted, #9ca3af);
      z-index: 10;
    }

    .legal-footer a {
      color: inherit;
      text-decoration: none;
    }

    .legal-footer a + a {
      margin-left: 8px;
    }

    .legal-footer a:hover {
      color: #fff;
      text-decoration: underline;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--panel-border);
      background: rgba(15, 23, 42, 0.9);
      position: sticky;
      top: 0;
      z-index: 2;
      backdrop-filter: blur(12px);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-actions .btn {
      min-width: 130px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-circle {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      display: grid;
      place-items: center;
      font-weight: 700;
      color: #0b1224;
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.1);
      overflow: hidden;
    }

    .logo-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: 50%;
    }

    .page-title {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    main {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .panel h2 {
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .progress-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 30;
    }

    .progress-modal.show {
      display: flex;
    }

    .progress-card {
      width: min(560px, 95vw);
      background: #0f172a;
      border: 1px solid var(--panel-border);
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 18px 50px rgba(0, 0, 0, 0.6);
    }

    .progress-card header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .progress-title { margin: 0; }

    .progress-meta {
      color: var(--text-muted);
      margin: 4px 0 0;
      font-size: 13px;
    }

    .progress-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 10px;
    }

    .progress-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--panel-border);
    }

    .progress-label { color: var(--text-muted); font-size: 13px; }

    .progress-value { font-weight: 700; }

    .subtext {
      color: var(--text-muted);
      margin: 6px 0 0;
      font-size: 14px;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .table-filter {
      margin-top: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid var(--panel-border);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-main);
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.02em;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    }

    .filter-btn:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(255, 255, 255, 0.14);
    }

    .filter-btn.active {
      background: linear-gradient(135deg, var(--btn), var(--btn-hover));
      color: #fff;
      border-color: var(--btn-hover);
      box-shadow: 0 8px 30px rgba(37, 99, 235, 0.3);
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.08);
      border: 1px solid rgba(34, 197, 94, 0.24);
      color: #bbf7d0;
      font-size: 13px;
      letter-spacing: 0.01em;
    }

    .status-pill.is-error {
      background: rgba(220, 38, 38, 0.08);
      border-color: rgba(220, 38, 38, 0.3);
      color: #fecaca;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      font-size: 14px;
      user-select: none;
    }

    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--panel-border);
      background: linear-gradient(135deg, var(--btn), var(--btn-hover));
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn.secondary {
      background: transparent;
      color: var(--text-main);
      border-color: #1f2a3c;
    }

    .table-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }

    .table-card {
      background: var(--card);
      border: 1px solid var(--panel-border);
      border-radius: 14px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      z-index: 1;
    }

    .table-card-main {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      align-items: center;
    }

    .table-title { font-weight: 800; font-size: 18px; }
    .table-meta { color: var(--text-muted); font-size: 14px; }

    .table-seats {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .seat-pill {
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(34, 197, 94, 0.15);
      color: #a7f3d0;
      border: 1px solid rgba(34, 197, 94, 0.35);
      font-weight: 700;
    }

    .table-tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tag-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: #cbd5e1;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .tag-chip.success {
      color: #befae3;
      border-color: rgba(34, 197, 94, 0.4);
      background: rgba(34, 197, 94, 0.1);
    }

    .tournament-card {
      background: var(--card);
      border: 1px solid var(--panel-border);
      border-radius: 14px;
      padding: 16px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
    }

    .tournament-card h3 {
      margin: 0 0 4px;
    }

    .tournament-meta { color: var(--text-muted); margin: 4px 0; font-size: 14px; }

    .tournament-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }

    .tournament-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }

    .tournament-pill { padding: 8px 12px; border-radius: 999px; background: rgba(59, 130, 246, 0.12); color: #bfdbfe; border: 1px solid rgba(59, 130, 246, 0.35); font-weight: 700; letter-spacing: 0.04em; }

    .status-text { color: #86efac; font-weight: 700; letter-spacing: 0.03em; text-transform: uppercase; font-size: 12px; }

    .empty-state {
      text-align: center;
      padding: 28px 16px;
      color: var(--text-muted);
      border: 1px dashed var(--panel-border);
      border-radius: 14px;
    }

    .error {
      color: #fca5a5;
      margin-top: 12px;
      font-size: 14px;
    }

    @media (max-width: 640px) {
      .table-card-main { flex-direction: column; align-items: flex-start; }
      header { flex-direction: column; align-items: flex-start; gap: 8px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo-circle" id="navAvatar">P</div>
      <div>
        <p class="page-title">Available Tables</p>
        <p class="subtext">Pick a table created by your club owner.</p>
      </div>
    </div>
    <div class="header-actions">
      <a class="btn" id="createClubBtn" href="/create-club">Create club</a>
      <a class="btn secondary" id="dataOverviewBtn" href="/admin" style="display:none">Admin</a>
      <a class="btn secondary" id="clubManagerBtn" href="/club-management" style="display:none">Club manager</a>
      <a class="btn secondary" href="/profile">Profile</a>
      <button class="btn secondary" id="logoutBtn">Logout</button>
    </div>
  </header>

  <main>
    <div class="panel">
      <div class="panel-header">
        <div>
          <h2>Club tables</h2>
          <p class="subtext">Join a table to be redirected to the poker view.</p>
        </div>
        <div class="controls">
          <label class="checkbox-row">
            <input type="checkbox" id="hideFullTables" /> Hide full tables
          </label>
          <span class="subtext" id="liveStatus">Live updates</span>
          <span class="status-pill" id="onlineCount">Players online: --</span>
        </div>
      </div>

      <div class="table-filter" aria-label="Table type filter">
        <button class="filter-btn active" type="button" data-table-filter="all">All tables</button>
        <button class="filter-btn" type="button" data-table-filter="plo">PLO only</button>
        <button class="filter-btn" type="button" data-table-filter="nlh">NLH only</button>
      </div>

      <div id="tableList" class="table-list"></div>
      <div id="errorBox" class="error" style="display:none"></div>
    </div>

    <div class="panel" style="margin-top: 16px;">
      <div class="panel-header">
        <div>
          <h2>Club tournaments</h2>
          <p class="subtext">Register for structured events. New tables open automatically as each fills.</p>
        </div>
      </div>

      <div id="tournamentList" class="table-list"></div>
      <div id="tournamentEmpty" class="empty-state" style="display:none;">No tournaments posted yet.</div>
    </div>
  </main>

  <div id="tournamentProgressModal" class="progress-modal" role="dialog" aria-modal="true">
    <div class="progress-card">
      <header>
        <div>
          <h3 id="tournamentProgressTitle" class="progress-title">Tournament progress</h3>
          <div id="tournamentProgressMeta" class="progress-meta">Live snapshot for this table</div>
        </div>
        <button id="closeTournamentProgress" class="btn secondary" type="button">Close</button>
      </header>
      <ul id="tournamentProgressList" class="progress-list"></ul>
    </div>
  </div>

  <script src="/static/custom-alert.js"></script>
  <script>
    const authInfo = JSON.parse(localStorage.getItem("pokerAuth") || "{}");
    const AUTH_KEY = "poker_token";
    const AUTH_STORAGE_KEY = "pokerAuth";
    const TOURNAMENT_STORAGE_KEY = "clubTournaments";
    const CLUB_CONTEXT_KEY = "pokerActiveClubId";
    let accessToken = localStorage.getItem(AUTH_KEY);
    let currentUserEmail = authInfo.email || "";
    let currentUserId = null;

    if (!accessToken) {
      window.location.href = "/";
    }

    const ADMIN_EMAILS = ["paddywarren99@gmail.com", "padpadpoker@gmail.com"];

    const navAvatar = document.getElementById("navAvatar");
    const clubManagerBtn = document.getElementById("clubManagerBtn");
    const dataOverviewBtn = document.getElementById("dataOverviewBtn");
    const tableList = document.getElementById("tableList");
    const hideFullCheckbox = document.getElementById("hideFullTables");
    const liveStatus = document.getElementById("liveStatus");
    const onlineCount = document.getElementById("onlineCount");
    const errorBox = document.getElementById("errorBox");
    const tableFilterButtons = Array.from(document.querySelectorAll("[data-table-filter]"));
    const logoutBtn = document.getElementById("logoutBtn");
    const tournamentListEl = document.getElementById("tournamentList");
    const tournamentEmptyEl = document.getElementById("tournamentEmpty");
    const tournamentProgressModal = document.getElementById("tournamentProgressModal");
    const tournamentProgressTitle = document.getElementById("tournamentProgressTitle");
    const tournamentProgressMeta = document.getElementById("tournamentProgressMeta");
    const tournamentProgressList = document.getElementById("tournamentProgressList");
    const closeTournamentProgressBtn = document.getElementById("closeTournamentProgress");
    const TABLE_REFRESH_MS = 10000;
    let tableRefreshTimer = null;
    let isTablesLoading = false;
    const tableStates = {};
    let currentTableFilter = "all";

    function restoreAuthMetadata() {
      try {
        const raw = localStorage.getItem(AUTH_STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed.email) {
          currentUserEmail = parsed.email;
        }
      } catch (err) {
        console.warn("Failed to restore auth metadata", err);
      }
    }

    function formatTableName(table) {
      if (!table) return "Table";
      const customName = (table.table_name || "").trim();
      if (customName) return customName;
      if (table.id != null) return `Table #${table.id}`;
      return "Table";
    }

    if (tableList) {
      tableList.addEventListener("click", (event) => {
        const sitButton = event.target.closest(".sit-table-btn");
        if (!sitButton) return;
        event.preventDefault();
        const tableId = sitButton.dataset.tableId;
        if (!tableId) return;
        window.location.href = `/poker?tableId=${tableId}`;
      });
    }

    async function api(path, options = {}) {
      const headers = {
        "Content-Type": "application/json",
        ...(options.headers || {}),
      };
      if (accessToken) headers["Authorization"] = `Bearer ${accessToken}`;

      const res = await fetch(path, { ...options, headers });
      if (res.status === 401) {
        localStorage.removeItem(AUTH_KEY);
        window.location.href = "/";
        return Promise.reject(new Error("Unauthorized"));
      }
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || `Error ${res.status}`);
      }
      return res.json();
    }

    async function determineClubOwnership() {
      if (clubManagerBtn) clubManagerBtn.style.display = "none";
      if (dataOverviewBtn) dataOverviewBtn.style.display = "none";

      if (!currentUserEmail) restoreAuthMetadata();
      if (!currentUserEmail) return;

      const normalizedEmail = currentUserEmail.toLowerCase();
      if (
        dataOverviewBtn &&
        ADMIN_EMAILS.some((email) => email.toLowerCase() === normalizedEmail)
      ) {
        dataOverviewBtn.style.display = "inline-flex";
      }

      try {
        const me = await api(`/me?email=${encodeURIComponent(currentUserEmail)}`, {
          method: "GET",
        });
        currentUserId = me?.id ?? null;
        if (!currentUserId) return;

        const clubs = await api("/clubs/", { method: "GET" });
        const ownsClub = Array.isArray(clubs)
          ? clubs.some((club) => club.is_owner)
          : false;
        clubManagerBtn.style.display = ownsClub ? "inline-flex" : "none";
      } catch (err) {
        console.warn("Failed to determine club ownership", err);
      }
    }

    async function ensureClubMembership() {
      try {
        const clubs = await api("/clubs/", { method: "GET" });
        if (!Array.isArray(clubs) || clubs.length === 0) {
          window.location.href = "/create-club";
          return false;
        }
        return true;
      } catch (err) {
        errorBox.textContent = err.message || "Unable to load club info";
        errorBox.style.display = "block";
        return false;
      }
    }

    function renderAvatar(targetEl, url, fallbackText) {
      if (!targetEl) return;

      targetEl.innerHTML = "";
      if (url) {
        const img = document.createElement("img");
        img.src = url;
        img.alt = "Profile picture";
        img.onerror = () => {
          targetEl.textContent = fallbackText;
        };
        targetEl.appendChild(img);
      } else {
        targetEl.textContent = fallbackText;
      }
    }

    async function loadProfileAvatar() {
      if (!currentUserEmail) restoreAuthMetadata();
      if (!currentUserEmail) return;

      try {
        const data = await api(`/me/profile?email=${encodeURIComponent(currentUserEmail)}`);
        const fallbackInitial = data.username?.[0]?.toUpperCase() || currentUserEmail?.[0]?.toUpperCase() || "P";
        renderAvatar(navAvatar, data.profile_picture_url, fallbackInitial);
      } catch (error) {
        console.warn("Failed to load profile avatar", error);
        const fallbackInitial = currentUserEmail?.[0]?.toUpperCase() || "P";
        renderAvatar(navAvatar, null, fallbackInitial);
      }
    }

    function loadStoredTournaments() {
      try {
        const raw = localStorage.getItem(TOURNAMENT_STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (err) {
        console.warn("Failed to read tournaments", err);
        return [];
      }
    }

    function saveStoredTournaments(list) {
      try {
        localStorage.setItem(TOURNAMENT_STORAGE_KEY, JSON.stringify(list));
      } catch (err) {
        console.warn("Failed to save tournaments", err);
      }
    }

    function calculateActiveTables(playersCount, tableSize) {
      const seats = Math.max(Number(tableSize) || 1, 1);
      const players = Math.max(playersCount || 0, 0);
      return Math.max(1, Math.ceil(players / seats) || 1);
    }

    function findActiveTournamentForClub(clubId) {
      const tournaments = loadStoredTournaments();
      return tournaments
        .filter((t) => (t.clubId == null || t.clubId === clubId))
        .find((t) => (t.status || "registering") !== "completed");
    }

    function formatMsAsDuration(ms) {
      if (!Number.isFinite(ms)) return "--";
      const totalSeconds = Math.max(0, Math.floor(ms / 1000));
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      if (minutes > 0) return `${minutes}m ${seconds.toString().padStart(2, "0")}s`;
      return `${seconds}s`;
    }

    function renderTournamentProgress(table) {
      if (!tournamentProgressModal || !tournamentProgressList || !tournamentProgressTitle || !tournamentProgressMeta) return;

      const tournament = findActiveTournamentForClub(table.club_id);
      const state = tableStates[table.id];
      const players = Array.isArray(state?.players) ? state.players : [];
      const stacks = players
        .map((p) => ({ name: p.name || `Seat ${p.seat}`, stack: Number(p.stack) }))
        .filter((p) => Number.isFinite(p.stack));

      const chipLeader = stacks.reduce(
        (leader, p) => (leader == null || p.stack > leader.stack ? p : leader),
        null
      );
      const totalStack = stacks.reduce((sum, p) => sum + p.stack, 0);
      const avgStack = stacks.length ? totalStack / stacks.length : null;

      let regDetail = "Late reg info unavailable";
      if (tournament?.lateRegMinutes && tournament?.startAt) {
        const regClose = new Date(tournament.startAt).getTime() + tournament.lateRegMinutes * 60000;
        const remaining = regClose - Date.now();
        regDetail = remaining > 0
          ? `Late reg closes in ${formatMsAsDuration(remaining)}`
          : "Late reg closed";
      } else if (tournament?.lateRegMinutes) {
        regDetail = `Late reg window: ${tournament.lateRegMinutes} mins`;
      }

      tournamentProgressTitle.textContent = tournament?.name || "Club tournament";
      const statusText = tournament?.status ? tournament.status.toUpperCase() : "RUNNING";
      tournamentProgressMeta.textContent = `${statusText} • ${formatTableName(table)}`;

      tournamentProgressList.innerHTML = "";

      const items = [
        { label: "Players seated", value: players.length ? `${players.length} players` : "No seats yet" },
        { label: "Chip leader", value: chipLeader ? `${chipLeader.name} (${chipLeader.stack} chips)` : "Not available" },
        { label: "Average stack", value: avgStack ? `${Math.round(avgStack)} chips` : "Not available" },
        { label: "Registration", value: regDetail },
        { label: "Table size", value: `${table.max_seats}-max` },
      ];

      items.forEach((item) => {
        const li = document.createElement("li");
        li.className = "progress-item";
        const label = document.createElement("span");
        label.className = "progress-label";
        label.textContent = item.label;
        const value = document.createElement("span");
        value.className = "progress-value";
        value.textContent = item.value;
        li.appendChild(label);
        li.appendChild(value);
        tournamentProgressList.appendChild(li);
      });

      tournamentProgressModal.classList.add("show");
    }

    function closeTournamentProgress() {
      tournamentProgressModal?.classList.remove("show");
    }

    async function loadOnlinePlayerCount() {
      if (!onlineCount) return;

      try {
        const data = await api("/tables/online-count", { method: "GET" });
        const count = Number(data?.online_players ?? data?.count ?? 0);
        const safeCount = Number.isFinite(count) ? count : 0;
        const noun = safeCount === 1 ? "player" : "players";
        onlineCount.textContent = `${safeCount} ${noun} online`;
        onlineCount.classList.remove("is-error");
      } catch (err) {
        onlineCount.textContent = "Players online: --";
        onlineCount.classList.add("is-error");
      }
    }

    function formatCurrency(value) {
      const num = Number(value);
      if (!Number.isFinite(num)) return "Custom";
      return `$${num.toFixed(2)}`;
    }

    function renderTournaments(tournaments) {
      if (!tournamentListEl || !tournamentEmptyEl) return;
      tournamentListEl.innerHTML = "";
      tournamentEmptyEl.style.display = "none";
      if (!Array.isArray(tournaments) || tournaments.length === 0) {
        tournamentEmptyEl.style.display = "block";
        return;
      }

      tournaments.forEach((tournament) => {
        const players = Array.isArray(tournament.players) ? tournament.players : [];
        const playersCount = players.length;
        const tableSize = tournament.tableSize || 8;
        const activeTables = tournament.activeTables || calculateActiveTables(playersCount, tableSize);
        const playerId = currentUserEmail || "guest-player";
        const alreadyJoined = players.some((p) => p.email === playerId);

        const card = document.createElement("div");
        card.className = "tournament-card";

        const body = document.createElement("div");
        const title = document.createElement("h3");
        title.textContent = tournament.name || "Club tournament";
        body.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "tournament-meta";
        const buyInLabel = formatCurrency(tournament.buyIn);
        const feeLabel = tournament.fee ? ` + ${formatCurrency(tournament.fee)} fee` : "";
        const stackLabel = tournament.startingStack ? `${tournament.startingStack} chips` : "Custom stack";
        meta.textContent = `${buyInLabel}${feeLabel} • ${stackLabel} • ${tournament.levelDuration || 10} min levels`;
        body.appendChild(meta);

        const regMeta = document.createElement("div");
        regMeta.className = "tournament-meta";
        regMeta.textContent = `Late reg: ${tournament.lateRegMinutes || 0} mins • Table size: ${tableSize} • Auto tables: ${activeTables}`;
        body.appendChild(regMeta);

        const tags = document.createElement("div");
        tags.className = "tournament-tags";

        const statusTag = document.createElement("span");
        statusTag.className = "tag-chip success";
        statusTag.textContent = tournament.status ? tournament.status.toUpperCase() : "REGISTERING";
        tags.appendChild(statusTag);

        const structureTag = document.createElement("span");
        structureTag.className = "tag-chip";
        structureTag.textContent = `${tableSize}-max tables`;
        tags.appendChild(structureTag);

        const reentryTag = document.createElement("span");
        reentryTag.className = "tag-chip";
        reentryTag.textContent = tournament.allowReEntry ? "Re-entry allowed" : "Freezeout";
        tags.appendChild(reentryTag);

        const blindTag = document.createElement("span");
        blindTag.className = "tag-chip";
        blindTag.textContent = tournament.blindPacing ? `${tournament.blindPacing} structure` : "ClubGG-inspired";
        tags.appendChild(blindTag);

        body.appendChild(tags);

        const actions = document.createElement("div");
        actions.className = "tournament-actions";

        const statusText = document.createElement("div");
        statusText.className = "status-text";
        statusText.textContent = tournament.status ? tournament.status.toUpperCase() : "REGISTERING";
        actions.appendChild(statusText);

        const tablesPill = document.createElement("div");
        tablesPill.className = "tournament-pill";
        const tableWord = activeTables === 1 ? "table" : "tables";
        tablesPill.textContent = `${playersCount} joined • ${activeTables} ${tableWord}`;
        actions.appendChild(tablesPill);

        const joinBtn = document.createElement("button");
        joinBtn.className = alreadyJoined ? "btn secondary" : "btn";
        joinBtn.textContent = alreadyJoined ? "Joined" : "Join tournament";
        joinBtn.disabled = alreadyJoined;
        joinBtn.onclick = () => joinTournament(tournament.id);
        actions.appendChild(joinBtn);

        card.appendChild(body);
        card.appendChild(actions);
        tournamentListEl.appendChild(card);
      });
    }

    function joinTournament(tournamentId) {
      if (!tournamentId) return;
      if (!currentUserEmail) restoreAuthMetadata();
      const playerEmail = currentUserEmail || "guest-player";

      const tournaments = loadStoredTournaments();
      const index = tournaments.findIndex((t) => t.id === tournamentId);
      if (index === -1) return;

      const tournament = tournaments[index];
      tournament.players = Array.isArray(tournament.players) ? tournament.players : [];
      const alreadyJoined = tournament.players.some((p) => p.email === playerEmail);
      if (!alreadyJoined) {
        tournament.players.push({ email: playerEmail, joinedAt: new Date().toISOString() });
      }
      tournament.activeTables = calculateActiveTables(tournament.players.length, tournament.tableSize || 8);
      tournaments[index] = tournament;
      saveStoredTournaments(tournaments);
      renderTournaments(tournaments);
      alert(`You're registered for ${tournament.name || "the tournament"}. Tables will auto-open as seats fill.`);
    }

    function renderTables(tables) {
      tableList.innerHTML = "";
      if (!tables.length) {
        tableList.innerHTML = '<div class="empty-state">No tables open right now, but you can open them within the club management area.</div>';
        return;
      }

      tables.forEach((tbl) => {
        const card = document.createElement("div");
        card.className = "table-card";

        const title = document.createElement("div");
        title.className = "table-title";
        title.textContent = formatTableName(tbl);

        const meta = document.createElement("div");
        meta.className = "table-meta";
        const gameType = (tbl.game_type || "nlh").toUpperCase();
        meta.textContent = `${gameType} • Blinds ${tbl.small_blind}/${tbl.big_blind} • Club ${tbl.club_id}`;

        const left = document.createElement("div");
        left.appendChild(title);
        left.appendChild(meta);

        const seats = document.createElement("div");
        seats.className = "seat-pill";
        const seatsLabel = (tbl.playersCount ?? null) !== null
          ? `${tbl.playersCount}/${tbl.max_seats}`
          : `${tbl.max_seats} seats`;
        seats.textContent = seatsLabel;

        const joinBtn = document.createElement("button");
        joinBtn.className = "btn sit-table-btn";
        joinBtn.type = "button";
        joinBtn.dataset.tableId = String(tbl.id);
        joinBtn.textContent = "Sit at table";

        const seatWrap = document.createElement("div");
        seatWrap.className = "table-seats";
        seatWrap.appendChild(seats);
        seatWrap.appendChild(joinBtn);

        const hasTournament = Boolean(findActiveTournamentForClub(tbl.club_id));
        if (hasTournament) {
          const progressBtn = document.createElement("button");
          progressBtn.className = "btn secondary";
          progressBtn.textContent = "Tournament progress";
          progressBtn.onclick = () => renderTournamentProgress(tbl);
          seatWrap.appendChild(progressBtn);
        }

        const mainRow = document.createElement("div");
        mainRow.className = "table-card-main";
        mainRow.appendChild(left);
        mainRow.appendChild(seatWrap);

        const tags = document.createElement("div");
        tags.className = "table-tags";
        const statusTag = document.createElement("span");
        statusTag.className = "tag-chip success";
        statusTag.textContent = tbl.status ? tbl.status.toUpperCase() : "ACTIVE";
        const seatsTag = document.createElement("span");
        seatsTag.className = "tag-chip";
        seatsTag.textContent = `${tbl.max_seats}-max table`;
        const gameTag = document.createElement("span");
        gameTag.className = "tag-chip";
        gameTag.textContent = (tbl.game_type || "nlh").toUpperCase();
        tags.appendChild(statusTag);
        tags.appendChild(seatsTag);
        tags.appendChild(gameTag);

        card.appendChild(mainRow);
        card.appendChild(tags);
        tableList.appendChild(card);
      });
    }

    async function loadTables() {
      if (isTablesLoading) return;
      isTablesLoading = true;
      tableList.innerHTML = '<div class="empty-state">Loading tables...</div>';
      errorBox.style.display = "none";
      try {
        const tables = await api("/tables/", { method: "GET" });
        const hideFull = hideFullCheckbox?.checked;
        const enriched = [];

        for (const tbl of tables) {
          let playersCount = null;
          try {
            const state = await api(`/tables/${tbl.id}`, { method: "GET" });
            tableStates[tbl.id] = state;
            if (Array.isArray(state.players)) playersCount = state.players.length;
          } catch (err) {
            console.warn("Failed to load table state", err);
            tableStates[tbl.id] = null;
          }

          if (hideFull && playersCount !== null && playersCount >= tbl.max_seats) {
            continue;
          }

          enriched.push({ ...tbl, playersCount });
        }
        const filtered = enriched.filter((tbl) => {
          if (currentTableFilter === "all") return true;
          const gameType = (tbl.game_type || "nlh").toLowerCase();
          return gameType === currentTableFilter;
        });

        renderTables(filtered);
      } catch (err) {
        errorBox.textContent = err.message || "Unable to load tables";
        errorBox.style.display = "block";
        tableList.innerHTML = "";
      } finally {
        isTablesLoading = false;
      }
    }

    function setTableFilter(filter) {
      currentTableFilter = filter;
      tableFilterButtons.forEach((btn) => {
        const isActive = btn.dataset.tableFilter === filter;
        btn.classList.toggle("active", isActive);
      });
      loadTables();
    }

    function startAutoRefresh() {
      if (tableRefreshTimer) clearInterval(tableRefreshTimer);
      tableRefreshTimer = setInterval(() => {
        if (!document.hidden) {
          loadTables();
          loadOnlinePlayerCount();
          renderTournaments(loadStoredTournaments());
        }
      }, TABLE_REFRESH_MS);

      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
          loadTables();
          loadOnlinePlayerCount();
          renderTournaments(loadStoredTournaments());
        }
      });

      if (liveStatus) {
        liveStatus.textContent = "Live updates every 10 seconds";
      }
    }
    hideFullCheckbox.addEventListener("change", loadTables);

    tableFilterButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        setTableFilter(btn.dataset.tableFilter || "all");
      });
    });

    closeTournamentProgressBtn?.addEventListener("click", closeTournamentProgress);
    tournamentProgressModal?.addEventListener("click", (event) => {
      if (event.target === tournamentProgressModal) {
        closeTournamentProgress();
      }
    });

    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem(AUTH_KEY);
      localStorage.removeItem("pokerAuth");
      window.location.href = "/";
    });

    restoreAuthMetadata();
    loadProfileAvatar();
    determineClubOwnership();
    ensureClubMembership().then((ok) => {
      if (ok) {
        loadTables();
        loadOnlinePlayerCount();
        renderTournaments(loadStoredTournaments());
        startAutoRefresh();
      }
    });
  </script>

<div class="legal-footer">
  Play-money entertainment only. Read our
  <a href="/legal.html" target="_blank" rel="noopener">legal disclaimer</a>
  and
  <a href="/terms.html" target="_blank" rel="noopener">terms of service</a>.
</div>
</body>
</html>
