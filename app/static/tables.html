<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PadPad Poker | Tables</title>
  <style>
    :root {
      --bg: #0b1224;
      --panel: #0f172a;
      --panel-border: #1f2937;
      --accent: #22c55e;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --btn: #2563eb;
      --btn-hover: #1d4ed8;
      --danger: #dc2626;
      --gold: #c8a36b;
      --card: #11192e;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .legal-footer {
      position: fixed;
      right: 16px;
      bottom: 16px;
      font-size: 11px;
      color: var(--text-muted, #9ca3af);
      z-index: 10;
    }

    .legal-footer a {
      color: inherit;
      text-decoration: none;
    }

    .legal-footer a + a {
      margin-left: 8px;
    }

    .legal-footer a:hover {
      color: #fff;
      text-decoration: underline;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--panel-border);
      background: rgba(15, 23, 42, 0.9);
      position: sticky;
      top: 0;
      z-index: 2;
      backdrop-filter: blur(12px);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-circle {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      display: grid;
      place-items: center;
      font-weight: 700;
      color: #0b1224;
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.1);
      overflow: hidden;
    }

    .logo-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: 50%;
    }

    .page-title {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    main {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .panel h2 {
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .subtext {
      color: var(--text-muted);
      margin: 6px 0 0;
      font-size: 14px;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      font-size: 14px;
      user-select: none;
    }

    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--panel-border);
      background: linear-gradient(135deg, var(--btn), var(--btn-hover));
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn.secondary {
      background: transparent;
      color: var(--text-main);
      border-color: #1f2a3c;
    }

    .table-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }

    .table-card {
      background: var(--card);
      border: 1px solid var(--panel-border);
      border-radius: 14px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .table-card-main {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      align-items: center;
    }

    .table-title { font-weight: 800; font-size: 18px; }
    .table-meta { color: var(--text-muted); font-size: 14px; }

    .table-seats {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .seat-pill {
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(34, 197, 94, 0.15);
      color: #a7f3d0;
      border: 1px solid rgba(34, 197, 94, 0.35);
      font-weight: 700;
    }

    .table-tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tag-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: #cbd5e1;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.08);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .tag-chip.success {
      color: #befae3;
      border-color: rgba(34, 197, 94, 0.4);
      background: rgba(34, 197, 94, 0.1);
    }

    .tournament-card {
      background: var(--card);
      border: 1px solid var(--panel-border);
      border-radius: 14px;
      padding: 16px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
    }

    .tournament-card h3 {
      margin: 0 0 4px;
    }

    .tournament-meta { color: var(--text-muted); margin: 4px 0; font-size: 14px; }

    .tournament-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }

    .tournament-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }

    .tournament-pill { padding: 8px 12px; border-radius: 999px; background: rgba(59, 130, 246, 0.12); color: #bfdbfe; border: 1px solid rgba(59, 130, 246, 0.35); font-weight: 700; letter-spacing: 0.04em; }

    .status-text { color: #86efac; font-weight: 700; letter-spacing: 0.03em; text-transform: uppercase; font-size: 12px; }

    .empty-state {
      text-align: center;
      padding: 28px 16px;
      color: var(--text-muted);
      border: 1px dashed var(--panel-border);
      border-radius: 14px;
    }

    .error {
      color: #fca5a5;
      margin-top: 12px;
      font-size: 14px;
    }

    @media (max-width: 640px) {
      .table-card-main { flex-direction: column; align-items: flex-start; }
      header { flex-direction: column; align-items: flex-start; gap: 8px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo-circle" id="navAvatar">P</div>
      <div>
        <p class="page-title">Available Tables</p>
        <p class="subtext">Pick a table created by your club owner.</p>
      </div>
    </div>
    <div class="header-actions">
      <a class="btn" id="createClubBtn" href="/create-club">Create club</a>
      <a class="btn secondary" id="dataOverviewBtn" href="/admin" style="display:none">Admin</a>
      <a class="btn secondary" id="clubManagerBtn" href="/clubs" style="display:none">Club manager</a>
      <a class="btn secondary" href="/profile">Profile</a>
      <button class="btn secondary" id="logoutBtn">Logout</button>
    </div>
  </header>

  <main>
    <div class="panel">
      <div class="panel-header">
        <div>
          <h2>Club tables</h2>
          <p class="subtext">Join a table to be redirected to the poker view.</p>
        </div>
        <div class="controls">
          <label class="checkbox-row">
            <input type="checkbox" id="hideFullTables" /> Hide full tables
          </label>
          <span class="subtext" id="liveStatus">Live updates</span>
        </div>
      </div>

      <div id="tableList" class="table-list"></div>
      <div id="errorBox" class="error" style="display:none"></div>
    </div>

    <div class="panel" style="margin-top: 16px;">
      <div class="panel-header">
        <div>
          <h2>Club tournaments</h2>
          <p class="subtext">Register for structured events. New tables open automatically as each fills.</p>
        </div>
      </div>

      <div id="tournamentList" class="table-list"></div>
      <div id="tournamentEmpty" class="empty-state" style="display:none;">No tournaments posted yet.</div>
    </div>
  </main>

  <script src="/static/custom-alert.js"></script>
  <script>
    const authInfo = JSON.parse(localStorage.getItem("pokerAuth") || "{}");
    const AUTH_KEY = "poker_token";
    const AUTH_STORAGE_KEY = "pokerAuth";
    const TOURNAMENT_STORAGE_KEY = "clubTournaments";
    const CLUB_CONTEXT_KEY = "pokerActiveClubId";
    let accessToken = localStorage.getItem(AUTH_KEY);
    let currentUserEmail = authInfo.email || "";
    let currentUserId = null;

    if (!accessToken) {
      window.location.href = "/";
    }

    const ADMIN_EMAILS = ["paddywarren99@gmail.com", "padpadpoker@gmail.com"];

    const navAvatar = document.getElementById("navAvatar");
    const clubManagerBtn = document.getElementById("clubManagerBtn");
    const dataOverviewBtn = document.getElementById("dataOverviewBtn");
    const tableList = document.getElementById("tableList");
    const hideFullCheckbox = document.getElementById("hideFullTables");
    const liveStatus = document.getElementById("liveStatus");
    const errorBox = document.getElementById("errorBox");
    const logoutBtn = document.getElementById("logoutBtn");
    const tournamentListEl = document.getElementById("tournamentList");
    const tournamentEmptyEl = document.getElementById("tournamentEmpty");
    const TABLE_REFRESH_MS = 10000;
    let tableRefreshTimer = null;
    let isTablesLoading = false;

    function restoreAuthMetadata() {
      try {
        const raw = localStorage.getItem(AUTH_STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed.email) {
          currentUserEmail = parsed.email;
        }
      } catch (err) {
        console.warn("Failed to restore auth metadata", err);
      }
    }

    async function api(path, options = {}) {
      const headers = {
        "Content-Type": "application/json",
        ...(options.headers || {}),
      };
      if (accessToken) headers["Authorization"] = `Bearer ${accessToken}`;

      const res = await fetch(path, { ...options, headers });
      if (res.status === 401) {
        localStorage.removeItem(AUTH_KEY);
        window.location.href = "/";
        return Promise.reject(new Error("Unauthorized"));
      }
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || `Error ${res.status}`);
      }
      return res.json();
    }

    async function determineClubOwnership() {
      if (clubManagerBtn) clubManagerBtn.style.display = "none";
      if (dataOverviewBtn) dataOverviewBtn.style.display = "none";

      if (!currentUserEmail) restoreAuthMetadata();
      if (!currentUserEmail) return;

      const normalizedEmail = currentUserEmail.toLowerCase();
      if (
        dataOverviewBtn &&
        ADMIN_EMAILS.some((email) => email.toLowerCase() === normalizedEmail)
      ) {
        dataOverviewBtn.style.display = "inline-flex";
      }

      try {
        const me = await api(`/me?email=${encodeURIComponent(currentUserEmail)}`, {
          method: "GET",
        });
        currentUserId = me?.id ?? null;
        if (!currentUserId) return;

        const clubs = await api("/clubs/", { method: "GET" });
        const ownsClub = Array.isArray(clubs)
          ? clubs.some((club) => club.owner_id === currentUserId)
          : false;
        clubManagerBtn.style.display = ownsClub ? "inline-flex" : "none";
      } catch (err) {
        console.warn("Failed to determine club ownership", err);
      }
    }

    async function ensureClubMembership() {
      try {
        const clubs = await api("/clubs/", { method: "GET" });
        if (!Array.isArray(clubs) || clubs.length === 0) {
          window.location.href = "/create-club";
          return false;
        }
        return true;
      } catch (err) {
        errorBox.textContent = err.message || "Unable to load club info";
        errorBox.style.display = "block";
        return false;
      }
    }

    function renderAvatar(targetEl, url, fallbackText) {
      if (!targetEl) return;

      targetEl.innerHTML = "";
      if (url) {
        const img = document.createElement("img");
        img.src = url;
        img.alt = "Profile picture";
        img.onerror = () => {
          targetEl.textContent = fallbackText;
        };
        targetEl.appendChild(img);
      } else {
        targetEl.textContent = fallbackText;
      }
    }

    async function loadProfileAvatar() {
      if (!currentUserEmail) restoreAuthMetadata();
      if (!currentUserEmail) return;

      try {
        const data = await api(`/me/profile?email=${encodeURIComponent(currentUserEmail)}`);
        const fallbackInitial = data.username?.[0]?.toUpperCase() || currentUserEmail?.[0]?.toUpperCase() || "P";
        renderAvatar(navAvatar, data.profile_picture_url, fallbackInitial);
      } catch (error) {
        console.warn("Failed to load profile avatar", error);
        const fallbackInitial = currentUserEmail?.[0]?.toUpperCase() || "P";
        renderAvatar(navAvatar, null, fallbackInitial);
      }
    }

    function loadStoredTournaments() {
      try {
        const raw = localStorage.getItem(TOURNAMENT_STORAGE_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch (err) {
        console.warn("Failed to read tournaments", err);
        return [];
      }
    }

    function saveStoredTournaments(list) {
      try {
        localStorage.setItem(TOURNAMENT_STORAGE_KEY, JSON.stringify(list));
      } catch (err) {
        console.warn("Failed to save tournaments", err);
      }
    }

    function calculateActiveTables(playersCount, tableSize) {
      const seats = Math.max(Number(tableSize) || 1, 1);
      const players = Math.max(playersCount || 0, 0);
      return Math.max(1, Math.ceil(players / seats) || 1);
    }

    function formatCurrency(value) {
      const num = Number(value);
      if (!Number.isFinite(num)) return "Custom";
      return `$${num.toFixed(2)}`;
    }

    function renderTournaments(tournaments) {
      if (!tournamentListEl || !tournamentEmptyEl) return;
      tournamentListEl.innerHTML = "";
      tournamentEmptyEl.style.display = "none";
      if (!Array.isArray(tournaments) || tournaments.length === 0) {
        tournamentEmptyEl.style.display = "block";
        return;
      }

      tournaments.forEach((tournament) => {
        const players = Array.isArray(tournament.players) ? tournament.players : [];
        const playersCount = players.length;
        const tableSize = tournament.tableSize || 8;
        const activeTables = tournament.activeTables || calculateActiveTables(playersCount, tableSize);
        const playerId = currentUserEmail || "guest-player";
        const alreadyJoined = players.some((p) => p.email === playerId);

        const card = document.createElement("div");
        card.className = "tournament-card";

        const body = document.createElement("div");
        const title = document.createElement("h3");
        title.textContent = tournament.name || "Club tournament";
        body.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "tournament-meta";
        const buyInLabel = formatCurrency(tournament.buyIn);
        const feeLabel = tournament.fee ? ` + ${formatCurrency(tournament.fee)} fee` : "";
        const stackLabel = tournament.startingStack ? `${tournament.startingStack} chips` : "Custom stack";
        meta.textContent = `${buyInLabel}${feeLabel} • ${stackLabel} • ${tournament.levelDuration || 10} min levels`;
        body.appendChild(meta);

        const regMeta = document.createElement("div");
        regMeta.className = "tournament-meta";
        regMeta.textContent = `Late reg: ${tournament.lateRegMinutes || 0} mins • Table size: ${tableSize} • Auto tables: ${activeTables}`;
        body.appendChild(regMeta);

        const tags = document.createElement("div");
        tags.className = "tournament-tags";

        const statusTag = document.createElement("span");
        statusTag.className = "tag-chip success";
        statusTag.textContent = tournament.status ? tournament.status.toUpperCase() : "REGISTERING";
        tags.appendChild(statusTag);

        const structureTag = document.createElement("span");
        structureTag.className = "tag-chip";
        structureTag.textContent = `${tableSize}-max tables`;
        tags.appendChild(structureTag);

        const reentryTag = document.createElement("span");
        reentryTag.className = "tag-chip";
        reentryTag.textContent = tournament.allowReEntry ? "Re-entry allowed" : "Freezeout";
        tags.appendChild(reentryTag);

        const blindTag = document.createElement("span");
        blindTag.className = "tag-chip";
        blindTag.textContent = tournament.blindPacing ? `${tournament.blindPacing} structure` : "ClubGG-inspired";
        tags.appendChild(blindTag);

        body.appendChild(tags);

        const actions = document.createElement("div");
        actions.className = "tournament-actions";

        const statusText = document.createElement("div");
        statusText.className = "status-text";
        statusText.textContent = tournament.status ? tournament.status.toUpperCase() : "REGISTERING";
        actions.appendChild(statusText);

        const tablesPill = document.createElement("div");
        tablesPill.className = "tournament-pill";
        const tableWord = activeTables === 1 ? "table" : "tables";
        tablesPill.textContent = `${playersCount} joined • ${activeTables} ${tableWord}`;
        actions.appendChild(tablesPill);

        const joinBtn = document.createElement("button");
        joinBtn.className = alreadyJoined ? "btn secondary" : "btn";
        joinBtn.textContent = alreadyJoined ? "Joined" : "Join tournament";
        joinBtn.disabled = alreadyJoined;
        joinBtn.onclick = () => joinTournament(tournament.id);
        actions.appendChild(joinBtn);

        card.appendChild(body);
        card.appendChild(actions);
        tournamentListEl.appendChild(card);
      });
    }

    function joinTournament(tournamentId) {
      if (!tournamentId) return;
      if (!currentUserEmail) restoreAuthMetadata();
      const playerEmail = currentUserEmail || "guest-player";

      const tournaments = loadStoredTournaments();
      const index = tournaments.findIndex((t) => t.id === tournamentId);
      if (index === -1) return;

      const tournament = tournaments[index];
      tournament.players = Array.isArray(tournament.players) ? tournament.players : [];
      const alreadyJoined = tournament.players.some((p) => p.email === playerEmail);
      if (!alreadyJoined) {
        tournament.players.push({ email: playerEmail, joinedAt: new Date().toISOString() });
      }
      tournament.activeTables = calculateActiveTables(tournament.players.length, tournament.tableSize || 8);
      tournaments[index] = tournament;
      saveStoredTournaments(tournaments);
      renderTournaments(tournaments);
      alert(`You're registered for ${tournament.name || "the tournament"}. Tables will auto-open as seats fill.`);
    }

    function renderTables(tables) {
      tableList.innerHTML = "";
      if (!tables.length) {
        tableList.innerHTML = '<div class="empty-state">No tables open right now, but you can open them within the club management area.</div>';
        return;
      }

      tables.forEach((tbl) => {
        const card = document.createElement("div");
        card.className = "table-card";

        const title = document.createElement("div");
        title.className = "table-title";
        title.textContent = `Table #${tbl.id}`;

        const meta = document.createElement("div");
        meta.className = "table-meta";
        meta.textContent = `Blinds ${tbl.small_blind}/${tbl.big_blind} • Club ${tbl.club_id}`;

        const left = document.createElement("div");
        left.appendChild(title);
        left.appendChild(meta);

        const seats = document.createElement("div");
        seats.className = "seat-pill";
        const seatsLabel = (tbl.playersCount ?? null) !== null
          ? `${tbl.playersCount}/${tbl.max_seats}`
          : `${tbl.max_seats} seats`;
        seats.textContent = seatsLabel;

        const joinBtn = document.createElement("button");
        joinBtn.className = "btn";
        joinBtn.textContent = "Join";
        joinBtn.onclick = () => {
          window.location.href = `/poker?tableId=${tbl.id}`;
        };

        const seatWrap = document.createElement("div");
        seatWrap.className = "table-seats";
        seatWrap.appendChild(seats);
        seatWrap.appendChild(joinBtn);

        const mainRow = document.createElement("div");
        mainRow.className = "table-card-main";
        mainRow.appendChild(left);
        mainRow.appendChild(seatWrap);

        const tags = document.createElement("div");
        tags.className = "table-tags";
        const statusTag = document.createElement("span");
        statusTag.className = "tag-chip success";
        statusTag.textContent = tbl.status ? tbl.status.toUpperCase() : "ACTIVE";
        const seatsTag = document.createElement("span");
        seatsTag.className = "tag-chip";
        seatsTag.textContent = `${tbl.max_seats}-max table`;
        tags.appendChild(statusTag);
        tags.appendChild(seatsTag);

        card.appendChild(mainRow);
        card.appendChild(tags);
        tableList.appendChild(card);
      });
    }

    async function loadTables() {
      if (isTablesLoading) return;
      isTablesLoading = true;
      tableList.innerHTML = '<div class="empty-state">Loading tables...</div>';
      errorBox.style.display = "none";
      try {
        const tables = await api("/tables/", { method: "GET" });
        const hideFull = hideFullCheckbox?.checked;
        const enriched = [];

        for (const tbl of tables) {
          let playersCount = null;
          try {
            const state = await api(`/tables/${tbl.id}`, { method: "GET" });
            if (Array.isArray(state.players)) playersCount = state.players.length;
          } catch (err) {
            console.warn("Failed to load table state", err);
          }

          if (hideFull && playersCount !== null && playersCount >= tbl.max_seats) {
            continue;
          }

          enriched.push({ ...tbl, playersCount });
        }

        renderTables(enriched);
      } catch (err) {
        errorBox.textContent = err.message || "Unable to load tables";
        errorBox.style.display = "block";
        tableList.innerHTML = "";
      } finally {
        isTablesLoading = false;
      }
    }

    function startAutoRefresh() {
      if (tableRefreshTimer) clearInterval(tableRefreshTimer);
      tableRefreshTimer = setInterval(() => {
        if (!document.hidden) {
          loadTables();
          renderTournaments(loadStoredTournaments());
        }
      }, TABLE_REFRESH_MS);

      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
          loadTables();
          renderTournaments(loadStoredTournaments());
        }
      });

      if (liveStatus) {
        liveStatus.textContent = "Live updates every 10 seconds";
      }
    }
    hideFullCheckbox.addEventListener("change", loadTables);

    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem(AUTH_KEY);
      localStorage.removeItem("pokerAuth");
      window.location.href = "/";
    });

    restoreAuthMetadata();
    loadProfileAvatar();
    determineClubOwnership();
    ensureClubMembership().then((ok) => {
      if (ok) {
        loadTables();
        renderTournaments(loadStoredTournaments());
        startAutoRefresh();
      }
    });
  </script>

<div class="legal-footer">
  Play-money entertainment only. Read our
  <a href="/legal.html" target="_blank" rel="noopener">legal disclaimer</a>
  and
  <a href="/terms.html" target="_blank" rel="noopener">terms of service</a>.
</div>
</body>
</html>
