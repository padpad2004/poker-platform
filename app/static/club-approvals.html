<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Approve Club Members | Poker Platform</title>
  <style>
    :root {
      --bg: #0b1222;
      --panel: #0f172a;
      --panel-border: #1f2937;
      --accent: #22c55e;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #dc2626;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 24px;
      background: radial-gradient(circle at top, #111827 0, #0b1222 60%);
      color: var(--text-main);
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .title {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 16px 36px rgba(0,0,0,0.45);
      max-width: 1100px;
      margin: 0 auto;
    }

    .muted { color: var(--text-muted); }

    .list { display: grid; gap: 12px; margin-top: 12px; }

    .card {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--panel-border);
      border-radius: 10px;
      padding: 12px;
      display: grid;
      gap: 6px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .badge { background: rgba(255,255,255,0.08); padding: 6px 10px; border-radius: 999px; font-size: 12px; color: var(--text-muted); }

    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    button, .button-link {
      padding: 8px 12px;
      border-radius: 10px;
      border: none;
      background: #2563eb;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button:hover:not(:disabled), .button-link:hover { background: #1d4ed8; }
    button:disabled { background: #374151; cursor: not-allowed; }
    .btn-danger { background: var(--danger); }
    .btn-danger:hover:not(:disabled) { background: #b91c1c; }
    .ghost { background: transparent; color: var(--text-main); border: 1px solid #1f2937; }

    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 999px; background: rgba(34, 197, 94, 0.14); color: #bbf7d0; font-weight: 700; font-size: 12px; }

    .feedback { margin-top: 10px; font-size: 13px; color: var(--text-muted); }

    .legal-footer { position: fixed; right: 16px; bottom: 16px; font-size: 11px; color: var(--text-muted); z-index: 10; }
    .legal-footer a { color: inherit; text-decoration: none; }
    .legal-footer a + a { margin-left: 8px; }
    .legal-footer a:hover { color: #fff; text-decoration: underline; }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">Member Approvals</div>
      <div class="muted" id="pageHint">Load a club to review requests.</div>
    </div>
    <div class="actions">
      <a class="button-link ghost" id="backLink" href="/club-management">Back to Club Management</a>
      <div class="pill" id="statusPill">Pending requests</div>
    </div>
  </header>

  <div class="panel">
    <div style="display:flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
      <div>
        <h2 style="margin: 0;" id="clubTitle">Loading club...</h2>
        <div class="muted" id="clubMeta">Fetching details…</div>
      </div>
      <div class="badge" id="clubStatus">--</div>
    </div>

    <div class="feedback" id="feedback"></div>
    <div id="emptyState" class="muted" style="display:none; margin-top: 12px;">No pending requests right now.</div>
    <div id="pendingList" class="list"></div>
  </div>

  <div class="legal-footer">
    <a href="/terms.html">Terms</a>
    <a href="/legal.html">Legal</a>
  </div>

  <script>
    const AUTH_KEY = "pokerAuth";
    const pendingList = document.getElementById("pendingList");
    const emptyState = document.getElementById("emptyState");
    const feedback = document.getElementById("feedback");
    const clubTitle = document.getElementById("clubTitle");
    const clubMeta = document.getElementById("clubMeta");
    const clubStatus = document.getElementById("clubStatus");
    const statusPill = document.getElementById("statusPill");
    const pageHint = document.getElementById("pageHint");
    const backLink = document.getElementById("backLink");

    let accessToken = "";
    let currentEmail = "";
    let clubId = null;

    function setFeedback(message, isError = false) {
      feedback.textContent = message || "";
      feedback.style.color = isError ? "#f87171" : "var(--text-muted)";
    }

    function restoreAuth() {
      try {
        const raw = localStorage.getItem(AUTH_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (parsed.token && parsed.email) {
          accessToken = parsed.token;
          currentEmail = parsed.email;
        }
      } catch (err) {
        console.warn("Failed to restore auth", err);
      }
    }

    async function api(path, options = {}) {
      const headers = options.headers || {};
      if (accessToken) headers["Authorization"] = `Bearer ${accessToken}`;
      const opts = { ...options, headers };
      const res = await fetch(path, opts);
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || `Error ${res.status}`);
      }
      const contentType = res.headers.get("content-type") || "";
      if (contentType.includes("application/json")) return res.json();
      return res.text();
    }

    function parseClubId() {
      const params = new URLSearchParams(window.location.search);
      const raw = params.get("club_id");
      const parsed = Number(raw);
      return Number.isFinite(parsed) ? parsed : null;
    }

    function ensureClubId() {
      clubId = parseClubId();
      if (!clubId) {
        setFeedback("No club selected. Go back and pick a club first.", true);
        throw new Error("Missing club id");
      }
      backLink.href = `/club-management.html?club_id=${clubId}`;
    }

    function renderPending(pending) {
      pendingList.innerHTML = "";
      if (!pending.length) {
        emptyState.style.display = "block";
        statusPill.textContent = "All clear";
        pendingList.style.display = "none";
        return;
      }
      emptyState.style.display = "none";
      pendingList.style.display = "grid";
      statusPill.textContent = `${pending.length} waiting`;

      pending.forEach((member) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="card-header">
            <div>
              <strong>${member.user_email}</strong>
              <div class="muted">Requested: ${new Date(member.created_at).toLocaleString()}</div>
            </div>
            <span class="badge">User ID ${member.user_id}</span>
          </div>
          <div class="actions">
            <button data-action="approve" data-user-id="${member.user_id}">Approve</button>
            <button class="btn-danger" data-action="deny" data-user-id="${member.user_id}">Deny</button>
          </div>
        `;
        pendingList.appendChild(card);
      });
    }

    async function loadClub() {
      try {
        const detail = await api(`/clubs/${clubId}`);
        clubTitle.textContent = detail.name;
        clubMeta.textContent = `Club #${detail.id} • Owner ${detail.owner_id}`;
        clubStatus.textContent = detail.status;
      } catch (err) {
        console.error(err);
        setFeedback(err.message || "Failed to load club", true);
        throw err;
      }
    }

    async function loadPending() {
      try {
        setFeedback("Loading pending requests…");
        const pending = await api(`/clubs/${clubId}/pending-members`);
        renderPending(pending || []);
        setFeedback(pending.length ? "Review and approve members to let them in." : "No pending members right now.");
      } catch (err) {
        console.error(err);
        setFeedback(err.message || "Failed to load pending members", true);
      }
    }

    async function handleApprove(userId) {
      try {
        setFeedback("Approving member...");
        await api(`/clubs/${clubId}/pending-members/${userId}/approve`, { method: "POST" });
        await loadPending();
        setFeedback("Member approved. They can now access the club.");
      } catch (err) {
        console.error(err);
        setFeedback(err.message || "Failed to approve member", true);
      }
    }

    async function handleDeny(userId) {
      const confirmed = window.confirm("Deny this membership request?");
      if (!confirmed) return;
      try {
        setFeedback("Denying member...");
        await api(`/clubs/${clubId}/pending-members/${userId}`, { method: "DELETE" });
        await loadPending();
        setFeedback("Request denied and removed.");
      } catch (err) {
        console.error(err);
        setFeedback(err.message || "Failed to deny member", true);
      }
    }

    pendingList.addEventListener("click", (event) => {
      const target = event.target;
      const userId = target.dataset.userId;
      if (!userId) return;
      if (target.dataset.action === "approve") handleApprove(userId);
      if (target.dataset.action === "deny") handleDeny(userId);
    });

    async function init() {
      restoreAuth();
      ensureClubId();
      if (!accessToken) {
        alert("Please login first.");
        window.location.href = "/";
        return;
      }
      try {
        await loadClub();
        await loadPending();
      } catch (err) {
        pageHint.textContent = "Only club owners can review requests.";
      }
    }

    init();
  </script>
</body>
</html>
