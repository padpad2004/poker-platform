<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PadPad Poker | Profile</title>
  <style>
    :root {
      --bg: #0b1224;
      --panel: #0f172a;
      --panel-border: #1f2937;
      --accent: #22c55e;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --btn: #2563eb;
      --btn-hover: #1d4ed8;
      --danger: #dc2626;
      --card: #11192e;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .legal-footer {
      position: fixed;
      right: 16px;
      bottom: 16px;
      font-size: 11px;
      color: var(--text-muted, #9ca3af);
      z-index: 10;
    }

  .legal-footer a {
    color: inherit;
    text-decoration: none;
  }

  .legal-footer a + a {
    margin-left: 8px;
  }

  .legal-footer a:hover {
    color: #fff;
    text-decoration: underline;
  }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--panel-border);
      background: rgba(15, 23, 42, 0.9);
      position: sticky;
      top: 0;
      z-index: 2;
      backdrop-filter: blur(12px);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-circle {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      display: grid;
      place-items: center;
      font-weight: 700;
      color: #0b1224;
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.1);
      overflow: hidden;
    }

    .logo-circle img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: 50%;
    }

    .page-title {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .subtext { color: var(--text-muted); margin: 6px 0 0; font-size: 14px; }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; }

    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--panel-border);
      background: linear-gradient(135deg, var(--btn), var(--btn-hover));
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:active { transform: translateY(1px); }

    .btn.secondary { background: transparent; color: var(--text-main); border-color: #1f2a3c; }
    .btn.danger { background: var(--danger); border-color: var(--danger); }

    main {
      max-width: 1080px;
      margin: 0 auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
    }

    .panel h2 { margin: 0 0 6px; }

    .profile-header { display: flex; align-items: center; gap: 16px; }

    .avatar {
      width: 84px;
      height: 84px;
      border-radius: 16px;
      background: radial-gradient(circle, #11192e, #0b1224);
      border: 1px solid var(--panel-border);
      overflow: hidden;
      display: grid;
      place-items: center;
      font-size: 30px;
      color: #a3bffa;
    }

    .avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }

    .preset-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(86px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }

    .preset-option {
      height: 86px;
      border-radius: 14px;
      border: 1px solid var(--panel-border);
      background-size: cover;
      background-position: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      transition: transform 0.12s ease, border-color 0.12s ease;
    }

    .preset-option:hover {
      transform: translateY(-2px);
      border-color: var(--accent);
    }

    .preset-option.selected::after {
      content: "Selected";
      position: absolute;
      bottom: 6px;
      right: 8px;
      background: rgba(15, 23, 42, 0.8);
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      color: var(--accent);
      border: 1px solid rgba(34, 197, 94, 0.4);
    }

    .muted { color: var(--text-muted); }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.14);
      color: #befae3;
      border: 1px solid rgba(34, 197, 94, 0.4);
      font-weight: 700;
      margin-top: 6px;
    }

    .club-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .divider { border-top: 1px solid var(--panel-border); margin: 12px 0; }

    form label { display: block; font-weight: 600; margin-bottom: 6px; color: var(--text-main); }
    form input[type="url"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #0b1224;
      color: var(--text-main);
      margin-bottom: 10px;
    }

    .history-list { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }

    .history-card {
      background: var(--card);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .result { font-weight: 700; }
    .win { color: #34d399; }
    .loss { color: #fca5a5; }

    .empty-state { text-align: center; color: var(--text-muted); padding: 14px 0; }

    @media (max-width: 640px) {
      header { flex-direction: column; align-items: flex-start; gap: 8px; }
      .profile-header { flex-direction: column; align-items: flex-start; }
      .actions { width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo-circle" id="navAvatar">P</div>
      <div>
        <p class="page-title">Player profile</p>
        <p class="subtext">Review your bankroll, club, and recent hands.</p>
      </div>
    </div>
    <div class="actions">
      <a class="btn secondary" href="/available-tables">â¬… Back to tables</a>
      <button class="btn secondary" id="downloadDataBtn">Download my data</button>
      <button class="btn secondary" id="logoutBtn">Logout</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <div class="panel" id="profilePanel">
        <h2>Profile</h2>
        <div class="profile-header">
          <div class="avatar" id="avatarBox">ðŸ‚¡</div>
          <div>
            <div id="username" style="font-size: 18px; font-weight: 800;">-</div>
            <div id="email" class="muted" style="margin-top: 4px;">-</div>
            <div id="universityLabel" class="muted" style="margin-top: 4px; display:none;"></div>
            <div id="club" class="pill" style="display:none">Club</div>
            <div id="clubActions" class="club-actions" style="display:none">
              <button class="btn danger" id="leaveClubBtn" type="button">Leave club</button>
              <div id="clubMessage" class="muted"></div>
            </div>
          </div>
        </div>
        <div class="divider"></div>
        <p class="muted" style="margin:0">Wallet balance</p>
        <div style="font-size: 26px; font-weight: 800; margin-top: 4px;" id="balance">-</div>
        <div id="downloadMessage" class="muted" style="margin-top: 8px;"></div>

        <div class="divider" style="margin: 16px 0;"></div>

        <form id="universityForm">
          <label for="universitySelect">University</label>
          <select id="universitySelect" name="universitySelect">
            <option value="">Select your university</option>
          </select>
          <button type="submit" class="btn" style="margin-top: 10px;">Save university</button>
          <div id="universityMessage" class="muted" style="margin-top: 6px;"></div>
        </form>
      </div>

      <div class="panel">
        <h2>Profile picture</h2>
        <p class="muted">Paste a link to a square image to update your avatar.</p>
        <form id="avatarForm">
          <label for="avatarUrl">Image URL</label>
          <input type="url" id="avatarUrl" name="avatarUrl" placeholder="https://..." required />
          <button type="submit" class="btn">Save picture</button>
        </form>
        <p class="muted" style="margin: 12px 0 6px;">Or pick one of our ready-made avatars:</p>
        <div id="presetGrid" class="preset-grid"></div>
        <div id="avatarMessage" class="muted"></div>
      </div>
    </div>

    <div class="panel">
      <div style="display:flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
        <div>
          <h2 style="margin:0">Hand history</h2>
          <p class="muted" style="margin:4px 0 0;">Most recent 20 hands you've played.</p>
        </div>
        <button class="btn secondary" id="refreshBtn">Refresh</button>
      </div>
      <div id="history" class="history-list"></div>
    </div>

    <div class="panel">
      <div style="display:flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
        <div>
          <h2 style="margin:0">Game history</h2>
          <p class="muted" style="margin:4px 0 0;">24-hour table reports with buy-ins and results.</p>
        </div>
        <button class="btn secondary" id="gameHistoryBtn">Game history</button>
      </div>
      <div id="gameHistory" class="history-list"></div>
    </div>
  </main>

  <script>
    const AUTH_KEY = "poker_token";
    const authInfo = JSON.parse(localStorage.getItem("pokerAuth") || "{}");
    const accessToken = localStorage.getItem(AUTH_KEY);

    if (!accessToken || !authInfo.email) {
      window.location.href = "/";
    }

    const logoutBtn = document.getElementById("logoutBtn");
    const avatarBox = document.getElementById("avatarBox");
    const navAvatar = document.getElementById("navAvatar");
    const usernameEl = document.getElementById("username");
    const emailEl = document.getElementById("email");
    const universityLabel = document.getElementById("universityLabel");
    const clubEl = document.getElementById("club");
    const clubActions = document.getElementById("clubActions");
    const leaveClubBtn = document.getElementById("leaveClubBtn");
    const clubMessage = document.getElementById("clubMessage");
    const balanceEl = document.getElementById("balance");
    const avatarForm = document.getElementById("avatarForm");
    const avatarUrlInput = document.getElementById("avatarUrl");
    const avatarMessage = document.getElementById("avatarMessage");
    const refreshBtn = document.getElementById("refreshBtn");
    const historyList = document.getElementById("history");
    const gameHistoryBtn = document.getElementById("gameHistoryBtn");
    const gameHistoryList = document.getElementById("gameHistory");
    const presetGrid = document.getElementById("presetGrid");
    const downloadDataBtn = document.getElementById("downloadDataBtn");
    const downloadMessage = document.getElementById("downloadMessage");
    const universityForm = document.getElementById("universityForm");
    const universitySelect = document.getElementById("universitySelect");
    const universityMessage = document.getElementById("universityMessage");

    const presetAvatars = [
      { url: "/static/avatars/avatar-club.svg", label: "Club" },
      { url: "/static/avatars/avatar-spade.svg", label: "Spade" },
      { url: "/static/avatars/avatar-heart.svg", label: "Heart" },
      { url: "/static/avatars/avatar-diamond.svg", label: "Diamond" },
      { url: "/static/avatars/avatar-chips.svg", label: "Chips" },
    ];

    const UK_UNIVERSITIES = [
      "AECC University College",
      "Abertay University",
      "Aberystwyth University",
      "Anglia Ruskin University",
      "Arden University",
      "Arts University Bournemouth",
      "Aston University",
      "Bangor University",
      "Bath Spa University",
      "Birkbeck, University of London",
      "Birmingham City University",
      "Bournemouth University",
      "BPP University",
      "Brunel University London",
      "Buckinghamshire New University",
      "Canterbury Christ Church University",
      "Cardiff Metropolitan University",
      "Cardiff University",
      "City, University of London",
      "Coventry University",
      "Cranfield University",
      "Durham University",
      "Edge Hill University",
      "Edinburgh Napier University",
      "Falmouth University",
      "Glasgow Caledonian University",
      "Guildhall School of Music and Drama",
      "Harper Adams University",
      "Hartpury University",
      "Heriot-Watt University",
      "Imperial College London",
      "Keele University",
      "King's College London",
      "Kingston University",
      "Lancaster University",
      "Leeds Arts University",
      "Leeds Beckett University",
      "Leeds Conservatoire",
      "Leeds Trinity University",
      "Liverpool Hope University",
      "Liverpool John Moores University",
      "London Business School",
      "London Metropolitan University",
      "London School of Economics and Political Science",
      "London South Bank University",
      "Loughborough University",
      "Manchester Metropolitan University",
      "Middlesex University",
      "Newcastle University",
      "Newman University, Birmingham",
      "Northumbria University",
      "Norwich University of the Arts",
      "Nottingham Trent University",
      "The Open University",
      "Oxford Brookes University",
      "Plymouth Marjon University",
      "Queen Margaret University",
      "Queen Mary University of London",
      "Queen's University Belfast",
      "Ravensbourne University London",
      "Regent's University London",
      "Richmond American University London",
      "Robert Gordon University",
      "Royal Academy of Music",
      "Royal Agricultural University",
      "Royal Central School of Speech and Drama",
      "Royal College of Art",
      "Royal College of Music",
      "Royal Conservatoire of Scotland",
      "Royal Holloway, University of London",
      "Royal Northern College of Music",
      "Royal Veterinary College",
      "Sheffield Hallam University",
      "Solent University",
      "St George's, University of London",
      "St Mary's University, Twickenham",
      "Staffordshire University",
      "Swansea University",
      "Teesside University",
      "The Courtauld Institute of Art",
      "The University of Law",
      "Trinity Laban Conservatoire of Music and Dance",
      "Ulster University",
      "University College Birmingham",
      "University College London",
      "University for the Creative Arts",
      "University of Aberdeen",
      "University of Bath",
      "University of Bedfordshire",
      "University of Birmingham",
      "University of Bolton",
      "University of Bradford",
      "University of Brighton",
      "University of Bristol",
      "University of Buckingham",
      "University of Cambridge",
      "University of Central Lancashire",
      "University of Chester",
      "University of Chichester",
      "University of Cumbria",
      "University of Derby",
      "University of Dundee",
      "University of East Anglia",
      "University of East London",
      "University of Edinburgh",
      "University of Essex",
      "University of Exeter",
      "University of Glasgow",
      "University of Gloucestershire",
      "University of Greenwich",
      "University of Hertfordshire",
      "University of the Highlands and Islands",
      "University of Huddersfield",
      "University of Hull",
      "University of Kent",
      "University of Leeds",
      "University of Leicester",
      "University of Lincoln",
      "University of Liverpool",
      "University of London",
      "University of Manchester",
      "University of Northampton",
      "University of Northumbria at Newcastle",
      "University of Nottingham",
      "University of Oxford",
      "University of Plymouth",
      "University of Portsmouth",
      "University of Reading",
      "University of Roehampton",
      "University of Salford",
      "University of Sheffield",
      "University of South Wales",
      "University of Southampton",
      "University of St Andrews",
      "University of Stirling",
      "University of Strathclyde",
      "University of Suffolk",
      "University of Sunderland",
      "University of Surrey",
      "University of Sussex",
      "University of the Arts London",
      "University of the West of England",
      "University of the West of Scotland",
      "University of Wales Trinity Saint David",
      "University of Warwick",
      "University of Westminster",
      "University of West London",
      "University of Winchester",
      "University of Wolverhampton",
      "University of Worcester",
      "University of York",
      "Wrexham University",
      "York St John University",
    ];

    async function api(path, options = {}) {
      const headers = {
        "Content-Type": "application/json",
        ...(options.headers || {}),
      };
      if (accessToken) headers["Authorization"] = `Bearer ${accessToken}`;
      const res = await fetch(path, { ...options, headers });
      if (res.status === 401) {
        localStorage.removeItem(AUTH_KEY);
        localStorage.removeItem("pokerAuth");
        window.location.href = "/";
        return Promise.reject(new Error("Unauthorized"));
      }
      if (!res.ok) {
        const text = await res.text();
        throw new Error(text || `Error ${res.status}`);
      }
      const contentType = res.headers.get("content-type") || "";
      if (res.status === 204 || contentType === "") return null;
      if (contentType.includes("application/json")) return res.json();
      return res.text();
    }

    function renderAvatar(targetEl, url, fallbackText) {
      if (!targetEl) return;

      targetEl.innerHTML = "";
      if (url) {
        const img = document.createElement("img");
        img.src = url;
        img.alt = "Profile picture";
        img.onerror = () => {
          targetEl.textContent = fallbackText;
        };
        targetEl.appendChild(img);
      } else {
        targetEl.textContent = fallbackText;
      }
    }

    function renderHistory(items) {
      historyList.innerHTML = "";
      if (!items.length) {
        historyList.innerHTML = '<div class="empty-state">No hands recorded yet.</div>';
        return;
      }

      items.forEach((hand) => {
        const card = document.createElement("div");
        card.className = "history-card";

        const left = document.createElement("div");
        left.innerHTML = `<div style="font-weight:700">${hand.table_name}</div><div class="muted">${new Date(hand.created_at).toLocaleString()}</div>`;

        const right = document.createElement("div");
        right.style.textAlign = "right";
        const net = hand.net_change;
        const result = document.createElement("div");
        result.className = `result ${net >= 0 ? "win" : "loss"}`;
        const sign = net >= 0 ? "+" : "";
        result.textContent = `${hand.result} (${sign}${net})`;
        const summary = document.createElement("div");
        summary.className = "muted";
        summary.textContent = hand.summary || "No description";
        right.appendChild(result);
        right.appendChild(summary);

        card.appendChild(left);
        card.appendChild(right);
        historyList.appendChild(card);
      });
    }

    function renderGameHistory(items) {
      gameHistoryList.innerHTML = "";
      if (!items.length) {
        gameHistoryList.innerHTML = '<div class="empty-state">No game reports yet.</div>';
        return;
      }

      items.forEach((entry) => {
        const card = document.createElement("div");
        card.className = "history-card";

        const left = document.createElement("div");
        left.innerHTML = `<div style="font-weight:700">Table #${entry.table_id}</div><div class=\"muted\">${new Date(entry.generated_at).toLocaleString()}</div>`;

        const right = document.createElement("div");
        right.style.textAlign = "right";
        const buyIn = document.createElement("div");
        buyIn.className = "muted";
        buyIn.textContent = `Buy-in: ${entry.buy_in}`;
        const profit = document.createElement("div");
        profit.className = `result ${entry.profit_loss >= 0 ? "win" : "loss"}`;
        const sign = entry.profit_loss >= 0 ? "+" : "";
        profit.textContent = `${sign}${entry.profit_loss}`;
        right.appendChild(buyIn);
        right.appendChild(profit);

        card.appendChild(left);
        card.appendChild(right);
        gameHistoryList.appendChild(card);
      });
    }

    function renderPresetOptions(activeUrl = "") {
      if (!presetGrid) return;
      presetGrid.innerHTML = "";

      presetAvatars.forEach((item) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = `preset-option${activeUrl === item.url ? " selected" : ""}`;
        btn.style.backgroundImage = `url(${item.url})`;
        btn.title = `${item.label} avatar`;
        btn.addEventListener("click", () => {
          avatarMessage.textContent = "";
          avatarUrlInput.value = item.url;
          saveAvatar(item.url, `${item.label} avatar selected.`);
        });
        presetGrid.appendChild(btn);
      });
    }

    function renderUniversityOptions(activeUniversity = "") {
      if (!universitySelect) return;
      universitySelect.innerHTML = '<option value="">Select your university</option>';
      UK_UNIVERSITIES.forEach((name) => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        if (name === activeUniversity) option.selected = true;
        universitySelect.appendChild(option);
      });
    }

    async function saveUniversity(university) {
      try {
        const payload = { university: university || null };
        await api(`/me/university?email=${encodeURIComponent(authInfo.email)}`, {
          method: "POST",
          body: JSON.stringify(payload),
        });
        universityMessage.textContent = university
          ? "University saved."
          : "University cleared.";
        await loadProfile();
      } catch (error) {
        universityMessage.textContent = error.message || "Unable to save university.";
      }
    }

    async function saveAvatar(url, successText = "Profile picture updated.") {
      try {
        const payload = { profile_picture_url: (url || "").trim() };
        await api(`/me/profile-picture?email=${encodeURIComponent(authInfo.email)}`, {
          method: "POST",
          body: JSON.stringify(payload),
        });
        avatarMessage.textContent = successText;
        await loadProfile();
      } catch (error) {
        avatarMessage.textContent = error.message || "Unable to save picture.";
      }
    }

    async function leaveClub(clubId) {
      if (!clubId || !leaveClubBtn) return;
      clubMessage.textContent = "";
      leaveClubBtn.disabled = true;
      const originalText = leaveClubBtn.textContent;
      leaveClubBtn.textContent = "Leaving...";
      try {
        await api(`/clubs/${clubId}/leave`, { method: "POST" });
        clubMessage.textContent = "You left the club.";
        await loadProfile();
      } catch (error) {
        clubMessage.textContent = error.message || "Unable to leave club.";
      } finally {
        leaveClubBtn.textContent = originalText;
        leaveClubBtn.disabled = false;
      }
    }

    async function loadProfile() {
      try {
        const data = await api(`/me/profile?email=${encodeURIComponent(authInfo.email)}`);
        usernameEl.textContent = data.username;
        emailEl.textContent = data.email;
        balanceEl.textContent = `${data.balance} chips`;
        avatarUrlInput.value = data.profile_picture_url || "";
        const fallbackInitial = data.username?.[0]?.toUpperCase() || "ðŸ‚¡";
        renderAvatar(avatarBox, data.profile_picture_url, fallbackInitial);
        renderAvatar(navAvatar, data.profile_picture_url, fallbackInitial || "P");
        renderPresetOptions(data.profile_picture_url || "");
        renderUniversityOptions(data.university || "");

        if (data.university) {
          universityLabel.textContent = data.university;
          universityLabel.style.display = "block";
        } else {
          universityLabel.textContent = "";
          universityLabel.style.display = "none";
        }

        if (data.current_club_name) {
          clubEl.textContent = data.current_club_name;
          clubEl.style.display = "inline-flex";
          if (clubActions && leaveClubBtn) {
            clubActions.style.display = "flex";
            leaveClubBtn.dataset.clubId = data.current_club_id;
            leaveClubBtn.disabled = false;
            clubMessage.textContent = "";
          }
        } else {
          clubEl.style.display = "none";
          if (clubActions && leaveClubBtn) {
            clubActions.style.display = "none";
            delete leaveClubBtn.dataset.clubId;
            clubMessage.textContent = "";
          }
        }

        renderHistory(data.hand_history || []);
      } catch (error) {
        avatarMessage.textContent = error.message || "Failed to load profile.";
      }
    }

    async function loadGameHistory() {
      try {
        const data = await api(`/me/game-history?email=${encodeURIComponent(authInfo.email)}`);
        renderGameHistory(data || []);
      } catch (error) {
        gameHistoryList.innerHTML = `<div class="empty-state">${error.message || "Unable to load game history."}</div>`;
      }
    }

    avatarForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      avatarMessage.textContent = "";
      saveAvatar(avatarUrlInput.value.trim());
    });

    if (universityForm) {
      universityForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        universityMessage.textContent = "";
        saveUniversity(universitySelect.value);
      });
    }

    refreshBtn.addEventListener("click", loadProfile);
    gameHistoryBtn.addEventListener("click", loadGameHistory);

    async function downloadUserData() {
      downloadMessage.textContent = "";
      try {
        const res = await fetch(`/me/export?email=${encodeURIComponent(authInfo.email)}`, {
          headers: { Authorization: `Bearer ${accessToken}` },
        });

        if (res.status === 401) {
          localStorage.removeItem(AUTH_KEY);
          localStorage.removeItem("pokerAuth");
          window.location.href = "/";
          return;
        }

        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || `Error ${res.status}`);
        }

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `poker-user-data-${authInfo.email}.json`;
        link.click();
        window.URL.revokeObjectURL(url);
        downloadMessage.textContent = "Your data file has been downloaded.";
      } catch (error) {
        downloadMessage.textContent = error.message || "Unable to download data.";
      }
    }

    downloadDataBtn.addEventListener("click", downloadUserData);

    if (leaveClubBtn) {
      leaveClubBtn.addEventListener("click", () => {
        const clubId = leaveClubBtn.dataset.clubId;
        leaveClub(clubId);
      });
    }

    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem(AUTH_KEY);
      localStorage.removeItem("pokerAuth");
      window.location.href = "/";
    });

    loadProfile();
    loadGameHistory();
  </script>

<div class="legal-footer">
  Play-money entertainment only. Read our
  <a href="/legal.html" target="_blank" rel="noopener">legal disclaimer</a>
  and
  <a href="/terms.html" target="_blank" rel="noopener">terms of service</a>.
</div>
</body>
</html>
