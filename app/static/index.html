<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Poker Table Viewer</title>
  <style>
    :root {
      --bg: #020617;
      --panel: #020617;
      --panel-border: #1f2937;
      --accent: #22c55e;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --btn: #2563eb;
      --btn-hover: #1d4ed8;
      --danger: #dc2626;
      --danger-hover: #b91c1c;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background:
        radial-gradient(circle at 18% 18%, rgba(59, 130, 246, 0.18), transparent 32%),
        radial-gradient(circle at 82% 12%, rgba(234, 179, 8, 0.12), transparent 36%),
        linear-gradient(180deg, #0a0f23 0%, #050814 45%, #02040c 100%);
      color: var(--text-main);
      margin: 0;
      padding: 16px;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      background-attachment: fixed;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      width: 100%;
      max-width: 1300px;
    }

    .legal-footer {
      position: fixed;
      right: 16px;
      bottom: 16px;
      font-size: 11px;
      color: var(--text-muted, #9ca3af);
      z-index: 10;
    }

    .legal-footer a {
      color: inherit;
      text-decoration: none;
    }

    .legal-footer a + a {
      margin-left: 8px;
    }

    .legal-footer a:hover {
      color: var(--text-main);
      text-decoration: underline;
    }

    .control-panel {
      display: none;
    }

    .panel {
      background: var(--panel);
      border-radius: 12px;
      border: 1px solid var(--panel-border);
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      padding: 16px;
      display: flex;
      flex-direction: column;
    }

    .table-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .table-meta-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .table-blinds-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 999px;
      font-size: 12px;
      color: #e5e7eb;
      letter-spacing: 0.02em;
    }

    .table-countdown {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(14, 165, 233, 0.12);
      border: 1px solid rgba(14, 165, 233, 0.3);
      color: #bae6fd;
      letter-spacing: 0.02em;
    }

    .table-subtitle {
      margin-top: 4px;
      color: var(--text-muted);
      font-size: 12px;
    }

    h1 { margin: 0 0 8px; font-size: 20px; }
    h2 {
      font-size: 14px;
      margin: 16px 0 8px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .row { margin-bottom: 10px; }

    button {
      margin: 4px 4px 4px 0;
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: var(--btn);
      color: white;
      font-size: 12px;
    }
    button:hover:not(:disabled) { background: var(--btn-hover); }
    button:disabled {
      background: #374151;
      cursor: default;
      color: #9ca3af;
    }

    .btn-danger {
      background: var(--danger);
    }
    .btn-danger:hover:not(:disabled) {
      background: var(--danger-hover);
    }



    input[type="text"],
    input[type="password"],
    input[type="number"] {
      width: 100%;
      max-width: 200px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #f9fafb;
      font-size: 12px;
      margin: 2px 0 6px;
    }

    select {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #f9fafb;
      font-size: 12px;
    }

    .label {
      font-weight: 600;
      margin-right: 6px;
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .card-img {
      width: 100%;
      height: 100%;
      border-radius: 12px;
      object-fit: contain;
      box-shadow: 0 6px 16px rgba(0,0,0,0.65);
    }

    .seat-card img {
      width: 60px;
      height: 90px;
      border-radius: 6px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    .wallet-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    /* TABLE SELECTOR */
    .table-selector {
      margin: 18px 0;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--panel-border);
      background: linear-gradient(120deg, rgba(34,197,94,0.08), rgba(37,99,235,0.05));
    }

    .selector-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .selector-title {
      font-size: 15px;
      font-weight: 700;
      margin: 0;
    }

    .selector-sub {
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 2px;
    }

    .selector-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .table-list {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .table-card {
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      padding: 12px;
      background: rgba(2,6,23,0.8);
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }

    .table-card-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .table-title {
      font-size: 15px;
      font-weight: 700;
    }

    .table-meta {
      color: var(--text-muted);
      font-size: 12px;
    }

    .table-seats {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .seat-pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(34,197,94,0.15);
      border: 1px solid rgba(34,197,94,0.35);
      color: #bbf7d0;
      font-size: 12px;
      font-weight: 700;
    }

    .table-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      color: var(--text-muted);
      font-size: 11px;
    }

    .tag-chip {
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--panel-border);
    }

    .tag-chip.success {
      border-color: rgba(34,197,94,0.35);
      color: #bbf7d0;
      background: rgba(34,197,94,0.12);
    }

    .table-empty {
      padding: 10px 0;
      color: var(--text-muted);
      font-size: 12px;
    }

    /* TABLE AREA */

    .table-area {
      display: grid;
      grid-template-columns: minmax(260px, 320px) 1fr;
      gap: 12px;
      align-items: start;
    }

    .table-area.chat-hidden {
      grid-template-columns: 1fr;
    }

    .table-area.chat-hidden .chat-panel {
      display: none;
    }

    .table-panel {
      position: relative;
    }

    .chat-panel {
      background: radial-gradient(circle at top, rgba(59,130,246,0.08) 0, #0b1120 70%);
      border: 1px solid var(--panel-border);
      border-radius: 16px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 320px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .chat-title {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
    }

    .chat-subtitle {
      margin: 2px 0 0;
      color: var(--text-muted);
      font-size: 12px;
    }

    .chat-status {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.04em;
      border: 1px solid var(--panel-border);
      color: #fbbf24;
      background: rgba(251, 191, 36, 0.08);
    }

    .chat-status.online {
      color: #bbf7d0;
      background: rgba(34, 197, 94, 0.12);
      border-color: rgba(34, 197, 94, 0.35);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid var(--panel-border);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .chat-message {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 12px;
      padding: 8px 10px;
    }

    .chat-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .chat-author {
      font-weight: 700;
      color: #bfdbfe;
    }

    .chat-text {
      margin: 0;
      font-size: 13px;
      line-height: 1.4;
      color: var(--text-main);
      word-break: break-word;
    }

    .chat-empty {
      text-align: center;
      color: var(--text-muted);
      font-size: 12px;
      padding: 10px 0;
    }

    .chat-input-row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    #chatInput {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--panel-border);
      background: #0f172a;
      color: var(--text-main);
      font-size: 13px;
    }

    #chatInput:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #chatSendBtn {
      min-width: 70px;
      border-radius: 10px;
      border: 1px solid var(--panel-border);
      background: linear-gradient(135deg, var(--btn), var(--btn-hover));
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      padding: 0 12px;
    }

    #chatSendBtn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #1f2937;
      border-color: #111827;
    }

    .table-wrapper {
      position: relative;
      width: 100%;
      height: clamp(360px, 60vh, calc(100vh - 160px));
      aspect-ratio: 16 / 10;
      border-radius: 18px;
      overflow: visible;
      margin-bottom: 16px;
      box-shadow: 0 50px 120px rgba(0,0,0,0.65);
      isolate: isolate;
      perspective: 1600px;
      transform-style: preserve-3d;
      background: radial-gradient(ellipse at 50% 80%, rgba(0, 0, 0, 0.35), transparent 65%);
    }

    .table-stage {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transform-style: preserve-3d;
      perspective: inherit;
    }

    .table-stage-floor {
      position: absolute;
      inset: 8% 10% -12% 10%;
      border-radius: 999px;
      background: radial-gradient(ellipse at 50% 70%, rgba(0, 0, 0, 0.55), transparent 68%);
      filter: blur(20px);
      transform: translateZ(-120px) rotateX(95deg);
      transform-origin: 50% 100%;
      opacity: 0.9;
      pointer-events: none;
    }

    .table-surface {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 18px;
      background: radial-gradient(ellipse at center, rgba(7, 11, 26, 0.96) 0%, rgba(2, 6, 17, 0.96) 60%);
      box-shadow: 0 28px 80px rgba(0,0,0,0.7);
      overflow: visible;
      transform-origin: 50% 100%;
      transform: rotateX(16deg);
      transform-style: preserve-3d;
      isolation: isolate;
    }

    .table-surface::before {
      content: "";
      position: absolute;
      inset: 4%;
      border-radius: 999px;
      background: radial-gradient(ellipse at 50% 55%, rgba(255, 255, 255, 0.06), rgba(0,0,0,0.9));
      box-shadow:
        0 25px 45px rgba(0,0,0,0.7),
        0 0 80px rgba(59,130,246,0.18),
        0 0 140px rgba(236, 72, 153, 0.12);
      filter: blur(0.5px);
      z-index: 0;
      pointer-events: none;
    }

    .table-surface::after {
      content: "";
      position: absolute;
      inset: 7%;
      border-radius: 999px;
      background: radial-gradient(ellipse at 40% 30%, rgba(255,255,255,0.06), rgba(12, 19, 43, 0.95));
      border: 10px solid rgba(120, 53, 204, 0.32);
      box-shadow:
        inset 0 0 0 2px rgba(255,255,255,0.08),
        inset 0 -30px 40px rgba(0,0,0,0.6),
        0 0 80px rgba(124, 58, 237, 0.25);
      z-index: 1;
      pointer-events: none;
    }

    .action-dock {
      position: relative;
      z-index: 6;
      pointer-events: auto;
    }

    .table-controls-toggle {
      display: flex;
      justify-content: flex-end;
      width: 100%;
    }

    .table-controls-toggle .table-controls-toggle-btn {
      background: linear-gradient(135deg, #38bdf8, #2563eb);
      color: #e5e7eb;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 10px 30px rgba(0,0,0,0.4);
      font-weight: 700;
    }

    .table-controls-collapsible {
      width: 100%;
      display: flex;
      justify-content: flex-end;
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transform: translateY(-6px);
      transition: max-height 240ms ease, opacity 200ms ease, transform 200ms ease;
    }

    .table-controls-collapsible.open {
      max-height: 500px;
      opacity: 1;
      transform: translateY(0);
    }

    .table-controls-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
    }

    .felt {
      position: absolute;
      inset: 11%;
      background:
        radial-gradient(ellipse at 35% 20%, rgba(74, 222, 128, 0.38), transparent 44%),
        radial-gradient(ellipse at 70% 24%, rgba(34, 197, 94, 0.28), transparent 46%),
        radial-gradient(ellipse at 50% 55%, #166534 0%, #0f5130 38%, #052317 78%);
      border-radius: 999px;
      box-shadow:
        inset 0 0 0 8px rgba(15,23,42,0.7),
        inset 0 18px 28px rgba(0,0,0,0.45),
        0 30px 60px rgba(0,0,0,0.65);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      z-index: 2;
      transform: translateZ(50px);
      transform-style: preserve-3d;
    }

    .felt::before {
      content: "";
      position: absolute;
      inset: 16px;
      border-radius: inherit;
      background: repeating-linear-gradient(45deg, rgba(255,255,255,0.04) 0 6px, transparent 6px 12px);
      opacity: 0.22;
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .felt::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(ellipse at 50% 30%, rgba(255,255,255,0.18), transparent 60%);
      opacity: 0.35;
      pointer-events: none;
    }

    .felt.hide-empty-seats .seat.empty {
      display: none;
    }

    .table-panel-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
      justify-content: flex-start;
    }

    .center-area {
      position: relative;
      width: 64%;
      max-width: 560px;
      text-align: center;
      color: #ecfdf5;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      z-index: 4;
      pointer-events: none;
      transform: translateZ(60px);
    }

    .table-status-bar {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(0,0,0,0.28);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 12px 28px rgba(0,0,0,0.45);
      backdrop-filter: blur(6px);
    }

    .table-status-bar .pot-label {
      text-transform: uppercase;
      font-weight: 800;
      font-size: 11px;
      letter-spacing: 0.08em;
      color: #d1fae5;
    }

    .table-status-value {
      font-size: 18px;
      font-weight: 800;
      color: #fef9c3;
    }

    .board-track {
      position: relative;
      width: 100%;
      padding: 18px 20px 36px;
      border-radius: 24px;
      background: radial-gradient(ellipse at center, rgba(255,255,255,0.08), transparent 65%);
      box-shadow: none;
      overflow: hidden;
      pointer-events: none;
    }

    .board-glow {
      position: absolute;
      inset: 10% 6% 28% 6%;
      background: radial-gradient(ellipse at 50% 50%, rgba(255,255,255,0.22), rgba(255,255,255,0));
      filter: blur(26px);
      opacity: 0.3;
      pointer-events: none;
    }

    .chip-animation-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 3;
      transform: translateZ(60px);
    }

    .chip-flight {
      position: absolute;
      left: var(--start-x, 50%);
      top: var(--start-y, 50%);
      transform: translate(-50%, -50%) translate(var(--dx, 0), var(--dy, 0));
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      opacity: 0;
      animation: chip-flight-move 1s ease forwards;
      filter: drop-shadow(0 8px 12px rgba(0,0,0,0.35));
      z-index: 3;
    }

    .chip-flight-stack {
      width: 84px;
      height: 34px;
      border-radius: 18px;
      background:
        radial-gradient(circle at 30% 40%, rgba(255,255,255,0.35), transparent 50%),
        linear-gradient(135deg, #22c55e, #16a34a);
      border: 2px solid rgba(255,255,255,0.18);
      box-shadow:
        0 3px 0 rgba(0,0,0,0.25),
        0 8px 20px rgba(0,0,0,0.45),
        inset 0 2px 6px rgba(255,255,255,0.12);
      position: relative;
    }

    .chip-flight-stack::before,
    .chip-flight-stack::after {
      content: "";
      position: absolute;
      inset: 3px 8px;
      border-radius: 14px;
      background: repeating-linear-gradient(90deg, rgba(255,255,255,0.22), rgba(255,255,255,0.22) 6px, transparent 6px, transparent 12px);
      opacity: 0.7;
    }

    .chip-flight-stack::after {
      inset: 8px 14px;
      opacity: 0.5;
    }

    .chip-flight-amount {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      color: #bbf7d0;
      font-weight: 700;
      letter-spacing: 0.03em;
      border: 1px solid rgba(34,197,94,0.45);
      font-size: 13px;
      white-space: nowrap;
    }

    @keyframes chip-flight-move {
      0% { opacity: 0; transform: translate(-50%, -50%) translate(0, 0) scale(0.85); }
      25% { opacity: 1; }
      100% { opacity: 0; transform: translate(-50%, -50%) translate(var(--dx, 0), var(--dy, 0)) scale(0.9); }
    }

    .pot-display {
      padding: 6px 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      font-weight: 800;
      letter-spacing: 0.14em;
      font-size: 11px;
      text-transform: uppercase;
      box-shadow: 0 6px 16px rgba(0,0,0,0.35);
      color: #e2e8f0;
    }

    .board-cards {
      margin: 0 auto;
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
      padding: 0;
      border-radius: 16px;
      background: none;
      border: none;
      position: relative;
      z-index: 2;
      min-height: 0;
    }

    @keyframes deal-card {
      from {
        opacity: 0;
        transform: translateY(16px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .card.dealt,
    .seat-card.dealt {
      animation: deal-card 0.3s ease-out;
    }

    .card {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
      margin: 0;
      min-width: 88px;
      min-height: 124px;
      border-radius: 12px;
      background: linear-gradient(135deg, #1f2937, #0b1224);
      border: 1px solid rgba(255,255,255,0.18);
      font-family: "Menlo", monospace;
      font-size: 18px;
      font-weight: 700;
      box-shadow: 0 10px 24px rgba(0,0,0,0.55);
      position: relative;
      overflow: hidden;
    }

    .pot-info { font-size: 13px; margin-bottom: 4px; }
    .street-info { font-size: 12px; color: #cfebff; opacity: 0.8; }

    /* --- GG-style seat panel --- */

    .seat-inner {
      background: linear-gradient(160deg, rgba(19, 28, 53, 0.98), rgba(10, 15, 32, 0.95));
      border-radius: 18px;
      padding: 12px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.65);
      transition: border-color 0.15s ease-out, box-shadow 0.15s ease-out, transform 0.15s ease-out;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: hidden;
    }

    .seat.sitting-out .seat-inner {
      opacity: 0.65;
      filter: grayscale(0.5);
      border-color: rgba(156, 163, 175, 0.4);
    }

    .seat.opponent-view .seat-inner {
      padding: 8px;
      gap: 6px;
      border-radius: 14px;
    }

    .seat.opponent-view .seat-main {
      grid-template-columns: 48px 1fr;
      gap: 6px 8px;
    }

    .seat.opponent-view .seat-avatar {
      width: 48px;
      height: 48px;
    }

    .seat.opponent-view .seat-name {
      font-size: 13px;
    }

    .seat.opponent-view .seat-stack {
      font-size: 11px;
      padding: 4px 6px;
    }

    .seat.opponent-view .seat-meta-row,
    .seat.opponent-view .seat-buttons,
    .seat.opponent-view .seat-cards,
    .seat.opponent-view .seat-timer {
      display: none;
    }

    .seat-main {
      display: grid;
      grid-template-columns: 64px 1fr;
      grid-template-rows: auto auto;
      align-items: start;
      gap: 8px 10px;
    }

    /* Avatar bubble */
    .seat-avatar {
      position: relative;
      width: 64px;
      height: 64px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 20%, #4f46e5, #0f172a);
      display: grid;
      place-items: center;
      box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.9), 0 4px 12px rgba(0,0,0,0.7);
      flex-shrink: 0;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .seat-avatar-img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: inherit;
      opacity: 0;
      transition: opacity 0.15s ease-out;
    }

    .seat-avatar.has-image .seat-avatar-img {
      opacity: 1;
    }

    .seat-avatar-initial {
      font-size: 18px;
      font-weight: 800;
      color: #e5e7eb;
      text-shadow: 0 2px 6px rgba(0,0,0,0.4);
      transition: opacity 0.15s ease-out;
    }

    .seat-avatar.has-image .seat-avatar-initial {
      opacity: 0;
    }

    /* Name + stack row */
    .seat-body {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-width: 0;
    }

    .seat-name-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      min-width: 0;
    }

    .seat-name {
      font-size: 14px;
      font-weight: 700;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 0;
    }

    .seat-stack {
      font-size: 12px;
      font-weight: 800;
      color: #4ade80; /* bright green for chips */
      padding: 4px 8px;
      border-radius: 12px;
      background: rgba(74, 222, 128, 0.14);
      border: 1px solid rgba(74, 222, 128, 0.3);
      white-space: nowrap;
    }

    /* Status + bet row */
    .seat-meta-row {
      margin-top: 2px;
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 6px;
      min-width: 0;
    }

    .seat-marker-layer {
      position: absolute;
      top: -10px;
      left: 50%;
      display: flex;
      gap: 6px;
      transform: translate(-50%, -100%);
      pointer-events: none;
      z-index: 3;
    }

    .button-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 800;
      letter-spacing: 0.04em;
      color: #0b1224;
      background: #e5e7eb;
      border: 1px solid rgba(255,255,255,0.6);
      box-shadow: 0 6px 14px rgba(0,0,0,0.55);
      min-width: 32px;
      white-space: nowrap;
      opacity: 0.95;
    }

    .table-chip {
      background: rgba(229, 231, 235, 0.92);
      color: #0b1224;
    }

    .dealer-chip { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
    .sb-chip { background: linear-gradient(135deg, #38bdf8, #0ea5e9); }
    .bb-chip { background: linear-gradient(135deg, #c084fc, #a855f7); }

    .button-chip.hidden { display: none; }

    .seat-action-message {
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .seat-action-inline {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .seat-action-inline .seat-action-message {
      margin-top: 0;
    }

    .seat-status {
      font-size: 11px;
      color: #9ca3af;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .seat-bet {
      font-size: 11px;
      color: #facc15; /* yellow for current bet */
      white-space: nowrap;
    }

    .chip-pile {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 72px;
      min-height: 32px;
      padding: 6px 10px 10px;
      border-radius: 14px;
      background: linear-gradient(145deg, #f59e0b, #f97316);
      box-shadow:
        0 3px 0 rgba(0,0,0,0.3),
        0 10px 18px rgba(0,0,0,0.4);
      border: 2px solid rgba(255,255,255,0.22);
      overflow: hidden;
    }

    .chip-pile::before,
    .chip-pile::after {
      content: "";
      position: absolute;
      inset: 6px 10px auto 10px;
      height: 10px;
      border-radius: 10px;
      background: repeating-linear-gradient(90deg, rgba(255,255,255,0.45), rgba(255,255,255,0.45) 6px, transparent 6px, transparent 12px);
      opacity: 0.35;
    }

    .chip-pile::after {
      inset: 12px 16px auto 16px;
      opacity: 0.2;
    }

    .chip-amount-label {
      position: relative;
      font-weight: 800;
      letter-spacing: 0.01em;
      color: #fef9c3;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    .chip-pile.muted {
      background: linear-gradient(145deg, #9ca3af, #6b7280);
      border-color: rgba(255,255,255,0.15);
      color: #e5e7eb;
    }

    .pot-chip-stack {
      position: absolute;
      left: 50%;
      bottom: 4px;
      transform: translate(-50%, 40%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 12px 14px;
      background: rgba(2, 6, 23, 0.82);
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 14px 32px rgba(0,0,0,0.55);
      backdrop-filter: blur(4px);
      z-index: 3;
    }

    /* Bigger GG-style hole cards */
    .seat-cards {
      margin-top: 6px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .seat-timer {
      margin-top: 6px;
      height: 4px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      overflow: hidden;
      position: relative;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .seat-timer.active {
      opacity: 1;
    }

    .seat-timer-fill {
      position: absolute;
      inset: 0;
      width: 100%;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      transition: width 0.2s linear;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.25);
    }

    .seat.timer-warning .seat-timer-fill {
      background: linear-gradient(90deg, #f97316, #ef4444);
      box-shadow: 0 0 0 1px rgba(239, 68, 68, 0.4);
    }

    .seat-card img {
      width: 72px;
      height: 102px;
      border-radius: 10px;
      box-shadow: 0 6px 14px rgba(0,0,0,0.8);
    }

    .table-panel.plo .seat-cards {
      gap: 4px;
    }

    .table-panel.plo .seat-card img {
      width: 64px;
      height: 92px;
    }

    /* Floating deal animation card */
    .deal-fly-card {
      position: fixed;
      width: 90px;
      height: 130px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(1.05);
      border-radius: 12px;
      box-shadow: 0 12px 26px rgba(0,0,0,0.55);
      opacity: 0;
      pointer-events: none;
      transition: transform 0.45s ease-out, opacity 0.35s ease-out;
      z-index: 12000;
    }

    /* Highlight acting player */
    .seat.highlight .seat-inner {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.7), 0 10px 22px rgba(0,0,0,0.9);
    }

    .seat.stats-highlight .seat-inner {
      box-shadow: 0 0 0 2px #38bdf8, 0 12px 32px rgba(59,130,246,0.35);
    }

    /* Seats */

    .seat {
      position: absolute;
      width: clamp(180px, 20vw, 240px);
      max-width: 260px;
      transform: translate(-50%, -50%) translateZ(60px);
      color: #e5e7eb;
      --seat-top: 50%;
      --seat-left: 50%;
      top: var(--seat-top);
      left: var(--seat-left);
      transition: top 0.25s ease, left 0.25s ease;
    }
    .seat.empty .seat-inner {
      opacity: 0.2;
      border-style: dashed;
    }

    .seat.empty {
      cursor: pointer;
    }

    .seat.empty .seat-inner:hover {
      opacity: 0.35;
    }

    .seat.highlight .seat-inner {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.6), 0 8px 16px rgba(0,0,0,0.8);
    }

    /* Player stats flyout */
    .player-stats {
      position: absolute;
      right: 20px;
      top: 90px;
      width: 320px;
      background: rgba(10, 15, 32, 0.94);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 14px;
      box-shadow: 0 24px 50px rgba(0,0,0,0.45);
      padding: 16px;
      backdrop-filter: blur(8px);
      z-index: 6;
    }

    .player-stats.hidden {
      display: none;
    }

    .player-stats-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 12px;
    }

    .player-stats-title {
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .player-stats-meta {
      color: var(--text-muted);
      font-size: 13px;
      margin-top: 2px;
    }

    .player-stats-close {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      color: #e5e7eb;
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
    }

    .player-stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .player-stat-tile {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .player-stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .player-stat-value {
      font-weight: 700;
      font-size: 16px;
    }

    .player-stat-help {
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.3;
    }

    .player-stat-empty {
      grid-column: 1 / -1;
      background: rgba(255,255,255,0.04);
      border: 1px dashed rgba(255,255,255,0.15);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    /* ACTION DOCK */

    .action-dock {
      position: absolute;
      left: var(--action-left, 50%);
      top: var(--action-top, 82%);
      transform: translate(-50%, 120%);
      padding: 14px 18px;
      border-radius: 18px;
      background: rgba(2, 6, 23, 0.94);
      border: 1px solid #1f2937;
      box-shadow: 0 20px 44px rgba(0,0,0,0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
      backdrop-filter: blur(6px);
      z-index: 5;
      pointer-events: none;
      opacity: 0;
      transition: transform 0.25s ease, opacity 0.25s ease;
      width: min(960px, 96%);
    }

    .action-dock.visible {
      pointer-events: auto;
      opacity: 1;
      transform: translate(-50%, 0);
    }

    .action-left,
    .action-middle,
    .action-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .action-dock button {
      pointer-events: auto;
      touch-action: manipulation;
    }

    .action-left button {
      padding: 14px 26px;
      font-size: 16px;
      font-weight: 700;
    }

    .action-middle-main {
      display: flex;
      align-items: baseline;
      gap: 4px;
    }

    .bottom-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .action-right button {
      padding: 10px 14px;
      font-size: 13px;
      font-weight: 700;
    }

    .action-right input[type="number"] {
      width: 70px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #f9fafb;
      font-size: 13px;
    }

    .action-middle-main button,
    .action-right button,
    .action-left button {
      border-radius: 14px;
      min-width: 96px;
    }

    /* Hand history */
    .hand-history-launcher {
      display: flex;
      justify-content: flex-end;
      margin-top: 12px;
    }

    .hand-history-launcher button {
      background: linear-gradient(135deg, #1d4ed8, #7c3aed);
      color: #e2e8f0;
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 12px;
      padding: 10px 16px;
      font-weight: 800;
      letter-spacing: 0.02em;
      box-shadow: 0 10px 30px rgba(59, 130, 246, 0.25);
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    .hand-history-launcher button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 34px rgba(124, 58, 237, 0.3);
    }

    .hand-history-panel {
      position: fixed;
      bottom: 120px;
      right: 24px;
      width: 380px;
      max-width: calc(100% - 32px);
      max-height: 70vh;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid var(--panel-border);
      border-radius: 14px;
      padding: 12px;
      box-shadow: 0 24px 70px rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(6px);
      overflow-y: auto;
      z-index: 50;
    }

    .hand-history-panel.hidden { display: none; }

    .hand-history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .hand-history-title {
      font-size: 14px;
      font-weight: 800;
      margin: 0;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: #cbd5e1;
    }

    .hand-history-sub {
      margin: 4px 0 0;
      color: var(--text-muted);
      font-size: 12px;
    }

    .hand-history-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .close-hand-history {
      background: rgba(148, 163, 184, 0.12);
      color: #e2e8f0;
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease;
    }

    .close-hand-history:hover {
      background: rgba(226, 232, 240, 0.16);
      border-color: rgba(226, 232, 240, 0.4);
    }

    .hand-history-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 320px;
      overflow-y: auto;
    }

    .hand-history-card {
      border: 1px solid rgba(255,255,255,0.06);
      background: linear-gradient(145deg, rgba(15,23,42,0.7), rgba(6,8,20,0.9));
      border-radius: 12px;
      padding: 10px;
    }

    .hand-history-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .hand-label {
      font-weight: 700;
      color: #e5e7eb;
      letter-spacing: 0.02em;
    }

    .board-small {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .board-small .card {
      width: 32px;
      height: 44px;
      font-size: 14px;
    }

    .hand-result-pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(34,197,94,0.12);
      border: 1px solid rgba(34,197,94,0.3);
      color: #bbf7d0;
      font-weight: 700;
      font-size: 12px;
    }

    .hand-history-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
    }

    .history-column {
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 10px;
      padding: 8px;
    }

    .history-column h4 {
      margin: 0 0 6px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 11px;
      color: #cbd5e1;
    }

    .history-entry {
      padding: 6px 8px;
      border-radius: 8px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .history-entry:last-child { margin-bottom: 0; }

    .history-player {
      font-weight: 700;
      color: #e2e8f0;
    }

    .history-action {
      font-size: 12px;
      color: #cbd5e1;
    }

    .history-amount {
      font-weight: 700;
      color: #f8fafc;
    }

    .empty-history {
      text-align: center;
      color: var(--text-muted);
      padding: 16px 0;
      font-size: 13px;
    }

    .winner-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.04);
      font-size: 12px;
      color: #e5e7eb;
    }

    .winner-chip strong { color: #bbf7d0; }

    .street-board-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Raw JSON */

    pre {
      background: #020617;
      padding: 8px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 11px;
      border: 1px solid #1f2937;
      max-height: 220px;
    }

    /* MODALS */

    .modal.hidden { display: none; }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9000;
    }

    .modal-content {
      background: #020617;
      border-radius: 12px;
      padding: 16px 20px;
      border: 1px solid #1f2937;
      min-width: 260px;
      color: var(--text-main);
    }

    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 16px;
    }

    .modal-content input {
      width: 100%;
    }

    .buyin-modal {
      max-width: 400px;
      width: 100%;
    }

    .buyin-balance {
      color: var(--text-muted);
      font-size: 12px;
      margin-bottom: 6px;
    }

    .buyin-slider {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }

    .buyin-slider input[type="range"] {
      flex: 1;
      accent-color: #22c55e;
    }

    .buyin-amount {
      font-size: 24px;
      font-weight: 700;
      text-align: center;
      margin: 6px 0 2px;
    }

    .buyin-seat-label {
      font-size: 13px;
      color: var(--text-muted);
      text-align: center;
    }

    /* BIG CARD OVERLAY (ClubGG-style) */

    #bigCardOverlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s ease-out;
      z-index: 9999;
    }

    #bigCardOverlay.show {
      opacity: 1;
    }

    #bigCard {
      width: 180px;
      height: 260px;
      border-radius: 16px;
      background: #f9fafb;
      box-shadow: 0 12px 30px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transform: scale(0.2) translateY(40px);
      opacity: 0;
    }

    #bigCard.animate {
      animation: big-card-pop 0.35s ease-out forwards;
    }

    .big-card-rank {
      font-size: 64px;
      font-weight: 700;
      line-height: 1;
    }

    .big-card-suit {
      font-size: 52px;
      margin-top: 8px;
    }

    #bigCard.red .big-card-rank,
    #bigCard.red .big-card-suit {
      color: #dc2626;
    }

    #bigCard.black .big-card-rank,
    #bigCard.black .big-card-suit {
      color: #111827;
    }

    @media (max-width: 1100px) {
      .table-area {
        grid-template-columns: 1fr;
      }

      .chat-panel {
        min-height: auto;
      }
    }

    @keyframes big-card-pop {
      0% {
        transform: scale(0.2) translateY(40px);
        opacity: 0;
      }
      60% {
        transform: scale(1.05) translateY(0);
        opacity: 1;
      }
      100% {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }
  </style>
  <script src="/static/custom-alert.js" defer></script>
  <script>
    const token = localStorage.getItem("poker_token");
    if (!token) {
      window.location.href = "/";
    }
  </script>
</head>
<body>
  <div class="layout">
    <!-- LEFT SIDE: Auth, wallet, clubs, controls -->
    <div class="panel control-panel" style="display:none !important;">
      <h1>Poker Engine Control</h1>
      <div class="row" style="margin-bottom: 12px;">
        <a href="/club-management" style="color: #93c5fd; text-decoration: none; font-size: 12px;">
          Open the club management page â†’
        </a>
      </div>

      <!-- AUTH -->
      <h2>Auth</h2>
      <div class="row">
        <div>
          <span class="label">Username</span><br/>
          <input type="text" id="usernameInput" placeholder="pokerfan" />
        </div>
      </div>

      <div class="row">
        <div>
          <span class="label">Email</span><br/>
          <input type="text" id="emailInput" placeholder="you@example.com" />
        </div>
        <div>
          <span class="label">Password</span><br/>
          <input type="password" id="passwordInput" placeholder="password" />
        </div>
      </div>
      <div class="row">
        <button id="registerBtn">Register</button>
        <button id="loginBtn">Login</button>
      </div>
      <div class="row" style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
        <span class="label">User:</span>
        <span id="currentUsername">Not logged in</span>
        <span id="currentUserEmail" class="hint" style="display:none;"></span>
        <button id="logoutBtn" class="btn-danger" style="margin-left:auto;">Logout</button>
      </div>

      <!-- WALLET -->
      <h2>Wallet</h2>
      <div class="row wallet-row">
        <div>
          <span class="label">Balance</span>
          <span id="balanceText">0</span>
        </div>
        <button id="topupOpenBtn" disabled>Top up</button>
      </div>

      <!-- CLUBS -->
      <h2>Club</h2>
      <div class="row">
        <div>
          <span class="label">New club name</span><br/>
          <input type="text" id="clubNameInput" placeholder="My Club" />
        </div>
        <button id="createClubBtn" disabled>Create Club</button>
      </div>

      <div class="row">
        <div>
          <span class="label">Join club ID</span><br/>
          <input type="number" id="joinClubIdInput" placeholder="1" />
        </div>
        <button id="joinClubBtn" disabled>Join Club</button>
      </div>

      <div class="row">
        <span class="label">Active club:</span>
        <span id="currentClubId">None</span>
      </div>
      <div class="row">
        <div class="hint">Use the ID of a club you created or joined.</div>
      </div>

      <!-- TABLE SELECTOR -->
      <div class="table-selector">
        <div class="selector-header">
          <div>
            <p class="selector-title">Available Tables</p>
            <div class="selector-sub">Pick a table created by your club owner.</div>
          </div>
          <div class="selector-actions">
            <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-muted);">
              <input type="checkbox" id="hideFullTables" /> Hide full tables
            </label>
            <button id="refreshTablesBtn" disabled>Refresh</button>
          </div>
        </div>
        <div id="tableList" class="table-list">
          <div class="table-empty">Log in to see tables available to your clubs.</div>
        </div>
      </div>

      <!-- BETTING / STREETS -->
      <h2>Streets & Showdown</h2>
      <div class="row">
        <button id="dealFlopBtn" disabled>Deal Flop (manual)</button>
        <button id="dealTurnBtn" disabled>Deal Turn (manual)</button>
        <button id="dealRiverBtn" disabled>Deal River (manual)</button>
        <button id="showdownBtn" disabled>Showdown</button>
      </div>

      <!-- STATE -->
      <h2>State</h2>
      <div class="row">
        <div><span class="label">Table:</span><span id="tableId">None</span></div>
        <div><span class="label">Street:</span><span id="street">-</span></div>
        <div><span class="label">Pot:</span><span id="pot">0</span></div>
        <div><span class="label">Current Bet:</span><span id="currentBet">0</span></div>
        <div><span class="label">Next Seat:</span><span id="nextToAct">-</span></div>
      </div>

      <div class="row">
        <div><span class="label">Blinds:</span><span id="blindsInfo">-</span></div>
        <div><span class="label">Dealer:</span><span id="dealerSeatLabel">-</span></div>
        <div><span class="label">SB Seat:</span><span id="sbSeatLabel">-</span></div>
        <div><span class="label">BB Seat:</span><span id="bbSeatLabel">-</span></div>
      </div>

      <div class="row">
        <span class="label">Raw JSON</span>
        <pre id="rawState">{}</pre>
      </div>
    </div>

      <!-- RIGHT: Table + bottom action bar -->
    <div class="panel table-panel">
      <div class="table-panel-header">
        <div>
          <h2 id="tableHeadingLabel">Table -</h2>
          <div class="table-subtitle">Focused table view</div>
          <div class="table-meta-row">
            <span class="table-blinds-pill" id="tableGameTypeBadge">NLH</span>
            <span class="table-blinds-pill" id="tableBlindsBadge">Blinds -/-</span>
            <span class="table-countdown" id="tableClosingTimer">Closing timer unavailable</span>
          </div>
        </div>
        <div class="table-panel-actions">
          <div class="table-controls-toggle">
            <button id="controlsToggleBtn" class="table-controls-toggle-btn" aria-expanded="false">Show controls</button>
          </div>
          <div id="tableControlsPanel" class="table-controls-collapsible">
            <div class="table-controls-group">
              <button id="toggleChatVisibilityBtn" class="btn secondary" aria-pressed="false">Hide chat</button>
              <button id="backToLobbyBtn" class="btn secondary" onclick="window.location.href='/available-tables'">Back to Table Lobby</button>
              <div class="seat-action-inline">
                <button id="changeSeatBtn" class="btn secondary" disabled>Change seat</button>
                <span id="seatActionMessage" class="seat-action-message"></span>
              </div>
              <button id="sitOutBtn" class="btn secondary" disabled>Sit out</button>
              <button id="returnToPlayBtn" class="btn secondary" disabled>I'm back</button>
              <button id="leaveTableBtn" class="btn btn-danger" disabled>Leave table</button>
            </div>
          </div>
        </div>
      </div>
      <div id="playerStatsCard" class="player-stats hidden">
        <div class="player-stats-header">
          <div>
            <div class="player-stats-title" id="playerStatsName">Player</div>
            <div class="player-stats-meta" id="playerStatsMeta">Seat / Stack</div>
          </div>
          <button id="closePlayerStats" class="player-stats-close" type="button">Close</button>
        </div>
        <div class="player-stats-grid" id="playerStatsGrid"></div>
      </div>
      <div class="table-area">
        <aside class="chat-panel" aria-label="Table chat">
          <div class="chat-header">
            <div>
              <p class="chat-title">Table chat</p>
              <p class="chat-subtitle">Chat with players at this table.</p>
            </div>
            <span id="chatStatus" class="chat-status">Offline</span>
          </div>
          <div id="chatMessages" class="chat-messages">
            <div id="chatEmpty" class="chat-empty">No messages yet. Say hello to the table.</div>
          </div>
          <form id="chatForm" class="chat-input-row">
            <input id="chatInput" type="text" placeholder="Type a message" autocomplete="off" maxlength="240" />
            <button id="chatSendBtn" type="submit" disabled>Send</button>
          </form>
        </aside>

          <div class="table-wrapper">
            <div class="table-stage">
              <div class="table-stage-floor"></div>
              <div class="table-surface">
                <div id="chipAnimationLayer" class="chip-animation-layer"></div>
                <div class="felt">
          <div class="center-area">
            <div class="table-status-bar">
              <span class="pot-label">Total Pot</span>
              <span class="table-status-value" id="potCenter">0</span>
            </div>
            <div class="board-track">
              <div class="board-glow"></div>
              <div class="board-cards" id="boardCards"></div>
              <div class="pot-chip-stack">
                <div class="chip-pile" aria-hidden="true">
                  <span id="potChipAmount" class="chip-amount-label">0</span>
                </div>
                <div class="pot-display">In play</div>
              </div>
            </div>
          </div>
          <!-- 6 seat slots -->
          <div class="seat empty" data-seat="0">
            <div class="seat-marker-layer">
              <span class="button-chip table-chip dealer-chip hidden" aria-label="Dealer button">D</span>
              <span class="button-chip table-chip sb-chip hidden" aria-label="Small blind">SB</span>
              <span class="button-chip table-chip bb-chip hidden" aria-label="Big blind">BB</span>
            </div>
            <div class="seat-inner">
              <div class="seat-main">
                <div class="seat-avatar">
                  <img class="seat-avatar-img" alt="Avatar" />
                  <span class="seat-avatar-initial">?</span>
                </div>
                <div class="seat-body">
                  <div class="seat-name-row">
                    <span class="seat-name">Empty</span>
                    <span class="seat-stack">0</span>
                  </div>
                  <div class="seat-meta-row">
                    <span class="seat-status">Click to sit</span>
                    <span class="seat-bet"></span>
                  </div>
                  <div class="seat-timer">
                    <div class="seat-timer-fill"></div>
                  </div>
                </div>
              </div>
              <div class="seat-cards"></div>
            </div>
          </div>

          <div class="seat empty" data-seat="1">
            <div class="seat-marker-layer">
              <span class="button-chip table-chip dealer-chip hidden" aria-label="Dealer button">D</span>
              <span class="button-chip table-chip sb-chip hidden" aria-label="Small blind">SB</span>
              <span class="button-chip table-chip bb-chip hidden" aria-label="Big blind">BB</span>
            </div>
            <div class="seat-inner">
              <div class="seat-main">
                <div class="seat-avatar">
                  <img class="seat-avatar-img" alt="Avatar" />
                  <span class="seat-avatar-initial">?</span>
                </div>
                <div class="seat-body">
                  <div class="seat-name-row">
                    <span class="seat-name">Empty</span>
                    <span class="seat-stack">0</span>
                  </div>
                  <div class="seat-meta-row">
                    <span class="seat-status">Click to sit</span>
                    <span class="seat-bet"></span>
                  </div>
                  <div class="seat-timer">
                    <div class="seat-timer-fill"></div>
                  </div>
                </div>
              </div>
              <div class="seat-cards"></div>
            </div>
          </div>

          <div class="seat empty" data-seat="2">
            <div class="seat-marker-layer">
              <span class="button-chip table-chip dealer-chip hidden" aria-label="Dealer button">D</span>
              <span class="button-chip table-chip sb-chip hidden" aria-label="Small blind">SB</span>
              <span class="button-chip table-chip bb-chip hidden" aria-label="Big blind">BB</span>
            </div>
            <div class="seat-inner">
              <div class="seat-main">
                <div class="seat-avatar">
                  <img class="seat-avatar-img" alt="Avatar" />
                  <span class="seat-avatar-initial">?</span>
                </div>
                <div class="seat-body">
                  <div class="seat-name-row">
                    <span class="seat-name">Empty</span>
                    <span class="seat-stack">0</span>
                  </div>
                  <div class="seat-meta-row">
                    <span class="seat-status">Click to sit</span>
                    <span class="seat-bet"></span>
                  </div>
                  <div class="seat-timer">
                    <div class="seat-timer-fill"></div>
                  </div>
                </div>
              </div>
              <div class="seat-cards"></div>
            </div>
          </div>

          <div class="seat empty" data-seat="3">
            <div class="seat-marker-layer">
              <span class="button-chip table-chip dealer-chip hidden" aria-label="Dealer button">D</span>
              <span class="button-chip table-chip sb-chip hidden" aria-label="Small blind">SB</span>
              <span class="button-chip table-chip bb-chip hidden" aria-label="Big blind">BB</span>
            </div>
            <div class="seat-inner">
              <div class="seat-main">
                <div class="seat-avatar">
                  <img class="seat-avatar-img" alt="Avatar" />
                  <span class="seat-avatar-initial">?</span>
                </div>
                <div class="seat-body">
                  <div class="seat-name-row">
                    <span class="seat-name">Empty</span>
                    <span class="seat-stack">0</span>
                  </div>
                  <div class="seat-meta-row">
                    <span class="seat-status">Click to sit</span>
                    <span class="seat-bet"></span>
                  </div>
                  <div class="seat-timer">
                    <div class="seat-timer-fill"></div>
                  </div>
                </div>
              </div>
              <div class="seat-cards"></div>
            </div>
          </div>

          <div class="seat empty" data-seat="4">
            <div class="seat-marker-layer">
              <span class="button-chip table-chip dealer-chip hidden" aria-label="Dealer button">D</span>
              <span class="button-chip table-chip sb-chip hidden" aria-label="Small blind">SB</span>
              <span class="button-chip table-chip bb-chip hidden" aria-label="Big blind">BB</span>
            </div>
            <div class="seat-inner">
              <div class="seat-main">
                <div class="seat-avatar">
                  <img class="seat-avatar-img" alt="Avatar" />
                  <span class="seat-avatar-initial">?</span>
                </div>
                <div class="seat-body">
                  <div class="seat-name-row">
                    <span class="seat-name">Empty</span>
                    <span class="seat-stack">0</span>
                  </div>
                  <div class="seat-meta-row">
                    <span class="seat-status">Click to sit</span>
                    <span class="seat-bet"></span>
                  </div>
                  <div class="seat-timer">
                    <div class="seat-timer-fill"></div>
                  </div>
                </div>
              </div>
              <div class="seat-cards"></div>
            </div>
          </div>

          <div class="seat empty" data-seat="5">
            <div class="seat-marker-layer">
              <span class="button-chip table-chip dealer-chip hidden" aria-label="Dealer button">D</span>
              <span class="button-chip table-chip sb-chip hidden" aria-label="Small blind">SB</span>
              <span class="button-chip table-chip bb-chip hidden" aria-label="Big blind">BB</span>
            </div>
            <div class="seat-inner">
              <div class="seat-main">
                <div class="seat-avatar">
                  <img class="seat-avatar-img" alt="Avatar" />
                  <span class="seat-avatar-initial">?</span>
                </div>
                <div class="seat-body">
                  <div class="seat-name-row">
                    <span class="seat-name">Empty</span>
                    <span class="seat-stack">0</span>
                  </div>
                  <div class="seat-meta-row">
                    <span class="seat-status">Click to sit</span>
                    <span class="seat-bet"></span>
                  </div>
                  <div class="seat-timer">
                    <div class="seat-timer-fill"></div>
                  </div>
                </div>
              </div>
              <div class="seat-cards"></div>
            </div>
          </div>

          <div class="seat" data-seat="6">
            <div class="seat-marker-layer">
              <span class="button-chip table-chip dealer-chip hidden" aria-label="Dealer button">D</span>
              <span class="button-chip table-chip sb-chip hidden" aria-label="Small blind">SB</span>
              <span class="button-chip table-chip bb-chip hidden" aria-label="Big blind">BB</span>
            </div>
            <div class="seat-inner">
              <div class="seat-main">
                <div class="seat-avatar">
                  <img class="seat-avatar-img" alt="Avatar" />
                  <span class="seat-avatar-initial">?</span>
                </div>
                <div class="seat-body">
                  <div class="seat-name-row">
                    <span class="seat-name">Empty</span>
                    <span class="seat-stack">0</span>
                  </div>
                  <div class="seat-meta-row">
                    <span class="seat-status">Click to sit</span>
                    <span class="seat-bet"></span>
                  </div>
                  <div class="seat-timer">
                    <div class="seat-timer-fill"></div>
                  </div>
                </div>
              </div>
              <div class="seat-cards"></div>
            </div>
          </div>

          <div class="seat" data-seat="7">
            <div class="seat-marker-layer">
              <span class="button-chip table-chip dealer-chip hidden" aria-label="Dealer button">D</span>
              <span class="button-chip table-chip sb-chip hidden" aria-label="Small blind">SB</span>
              <span class="button-chip table-chip bb-chip hidden" aria-label="Big blind">BB</span>
            </div>
            <div class="seat-inner">
              <div class="seat-main">
                <div class="seat-avatar">
                  <img class="seat-avatar-img" alt="Avatar" />
                  <span class="seat-avatar-initial">?</span>
                </div>
                <div class="seat-body">
                  <div class="seat-name-row">
                    <span class="seat-name">Empty</span>
                    <span class="seat-stack">0</span>
                  </div>
                  <div class="seat-meta-row">
                    <span class="seat-status">Click to sit</span>
                    <span class="seat-bet"></span>
                  </div>
                  <div class="seat-timer">
                    <div class="seat-timer-fill"></div>
                  </div>
                </div>
              </div>
              <div class="seat-cards"></div>
            </div>
          </div>

          <div class="seat" data-seat="8">
            <div class="seat-marker-layer">
              <span class="button-chip table-chip dealer-chip hidden" aria-label="Dealer button">D</span>
              <span class="button-chip table-chip sb-chip hidden" aria-label="Small blind">SB</span>
              <span class="button-chip table-chip bb-chip hidden" aria-label="Big blind">BB</span>
            </div>
            <div class="seat-inner">
              <div class="seat-main">
                <div class="seat-avatar">
                  <img class="seat-avatar-img" alt="Avatar" />
                  <span class="seat-avatar-initial">?</span>
                </div>
                <div class="seat-body">
                  <div class="seat-name-row">
                    <span class="seat-name">Empty</span>
                    <span class="seat-stack">0</span>
                  </div>
                  <div class="seat-meta-row">
                    <span class="seat-status">Click to sit</span>
                    <span class="seat-bet"></span>
                  </div>
                  <div class="seat-timer">
                    <div class="seat-timer-fill"></div>
                  </div>
                </div>
              </div>
              <div class="seat-cards"></div>
            </div>
          </div>
        </div> <!-- end .felt -->

        </div>   <!-- end .table-surface -->

        <div class="action-dock">
          <div class="action-left">
            <button id="foldMainBtn" class="btn-danger" disabled>Fold</button>
          </div>

          <div class="action-middle">
            <div>
              <div class="bottom-label">Acting Player</div>
              <div id="actingPlayerLabel">None</div>
            </div>
            <div class="action-middle-main">
              <button id="callMainBtn" disabled>Call / Check</button>
              <span id="callAmountLabel">0</span>
            </div>
          </div>

          <div class="action-right">
            <div>
              <div class="bottom-label">Raise</div>
              <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
                <input type="number" id="raiseCustomInput" placeholder="Amt" />
                <button id="raiseCustomBtn" disabled>Raise</button>
                <button id="raise30Btn" disabled>30%</button>
                <button id="raise50Btn" disabled>50%</button>
                <button id="raise100Btn" disabled>100%</button>
              </div>
            </div>
          </div>
        </div> <!-- end .action-dock -->
      </div>     <!-- end .table-stage -->

        <div class="hand-history-launcher">
          <button id="handHistoryToggleBtn" aria-expanded="false">View hand history</button>
        </div>

        <div class="hand-history-panel hidden" role="dialog" aria-modal="true" aria-labelledby="handHistoryTitle">
          <div class="hand-history-header">
            <div>
              <p id="handHistoryTitle" class="hand-history-title">Table hand history</p>
              <p class="hand-history-sub">Latest 50 hands with per-street actions.</p>
            </div>
            <div class="hand-history-actions">
              <button id="closeHandHistoryBtn" class="close-hand-history" aria-label="Close hand history">Close</button>
            </div>
          </div>
          <div id="handHistoryList" class="hand-history-list">
            <div class="empty-history">Play a hand to start building history.</div>
          </div>
        </div> <!-- end .hand-history-panel -->
      </div>   <!-- end .table-wrapper -->
    </div>   <!-- end .table-area -->
  </div>   <!-- end .panel -->

  <!-- Top up modal -->
  <div id="topupModal" class="modal hidden">
    <div class="modal-content">
      <h3>Top up balance</h3>
      <input type="number" id="topupAmount" min="1" step="1" value="1000" />
      <div style="margin-top:8px;display:flex;justify-content:flex-end;gap:8px;">
        <button id="topupCancelBtn" class="btn-danger">Cancel</button>
        <button id="topupConfirmBtn">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Buy-in modal -->
  <div id="buyinModal" class="modal hidden">
    <div class="modal-content buyin-modal">
      <h3>Join the table</h3>
      <div class="buyin-seat-label" id="buyinSeatLabel"></div>
      <div class="buyin-balance" id="buyinBalanceLabel"></div>
      <div class="buyin-amount" id="buyinAmountDisplay"></div>
      <div class="buyin-slider">
        <input type="range" id="buyinRange" min="1" step="1" />
        <div id="buyinRangeValue" style="width:48px;text-align:center;font-weight:600;"></div>
      </div>
      <div id="buyinError" class="seat-action-message" style="color:#fca5a5;"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;">
        <button id="buyinCancelBtn" class="btn-danger">Cancel</button>
        <button id="buyinConfirmBtn">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Change seat modal -->
  <div id="seatChangeModal" class="modal hidden">
    <div class="modal-content">
      <h3>Change your seat</h3>
      <div id="seatChangeMessage" class="seat-action-message"></div>
      <div id="seatChangeOptions" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;margin:12px 0;"></div>
      <div id="seatChangeError" class="seat-action-message" style="color:#fca5a5;"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;">
        <button id="seatChangeCancelBtn" class="btn-danger">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Big card overlay -->
  <div id="bigCardOverlay">
    <div id="bigCard">
      <div id="bigCardRank" class="big-card-rank"></div>
      <div id="bigCardSuit" class="big-card-suit"></div>
    </div>
  </div>

  <script>
    const API_BASE = "";
    const AUTH_STORAGE_KEY = "pokerAuth";
    const CHAT_MAX_MESSAGES = 50;
    const STATE_RENDER_BASE_DELAY_MS = 200;
    const HAND_START_EXTRA_DELAY_MS = 600;
    let tableId = null;
    let currentTableName = null;
    const urlParams = new URLSearchParams(window.location.search);
    const preselectedTableId = urlParams.get("tableId");
    let lastState = null;
    let pendingRenderState = null;
    let renderStateTimer = null;
    let chatMessages = [];
    let tableSocket = null;
    let wsReconnectTimer = null;
    let wsHeartbeatTimer = null;
    let wsPollTimer = null;
    const WS_POLL_MS = 5000;
    let wsShouldReconnect = false;
    let accessToken = null;
    let currentUserEmail = null;
    let currentUserId = null;
    let currentUsername = null;
    let currentClubId = null;
    let actingPlayer = null; // current acting player object from state
    let currentUserBalance = 0;
    let tableOwnerUserId = null;
    let controlsHidden = true;
    let pendingSeatIndex = null;
    let actingTimerInterval = null;
    let actingTimerSeat = null;
    let timerWarningFired = false;
    let openStatsSeat = null;
    let openStatsPlayerId = null;
    let tableClosingAt = null;
    let tableCountdownInterval = null;

    const ACTING_TIME_MS = 30000;
    const TIMER_WARNING_MS = 5000;
    const WS_HEARTBEAT_MS = 15000;
    const WS_RECONNECT_MS = 3000;
    const TABLE_EXPIRY_MS = 24 * 60 * 60 * 1000;

    const DEFAULT_SEAT_RADIUS = { x: 46, y: 34 };

    function generateSeatPositions(totalSeats, viewerSeat = Math.floor(totalSeats / 2), radius = DEFAULT_SEAT_RADIUS) {
      const seatCount = Math.max(2, totalSeats);
      const anchorSeat = Math.min(Math.max(viewerSeat, 0), seatCount - 1);
      const angleStep = 360 / seatCount;
      const angleOffset = 90 - angleStep * anchorSeat; // place anchor seat at bottom center

      return Array.from({ length: seatCount }, (_, idx) => {
        const angleRad = ((angleOffset + angleStep * idx) * Math.PI) / 180;
        return {
          top: `${50 + radius.y * Math.sin(angleRad)}%`,
          left: `${50 + radius.x * Math.cos(angleRad)}%`,
        };
      });
    }

    const RAW_SEAT_LAYOUTS = {
      6: { viewerSeat: 3, radius: { x: 42, y: 30 } },
      8: { viewerSeat: 4, radius: { x: 44, y: 32 } },
      9: { viewerSeat: 5, radius: { x: 46, y: 34 } },
    };

    const SEAT_LAYOUTS = Object.fromEntries(
      Object.entries(RAW_SEAT_LAYOUTS).map(([count, config]) => {
        const seatCount = Number(count);
        const radius = { ...DEFAULT_SEAT_RADIUS, ...config.radius };
        const viewerSeat = config.viewerSeat ?? Math.floor(seatCount / 2);

        return [
          seatCount,
          {
            viewerSeat,
            positions: generateSeatPositions(seatCount, viewerSeat, radius),
          },
        ];
      })
    );

    function formatChips(value, decimals = 2) {
      const num = Number(value ?? 0);
      if (!Number.isFinite(num)) return (0).toFixed(decimals);
      return num.toFixed(decimals);
    }

    function formatDuration(ms) {
      const totalSeconds = Math.max(0, Math.floor(ms / 1000));
      const hours = Math.floor(totalSeconds / 3600)
        .toString()
        .padStart(2, "0");
      const minutes = Math.floor((totalSeconds % 3600) / 60)
        .toString()
        .padStart(2, "0");
      const seconds = (totalSeconds % 60).toString().padStart(2, "0");
      return `${hours}:${minutes}:${seconds}`;
    }

    function parseServerDatetime(value) {
      if (value == null) return null;

      if (typeof value === "number") {
        return Number.isFinite(value) ? value : null;
      }

      const raw = String(value).trim();
      if (!raw) return null;

      const normalized = raw.includes("T") ? raw : raw.replace(" ", "T");
      const parsedNormalized = Date.parse(normalized);
      if (Number.isFinite(parsedNormalized)) return parsedNormalized;

      const trimmedFractional = normalized.replace(/(\.\d{3})\d+/, "$1");
      const parsedTrimmed = Date.parse(trimmedFractional);
      if (Number.isFinite(parsedTrimmed)) return parsedTrimmed;

      return null;
    }

    function formatChatTimestamp(value) {
      const parsed = value ? Date.parse(value) : NaN;
      const date = Number.isFinite(parsed) ? new Date(parsed) : new Date();
      return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function trimChatHistory(list) {
      if (!Array.isArray(list)) return [];
      return list.slice(Math.max(list.length - CHAT_MAX_MESSAGES, 0));
    }

    function setChatConnected(isConnected) {
      if (chatStatusBadge) {
        chatStatusBadge.textContent = isConnected ? "Live" : "Offline";
        chatStatusBadge.classList.toggle("online", !!isConnected);
      }
      if (chatInput) chatInput.disabled = !isConnected || !tableId;
      if (chatSendBtn) chatSendBtn.disabled = !isConnected || !tableId;
    }

    function setChatVisibility(isVisible) {
      if (!tableArea || !chatVisibilityToggle) return;

      tableArea.classList.toggle("chat-hidden", !isVisible);
      chatVisibilityToggle.textContent = isVisible ? "Hide chat" : "Show chat";
      chatVisibilityToggle.setAttribute("aria-pressed", (!isVisible).toString());
    }

    function renderChatMessages() {
      if (!chatMessagesEl) return;
      chatMessagesEl.innerHTML = "";

      if (!chatMessages.length) {
        if (chatEmptyEl) {
          chatEmptyEl.style.display = "block";
          chatMessagesEl.appendChild(chatEmptyEl);
        }
        return;
      }

      if (chatEmptyEl) chatEmptyEl.style.display = "none";

      chatMessages.forEach((entry) => {
        const row = document.createElement("div");
        row.className = "chat-message";

        const meta = document.createElement("div");
        meta.className = "chat-meta";

        const author = document.createElement("span");
        author.className = "chat-author";
        author.textContent = entry.username || "Player";

        const time = document.createElement("span");
        time.textContent = formatChatTimestamp(entry.timestamp);

        meta.appendChild(author);
        meta.appendChild(time);

        const body = document.createElement("p");
        body.className = "chat-text";
        body.textContent = entry.message || "";

        row.appendChild(meta);
        row.appendChild(body);
        chatMessagesEl.appendChild(row);
      });

      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    function clearChatMessages() {
      chatMessages = [];
      renderChatMessages();
    }

    function handleChatPayload(payload) {
      if (!payload || typeof payload !== "object") return false;

      if (payload.type === "chat_history" && Array.isArray(payload.messages)) {
        chatMessages = trimChatHistory(payload.messages);
        renderChatMessages();
        return true;
      }

      if (payload.type === "chat_message" && payload.message) {
        chatMessages = trimChatHistory([...chatMessages, payload.message]);
        renderChatMessages();
        return true;
      }

      return false;
    }

    // DOM elements
    const usernameInput = document.getElementById("usernameInput");
    const emailInput = document.getElementById("emailInput");
    const passwordInput = document.getElementById("passwordInput");
    const registerBtn = document.getElementById("registerBtn");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const currentUsernameSpan = document.getElementById("currentUsername");
    const currentUserEmailSpan = document.getElementById("currentUserEmail");

    const balanceTextSpan = document.getElementById("balanceText");
    const topupOpenBtn = document.getElementById("topupOpenBtn");
    const topupModal = document.getElementById("topupModal");
    const topupAmountInput = document.getElementById("topupAmount");
    const topupConfirmBtn = document.getElementById("topupConfirmBtn");
    const topupCancelBtn = document.getElementById("topupCancelBtn");
    const buyinModal = document.getElementById("buyinModal");
    const buyinRange = document.getElementById("buyinRange");
    const buyinRangeValue = document.getElementById("buyinRangeValue");
    const buyinAmountDisplay = document.getElementById("buyinAmountDisplay");
    const buyinSeatLabel = document.getElementById("buyinSeatLabel");
    const buyinBalanceLabel = document.getElementById("buyinBalanceLabel");
    const buyinConfirmBtn = document.getElementById("buyinConfirmBtn");
    const buyinCancelBtn = document.getElementById("buyinCancelBtn");
    const buyinError = document.getElementById("buyinError");

    const clubNameInput = document.getElementById("clubNameInput");
    const createClubBtn = document.getElementById("createClubBtn");
    const joinClubIdInput = document.getElementById("joinClubIdInput");
    const joinClubBtn = document.getElementById("joinClubBtn");
    const currentClubIdSpan = document.getElementById("currentClubId");

    const refreshTablesBtn = document.getElementById("refreshTablesBtn");
    const hideFullTablesCheckbox = document.getElementById("hideFullTables");
    const tableListEl = document.getElementById("tableList");
    const changeSeatBtn = document.getElementById("changeSeatBtn");
    const playerStatsCard = document.getElementById("playerStatsCard");
    const playerStatsName = document.getElementById("playerStatsName");
    const playerStatsMeta = document.getElementById("playerStatsMeta");
    const playerStatsGrid = document.getElementById("playerStatsGrid");
    const closePlayerStatsBtn = document.getElementById("closePlayerStats");
    const chatMessagesEl = document.getElementById("chatMessages");
    const chatEmptyEl = document.getElementById("chatEmpty");
    const chatStatusBadge = document.getElementById("chatStatus");
    const chatForm = document.getElementById("chatForm");
    const chatInput = document.getElementById("chatInput");
    const chatSendBtn = document.getElementById("chatSendBtn");
    const chatVisibilityToggle = document.getElementById("toggleChatVisibilityBtn");
    const tableArea = document.querySelector(".table-area");
    const felt = document.querySelector(".felt");

    const seatElements = document.querySelectorAll(".seat");
    let totalSeats = Math.min(seatElements.length, 9);
    let seatPositions = SEAT_LAYOUTS[totalSeats]?.positions || SEAT_LAYOUTS[9].positions;
    let viewerDisplaySeat = SEAT_LAYOUTS[totalSeats]?.viewerSeat || SEAT_LAYOUTS[9].viewerSeat;
    const actionDock = document.querySelector(".action-dock");

    const dealFlopBtn = document.getElementById("dealFlopBtn");
    const dealTurnBtn = document.getElementById("dealTurnBtn");
    const dealRiverBtn = document.getElementById("dealRiverBtn");
    const showdownBtn = document.getElementById("showdownBtn");

    const tableIdSpan = document.getElementById("tableId");
    const streetSpan = document.getElementById("street");
    const potSpan = document.getElementById("pot");
    const currentBetSpan = document.getElementById("currentBet");
    const nextToActSpan = document.getElementById("nextToAct");
    const blindsInfoSpan = document.getElementById("blindsInfo");
    const dealerSeatLabel = document.getElementById("dealerSeatLabel");
    const sbSeatLabel = document.getElementById("sbSeatLabel");
    const bbSeatLabel = document.getElementById("bbSeatLabel");
    const rawStatePre = document.getElementById("rawState");

    const boardCardsSpan = document.getElementById("boardCards");
    const potCenterSpan = document.getElementById("potCenter");
    const potChipAmount = document.getElementById("potChipAmount");
    const chipAnimationLayer = document.getElementById("chipAnimationLayer");
    const tableHeadingLabel = document.getElementById("tableHeadingLabel");
    const tableBlindsBadge = document.getElementById("tableBlindsBadge");
    const tableGameTypeBadge = document.getElementById("tableGameTypeBadge");
    const tableClosingTimer = document.getElementById("tableClosingTimer");
    const tablePanel = document.querySelector(".table-panel");
    const controlsToggleBtn = document.getElementById("controlsToggleBtn");
    const tableControlsPanel = document.getElementById("tableControlsPanel");
    const leaveTableBtn = document.getElementById("leaveTableBtn");
    const sitOutBtn = document.getElementById("sitOutBtn");
    const returnToPlayBtn = document.getElementById("returnToPlayBtn");
    const handHistoryList = document.getElementById("handHistoryList");
    const handHistoryPanel = document.querySelector(".hand-history-panel");
    const handHistoryToggleBtn = document.getElementById("handHistoryToggleBtn");
    const closeHandHistoryBtn = document.getElementById("closeHandHistoryBtn");

    if (logoutBtn) logoutBtn.disabled = true;

    updateLeaveButton();
    setChatConnected(false);
    renderChatMessages();

    // Action dock elements
    const foldMainBtn = document.getElementById("foldMainBtn");
    const callMainBtn = document.getElementById("callMainBtn");
    const callAmountLabel = document.getElementById("callAmountLabel");
    const actingPlayerLabel = document.getElementById("actingPlayerLabel");

    const raiseCustomInput = document.getElementById("raiseCustomInput");
    const raiseCustomBtn = document.getElementById("raiseCustomBtn");
    const raise30Btn = document.getElementById("raise30Btn");
    const raise50Btn = document.getElementById("raise50Btn");
    const raise100Btn = document.getElementById("raise100Btn");
    const seatActionMessage = document.getElementById("seatActionMessage");

    const seatChangeModal = document.getElementById("seatChangeModal");
    const seatChangeMessage = document.getElementById("seatChangeMessage");
    const seatChangeOptions = document.getElementById("seatChangeOptions");
    const seatChangeCancelBtn = document.getElementById("seatChangeCancelBtn");
    const seatChangeError = document.getElementById("seatChangeError");

    if (controlsToggleBtn && tableControlsPanel) {
      controlsToggleBtn.addEventListener("click", () => {
        setControlsHidden(!controlsHidden);
      });
    }

    function playTimerWarningSound() {
      try {
        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return;
        const ctx = new AudioCtx();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.value = 880;
        gain.gain.value = 0.18;
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.45);
        osc.stop(ctx.currentTime + 0.5);
      } catch (err) {
        console.warn("Timer warning sound failed", err);
      }
    }

    function clearActingTimer() {
      if (actingTimerInterval) {
        clearInterval(actingTimerInterval);
      }
      actingTimerInterval = null;
      actingTimerSeat = null;
      timerWarningFired = false;
      document.querySelectorAll(".seat-timer").forEach(bar => bar.classList.remove("active"));
      document.querySelectorAll(".seat-timer-fill").forEach(fill => {
        fill.style.width = "0%";
      });
      document.querySelectorAll(".seat.timer-warning").forEach(seat => seat.classList.remove("timer-warning"));
    }

    function startActingTimer(seatNumber, actionDeadlineSeconds) {
      clearActingTimer();
      if (seatNumber == null) return;

      const seatDiv = document.querySelector(`.seat[data-seat="${seatNumber}"]`);
      const fill = seatDiv?.querySelector(".seat-timer-fill");
      const bar = seatDiv?.querySelector(".seat-timer");
      if (!seatDiv || !fill || !bar) return;

      bar.classList.add("active");
      seatDiv.classList.remove("timer-warning");
      actingTimerSeat = seatNumber;
      timerWarningFired = false;

      const now = Date.now();
      const deadline = actionDeadlineSeconds
        ? actionDeadlineSeconds * 1000
        : now + ACTING_TIME_MS;

      const updateTimer = () => {
        const remaining = Math.max(0, deadline - Date.now());
        const pct = Math.max(0, Math.min(1, remaining / ACTING_TIME_MS));
        fill.style.width = `${pct * 100}%`;

        if (!timerWarningFired && remaining <= TIMER_WARNING_MS) {
          timerWarningFired = true;
          seatDiv.classList.add("timer-warning");
          playTimerWarningSound();
          if (seatActionMessage) {
            seatActionMessage.textContent = "Hurry! 5 seconds left to act.";
          }
        }

        if (remaining <= 0) {
          clearActingTimer();
        }
      };

      updateTimer();
      actingTimerInterval = setInterval(updateTimer, 200);
    }

    function clearTableCountdown(message = "Closing timer unavailable") {
      if (tableCountdownInterval) {
        clearInterval(tableCountdownInterval);
      }
      tableCountdownInterval = null;
      tableClosingAt = null;
      if (tableClosingTimer) {
        tableClosingTimer.textContent = message;
      }
    }

    function startTableCountdown(deadlineMs) {
      if (!tableClosingTimer || !Number.isFinite(deadlineMs)) {
        clearTableCountdown();
        return;
      }

      tableClosingAt = deadlineMs;

      const updateCountdown = () => {
        if (!tableClosingAt) return;
        const remaining = tableClosingAt - Date.now();
        if (remaining <= 0) {
          clearTableCountdown("Table closing shortly");
          return;
        }
        tableClosingTimer.textContent = `Closes in ${formatDuration(remaining)}`;
      };

      clearTableCountdown();
      updateCountdown();
      tableCountdownInterval = setInterval(updateCountdown, 1000);
    }

    // Big card popup elements
    const bigCardOverlay = document.getElementById("bigCardOverlay");
    const bigCard = document.getElementById("bigCard");
    const bigCardRank = document.getElementById("bigCardRank");
    const bigCardSuit = document.getElementById("bigCardSuit");

    function setControlsHidden(hidden) {
      controlsHidden = hidden;
      document.body.classList.toggle("controls-hidden", hidden);
      if (tableControlsPanel && controlsToggleBtn) {
        tableControlsPanel.classList.toggle("open", !hidden);
        controlsToggleBtn.textContent = hidden ? "Show controls" : "Hide controls";
        controlsToggleBtn.setAttribute("aria-expanded", hidden ? "false" : "true");
      }
    }

    function updateEngineControlsVisibility() {
      setControlsHidden(true);
    }

    if (changeSeatBtn) {
      changeSeatBtn.onclick = () => openSeatChangeModal();
    }

    if (closePlayerStatsBtn) {
      closePlayerStatsBtn.onclick = hidePlayerStats;
    }

    function setHandHistoryVisibility(show) {
      if (!handHistoryPanel) return;
      handHistoryPanel.classList.toggle("hidden", !show);

      if (handHistoryToggleBtn) {
        handHistoryToggleBtn.setAttribute("aria-expanded", show ? "true" : "false");
        handHistoryToggleBtn.textContent = show ? "Hide hand history" : "View hand history";
      }
    }

    handHistoryToggleBtn?.addEventListener("click", () => {
      const shouldShow = handHistoryPanel?.classList.contains("hidden");
      setHandHistoryVisibility(Boolean(shouldShow));
    });

    closeHandHistoryBtn?.addEventListener("click", () => setHandHistoryVisibility(false));

    document.addEventListener("keydown", evt => {
      if (evt.key === "Escape" && handHistoryPanel && !handHistoryPanel.classList.contains("hidden")) {
        setHandHistoryVisibility(false);
      }
    });

    function getCardImageFilename(card) {
      if (!card || card.length < 2) return null;

      const trimmed = card.trim();
      const suitChar = trimmed.slice(-1).toLowerCase();
      const rankPart = trimmed.slice(0, -1).toUpperCase();

      const rankMap = {
        "A": "ace",
        "K": "king",
        "Q": "queen",
        "J": "jack",
        "T": "10",
        "10": "10",
        "9": "9",
        "8": "8",
        "7": "7",
        "6": "6",
        "5": "5",
        "4": "4",
        "3": "3",
        "2": "2",
      };

      const suitMap = {
        "c": "clubs",
        "â™£": "clubs",
        "d": "diamonds",
        "â™¦": "diamonds",
        "h": "hearts",
        "â™¥": "hearts",
        "s": "spades",
        "â™ ": "spades",
      };

      const rankName = rankMap[rankPart];
      const suitName = suitMap[suitChar];

      if (!rankName || !suitName) return null;

      return `${rankName}_of_${suitName}.png`; // e.g. "queen_of_clubs.png"
    }

    function getCardImageSrc(card) {
      const filename = getCardImageFilename(card);
      if (!filename) return null;
      return `/static/cards/${filename}`;
    }

    function animateDealtCardToSeat(cardImageSrc, targetEl) {
      if (!cardImageSrc || !targetEl) return;

      const flyCard = document.createElement("img");
      flyCard.src = cardImageSrc;
      flyCard.className = "deal-fly-card";

      document.body.appendChild(flyCard);

      const startX = window.innerWidth / 2 - flyCard.width / 2;
      const startY = window.innerHeight / 2 - flyCard.height / 2;
      flyCard.style.left = `${startX}px`;
      flyCard.style.top = `${startY}px`;

      requestAnimationFrame(() => {
        const targetRect = targetEl.getBoundingClientRect();
        const destX = targetRect.left + targetRect.width / 2 - flyCard.width / 2;
        const destY = targetRect.top + targetRect.height / 2 - flyCard.height / 2;
        const translateX = destX - startX;
        const translateY = destY - startY;

        flyCard.style.opacity = "1";
        flyCard.style.transform = `translate(${translateX}px, ${translateY}px) scale(0.92)`;
      });

      flyCard.addEventListener(
        "transitionend",
        () => {
          flyCard.remove();
        },
        { once: true }
      );
    }

    function findViewerSeat(state) {
      if (!state?.players?.length) return null;

      // First try to match by the authenticated user id (authoritative)
      if (currentUserId != null) {
        const viewerById = state.players.find((p) => p.user_id === currentUserId);
        if (viewerById) return viewerById.seat ?? null;
      }

      // Fallback to email matching for legacy payloads
      if (currentUserEmail) {
        const viewerByEmail = state.players.find(
          (p) => p.email && p.email.toLowerCase() === currentUserEmail.toLowerCase()
        );
        if (viewerByEmail) return viewerByEmail.seat ?? null;
      }

      return null;
    }

    function resolveSeatLayout(size) {
      const boundedSize = Math.min(Math.max(size || seatElements.length, 2), seatElements.length || 9);
      const layout = SEAT_LAYOUTS[boundedSize] || SEAT_LAYOUTS[9] || Object.values(SEAT_LAYOUTS)[0];

      return {
        total: boundedSize,
        positions: layout?.positions || seatPositions,
        viewerSeat: layout?.viewerSeat ?? viewerDisplaySeat,
      };
    }

    function updateSeatLayoutForTable(state) {
      const maxSeatsFromState = Number(state?.max_seats ?? state?.table?.max_seats);
      const desiredSeats = Math.min(
        seatElements.length,
        Number.isFinite(maxSeatsFromState) ? maxSeatsFromState : seatElements.length
      );
      const layout = resolveSeatLayout(desiredSeats || seatElements.length || totalSeats);
      totalSeats = layout.total;
      seatPositions = layout.positions;
      viewerDisplaySeat = layout.viewerSeat;

      seatElements.forEach((seatEl, idx) => {
        seatEl.classList.toggle("hidden", idx >= totalSeats);
      });
    }

    function applySeatLayout(state) {
      const viewerSeat = findViewerSeat(state);
      const offset =
        viewerSeat !== null && viewerSeat !== undefined
          ? (viewerDisplaySeat - viewerSeat + totalSeats) % totalSeats
          : 0;

      seatElements.forEach((seatEl) => {
        const actualSeat = Number(seatEl.dataset.seat);
        const displaySeat = (actualSeat + offset + totalSeats) % totalSeats;
        const pos = seatPositions[displaySeat] || seatPositions[0];

        seatEl.dataset.displaySeat = displaySeat;
        seatEl.style.setProperty("--seat-top", pos.top);
        seatEl.style.setProperty("--seat-left", pos.left);
      });

      if (actionDock) {
        const anchorPos = seatPositions[viewerDisplaySeat] || {
          top: "82%",
          left: "50%",
        };

        actionDock.style.setProperty("--action-top", anchorPos.top);
        actionDock.style.setProperty("--action-left", anchorPos.left);
      }
    }

    function updateEmptySeatVisibility(state) {
      if (!felt) return;
      const mySeat = getViewerSeat(state);
      felt.classList.toggle("hide-empty-seats", mySeat != null);
    }

    const PLAYER_STAT_DESCRIPTIONS = {
      hands: "Hands observed at this table",
      vpip: "Voluntarily Put $ in Pot preflop",
      pfr: "Preflop raise percentage",
      threeBet: "3-bet percentage when facing a raise",
      aggression: "Postflop aggression factor",
      cbet: "Continuation bet frequency",
      foldToCbet: "Fold to flop/turn c-bets",
      wtsd: "Went to showdown",
      wsd: "Won at showdown",
      steal: "Steal attempts from late position",
    };

    function derivePlayerStats(player) {
      return {
        hands: 0,
        vpip: 0,
        pfr: 0,
        threeBet: 0,
        aggression: 0,
        cbet: 0,
        foldToCbet: 0,
        wtsd: 0,
        wsd: 0,
        steal: 0,
      };
    }

    function computePlayerStatsFromHistory(state) {
      const statsBySeat = {};
      const hands = Array.isArray(state?.recent_hands) ? state.recent_hands : [];

      hands.forEach(hand => {
        const actions = Array.isArray(hand?.actions) ? hand.actions : [];
        const seatsInHand = new Set(actions.map(a => a?.seat).filter(seat => seat !== null && seat !== undefined));

        seatsInHand.forEach(seat => {
          statsBySeat[seat] ||= {
            hands: 0,
            vpip: 0,
            pfr: 0,
            threeBet: 0,
            aggressionActs: 0,
            aggressionCalls: 0,
            cbet: 0,
            cbetOpportunities: 0,
            foldToCbet: 0,
            wtsd: 0,
            wsd: 0,
            steal: 0,
          };
          statsBySeat[seat].hands += 1;
        });

        const preflopActions = actions.filter(a => a?.type === "action" && a.street === "preflop");
        let preflopRaiseCount = 0;

        preflopActions.forEach(a => {
          const seat = a.seat;
          if (seat === null || seat === undefined || !statsBySeat[seat]) return;

          const action = a.action;
          const isBlind = action === "small_blind" || action === "big_blind" || action === "bomb_pot";

          if (!isBlind && (action === "call" || action === "raise_to" || action === "bet")) {
            statsBySeat[seat].vpip += 1;
          }

          if (action === "raise_to") {
            statsBySeat[seat].pfr += 1;
            if (preflopRaiseCount >= 1) statsBySeat[seat].threeBet += 1;
            preflopRaiseCount += 1;
          }
        });

        const preflopAggressorSeat = preflopActions.find(a => a.action === "raise_to")?.seat ?? null;
        let cbetRecorded = false;

        const postflopActions = actions.filter(
          a => a?.type === "action" && (a.street === "flop" || a.street === "turn" || a.street === "river")
        );

        postflopActions.forEach(a => {
          const seat = a.seat;
          if (seat === null || seat === undefined || !statsBySeat[seat]) return;

          const action = a.action;
          if (action === "bet" || action === "raise_to") {
            statsBySeat[seat].aggressionActs += 1;

            if (!cbetRecorded && preflopAggressorSeat != null && a.street === "flop" && seat === preflopAggressorSeat) {
              statsBySeat[seat].cbet += 1;
              cbetRecorded = true;
              seatsInHand.forEach(otherSeat => {
                if (otherSeat !== seat) statsBySeat[otherSeat].cbetOpportunities += 1;
              });
            }
          } else if (action === "call") {
            statsBySeat[seat].aggressionCalls += 1;
          } else if (action === "fold" && cbetRecorded) {
            statsBySeat[seat].foldToCbet += 1;
          }
        });
      });

      const finalStats = {};
      Object.entries(statsBySeat).forEach(([seat, data]) => {
        const handsCount = data.hands || 0;
        const aggressionDenom = data.aggressionCalls || 0;
        const aggressionRatio =
          aggressionDenom > 0
            ? data.aggressionActs / aggressionDenom
            : data.aggressionActs > 0
              ? data.aggressionActs
              : 0;

        finalStats[seat] = {
          hands: handsCount,
          vpip: handsCount ? Math.round((data.vpip / handsCount) * 100) : 0,
          pfr: handsCount ? Math.round((data.pfr / handsCount) * 100) : 0,
          threeBet: handsCount ? Math.round((data.threeBet / handsCount) * 100) : 0,
          aggression: Number.isFinite(aggressionRatio) ? Number(aggressionRatio.toFixed(1)) : 0,
          cbet: handsCount ? Math.round((data.cbet / handsCount) * 100) : 0,
          foldToCbet: data.cbetOpportunities ? Math.round((data.foldToCbet / data.cbetOpportunities) * 100) : 0,
          wtsd: 0,
          wsd: 0,
          steal: 0,
        };
      });

      return finalStats;
    }

    function hidePlayerStats() {
      if (playerStatsCard) playerStatsCard.classList.add("hidden");
      if (playerStatsGrid) playerStatsGrid.innerHTML = "";
      openStatsSeat = null;
      openStatsPlayerId = null;
      seatElements.forEach(seat => seat.classList.remove("stats-highlight"));
    }

    function renderPlayerStats(player, seatEl) {
      if (!playerStatsCard || !playerStatsGrid || !playerStatsName || !playerStatsMeta) return;

      const stats = player.stats || derivePlayerStats(player);
      const rows = [
        { key: "hands", label: "Hands", value: `${stats.hands}`, help: PLAYER_STAT_DESCRIPTIONS.hands },
        { key: "vpip", label: "VPIP", value: `${stats.vpip}%`, help: PLAYER_STAT_DESCRIPTIONS.vpip },
        { key: "pfr", label: "PFR", value: `${stats.pfr}%`, help: PLAYER_STAT_DESCRIPTIONS.pfr },
        { key: "threeBet", label: "3-Bet", value: `${stats.threeBet}%`, help: PLAYER_STAT_DESCRIPTIONS.threeBet },
        { key: "aggression", label: "Agg", value: stats.aggression, help: PLAYER_STAT_DESCRIPTIONS.aggression },
        { key: "cbet", label: "C-Bet", value: `${stats.cbet}%`, help: PLAYER_STAT_DESCRIPTIONS.cbet },
        { key: "foldToCbet", label: "Fold vs C-Bet", value: `${stats.foldToCbet}%`, help: PLAYER_STAT_DESCRIPTIONS.foldToCbet },
        { key: "wtsd", label: "WTSD", value: `${stats.wtsd}%`, help: PLAYER_STAT_DESCRIPTIONS.wtsd },
        { key: "wsd", label: "W$SD", value: `${stats.wsd}%`, help: PLAYER_STAT_DESCRIPTIONS.wsd },
        { key: "steal", label: "Steal", value: `${stats.steal}%`, help: PLAYER_STAT_DESCRIPTIONS.steal },
      ];

      playerStatsGrid.innerHTML = "";
      const hasHands = Number(stats?.hands ?? 0) > 0;

      if (!hasHands) {
        const emptyMessage = document.createElement("div");
        emptyMessage.className = "player-stat-empty";
        emptyMessage.textContent = "No stats yet. Play a hand to see your numbers.";
        playerStatsGrid.appendChild(emptyMessage);
      } else {
        rows.forEach(row => {
          const tile = document.createElement("div");
          tile.className = "player-stat-tile";

          const label = document.createElement("div");
          label.className = "player-stat-label";
          label.textContent = row.label;

          const value = document.createElement("div");
          value.className = "player-stat-value";
          value.textContent = row.value;

          const help = document.createElement("div");
          help.className = "player-stat-help";
          help.textContent = row.help;

          tile.appendChild(label);
          tile.appendChild(value);
          tile.appendChild(help);
          playerStatsGrid.appendChild(tile);
        });
      }

      playerStatsName.textContent = player.name || `Seat ${player.seat}`;
      playerStatsMeta.textContent = `Seat ${player.seat} â€¢ Stack ${player.stack}`;
      playerStatsCard.classList.remove("hidden");

      seatElements.forEach(seat => seat.classList.remove("stats-highlight"));
      if (seatEl) seatEl.classList.add("stats-highlight");

      openStatsSeat = player.seat;
      openStatsPlayerId = player.user_id ?? player.id ?? null;
    }

    function persistAuth() {
      if (!accessToken || !currentUserEmail) return;
      try {
        localStorage.setItem("poker_token", accessToken);
        localStorage.setItem(
          AUTH_STORAGE_KEY,
          JSON.stringify({ token: accessToken, email: currentUserEmail, username: currentUsername })
        );
      } catch (err) {
        console.warn("Failed to persist auth", err);
      }
    }

    function restoreAuth() {
      try {
        const raw = localStorage.getItem(AUTH_STORAGE_KEY);
        const parsed = raw ? JSON.parse(raw) : null;
        const storedToken = parsed?.token || localStorage.getItem("poker_token");
        const storedEmail = parsed?.email;
        const storedUsername = parsed?.username;

        if (!storedToken || !storedEmail) return;

        accessToken = storedToken;
        currentUserEmail = storedEmail;
        currentUsername = storedUsername || null;
        if (currentUsernameSpan && currentUsername) {
          currentUsernameSpan.textContent = currentUsername;
        }
        if (currentUserEmailSpan) {
          currentUserEmailSpan.textContent = storedEmail;
          currentUserEmailSpan.style.display = "inline";
        }
        if (emailInput) emailInput.value = storedEmail;
        if (usernameInput && currentUsername) usernameInput.value = currentUsername;
        setAuthEnabled(true);
        fetchMe();
      } catch (err) {
        console.warn("Failed to restore auth", err);
      }
    }

    function setAuthEnabled(enabled) {
      if (createClubBtn) createClubBtn.disabled = !enabled;
      if (joinClubBtn) joinClubBtn.disabled = !enabled;
      if (topupOpenBtn) topupOpenBtn.disabled = !enabled;
      if (refreshTablesBtn) refreshTablesBtn.disabled = !enabled;
      if (logoutBtn) logoutBtn.disabled = !enabled;
    }

    async function api(path, options = {}) {
      const headers = {
        "Content-Type": "application/json",
        ...(options.headers || {}),
      };
      if (accessToken) {
        headers["Authorization"] = `Bearer ${accessToken}`;
      }

      const res = await fetch(API_BASE + path, {
        ...options,
        headers,
      });
      if (res.status === 401) {
        console.warn("Auth expired; clearing stored token");
        localStorage.removeItem(AUTH_STORAGE_KEY);
      }
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`Error ${res.status}: ${text}`);
      }
      return res.json();
    }

    function formatTableName(table) {
      if (!table) return "Table";
      const customName = (table.table_name || "").trim();
      if (customName) return customName;
      if (table.id != null) return `Table #${table.id}`;
      return "Table";
    }

    function renderTableList(tables) {
      if (!tableListEl) return;
      tableListEl.innerHTML = "";

      if (!tables.length) {
        tableListEl.innerHTML = '<div class="table-empty">No tables open right now, but you can open them within the club management area.</div>';
        return;
      }

      tables.forEach((tbl) => {
        const card = document.createElement("div");
        card.className = "table-card";

        const title = document.createElement("div");
        title.className = "table-title";
        title.textContent = formatTableName(tbl);

        const meta = document.createElement("div");
        meta.className = "table-meta";
        meta.textContent = `Blinds ${tbl.small_blind}/${tbl.big_blind} â€¢ Club ${tbl.club_id}`;

        const left = document.createElement("div");
        left.appendChild(title);
        left.appendChild(meta);

        const seats = document.createElement("div");
        seats.className = "seat-pill";
        const seatsLabel = (tbl.playersCount ?? null) !== null
          ? `${tbl.playersCount}/${tbl.max_seats}`
          : `${tbl.max_seats} seats`;
        seats.textContent = seatsLabel;

        const joinBtn = document.createElement("button");
        joinBtn.textContent = "Join";
        joinBtn.onclick = () => joinTableById(tbl.id);

        const seatWrap = document.createElement("div");
        seatWrap.className = "table-seats";
        seatWrap.appendChild(seats);
        seatWrap.appendChild(joinBtn);

        const mainRow = document.createElement("div");
        mainRow.className = "table-card-main";
        mainRow.appendChild(left);
        mainRow.appendChild(seatWrap);

        const tags = document.createElement("div");
        tags.className = "table-tags";
        const statusTag = document.createElement("span");
        statusTag.className = "tag-chip success";
        statusTag.textContent = tbl.status ? tbl.status.toUpperCase() : "ACTIVE";
        const seatsTag = document.createElement("span");
        seatsTag.className = "tag-chip";
        seatsTag.textContent = `${tbl.max_seats}-max table`;
        tags.appendChild(statusTag);
        tags.appendChild(seatsTag);

        card.appendChild(mainRow);
        card.appendChild(tags);
        tableListEl.appendChild(card);
      });
    }

    async function loadTableList() {
      if (!tableListEl) return;
      if (!accessToken) {
        tableListEl.innerHTML = '<div class="table-empty">Log in to see tables available to your clubs.</div>';
        return;
      }

      tableListEl.innerHTML = '<div class="table-empty">Loading tables...</div>';
      try {
        const tables = await api("/tables/", { method: "GET" });
        const hideFull = hideFullTablesCheckbox?.checked;
        const enriched = [];

        for (const tbl of tables) {
          let playersCount = null;
          try {
            const state = await api(`/tables/${tbl.id}`, { method: "GET" });
            if (Array.isArray(state.players)) {
              playersCount = state.players.length;
            }
          } catch (err) {
            console.warn("Failed to load table state", err);
          }

          if (hideFull && playersCount !== null && playersCount >= tbl.max_seats) {
            continue;
          }

          enriched.push({ ...tbl, playersCount });
        }

        renderTableList(enriched);
      } catch (e) {
        tableListEl.innerHTML = `<div class="table-empty">${e.message}</div>`;
      }
    }

    function clearSeats() {
      const seats = document.querySelectorAll(".seat");
      seats.forEach(seat => {
        seat.classList.add("empty");
        seat.classList.remove("highlight", "sitting-out", "timer-warning", "opponent-view");

        const nameEl = seat.querySelector(".seat-name");
        const stackEl = seat.querySelector(".seat-stack");
        const statusEl = seat.querySelector(".seat-status");
        const betEl = seat.querySelector(".seat-bet");
        const avatarInitialEl = seat.querySelector(".seat-avatar-initial");
        const avatarImgEl = seat.querySelector(".seat-avatar-img");
        const avatarBox = seat.querySelector(".seat-avatar");
        const cardsEl = seat.querySelector(".seat-cards");

        if (nameEl) nameEl.textContent = "Empty";
        if (stackEl) stackEl.textContent = "";
        if (statusEl) statusEl.textContent = "Click to sit";
        if (betEl) betEl.textContent = "";
        if (avatarInitialEl) avatarInitialEl.textContent = "?";
        if (avatarImgEl) avatarImgEl.src = "";
        if (avatarBox) avatarBox.classList.remove("has-image");
        if (cardsEl) cardsEl.innerHTML = "";
      });
    }

    function updateBuyinDisplay(amount) {
      if (!buyinRange || !buyinRangeValue || !buyinAmountDisplay) return;
      const formatted = formatChips(amount);
      buyinRangeValue.textContent = formatted;
      buyinAmountDisplay.textContent = `${formatted} chips`;
    }

    function showBuyinModal(seatIndex) {
      if (!buyinModal || !buyinRange) return;

      pendingSeatIndex = seatIndex;

      if (buyinError) buyinError.textContent = "";

      const maxBuyIn = Math.max(1, Math.floor(currentUserBalance));
      const suggestedBuyIn = Math.min(currentUserBalance, 100) || maxBuyIn;
      const initialBuyIn = Math.min(Math.max(1, Math.floor(suggestedBuyIn)), maxBuyIn);

      buyinRange.min = "1";
      buyinRange.max = String(maxBuyIn);
      buyinRange.value = String(initialBuyIn);

      if (buyinSeatLabel) buyinSeatLabel.textContent = `Seat ${seatIndex}`;
      if (buyinBalanceLabel) buyinBalanceLabel.textContent = `Wallet balance: ${formatChips(currentUserBalance)}`;

      updateBuyinDisplay(initialBuyIn);
      buyinModal.classList.remove("hidden");
    }

    function hideBuyinModal() {
      if (!buyinModal) return;
      pendingSeatIndex = null;
      buyinModal.classList.add("hidden");
    }

    async function handleSeatClick(seatEl) {
      if (!accessToken) {
        alert("Login first");
        return;
      }

      if (!tableId) {
        alert("Create or join a table first");
        return;
      }

      const seatIndex = Number(seatEl.dataset.seat);
      const mySeat = getViewerSeat(lastState);

      if (!seatEl.classList.contains("empty")) {
        const player = lastState?.players?.find(p => p.seat === seatIndex);
        if (player) {
          renderPlayerStats(player, seatEl);
        }
        return;
      }

      if (mySeat != null) {
        attemptSeatChange(seatIndex);
        return;
      }

      if (currentUserBalance <= 0) {
        alert("You need chips in your wallet to sit down. Top up first.");
        return;
      }

      showBuyinModal(seatIndex);
    }

    async function submitBuyin() {
      if (pendingSeatIndex === null || !buyinRange) return;

      const buyIn = Number(buyinRange.value);

      if (!Number.isFinite(buyIn) || buyIn <= 0) {
        alert("Enter a positive buy-in amount");
        return;
      }

      if (buyIn > currentUserBalance) {
        alert("Buy-in cannot exceed your wallet balance");
        return;
      }

      try {
        await api(`/tables/${tableId}/sit_me`, {
          method: "POST",
          body: JSON.stringify({ seat: pendingSeatIndex, buy_in: buyIn }),
        });
        await fetchMe();

        // Immediately refresh the table view in case the WebSocket hasn't delivered an update yet
        // (e.g. if the connection dropped). This keeps the seat state in sync with the backend
        // and avoids repeated "already seated" errors.
        try {
          const state = await api(`/tables/${tableId}`, { method: "GET" });
          renderStateWithPacing(state);
        } catch (fetchErr) {
          console.warn("Failed to refresh table after sitting:", fetchErr);
        }

        hideBuyinModal();
      } catch (e) {
        if (buyinError) {
          buyinError.textContent = e.message || "Unable to take a seat.";
        } else {
          alert(e.message);
        }
      }
    }

    seatElements.forEach(seat => {
      seat.addEventListener("click", () => handleSeatClick(seat));
    });


    function updateBalanceUI(amount) {
      currentUserBalance = amount || 0;
      if (balanceTextSpan) {
        balanceTextSpan.textContent = formatChips(currentUserBalance);
      }
    }

    async function fetchMe() {
      try {
        const me = await api(`/me?email=${encodeURIComponent(currentUserEmail)}`, {
          method: "GET",
        });
        // assumes backend returns { username, email, balance, current_club_id }
        if (me.username) {
          currentUsername = me.username;
          if (currentUsernameSpan) currentUsernameSpan.textContent = me.username;
        }
        if (typeof me.id === "number") {
          currentUserId = me.id;
        }
        if (me.email) {
          currentUserEmail = me.email;
          currentUserEmailSpan.textContent = me.email;
          currentUserEmailSpan.style.display = "inline";
        }
        if (typeof me.balance === "number") {
          updateBalanceUI(me.balance);
        }
        currentClubId = me.current_club_id || null;
        currentClubIdSpan.textContent = currentClubId ? String(currentClubId) : "None";
        loadTableList();
        updateEngineControlsVisibility();
        if (topupOpenBtn) topupOpenBtn.disabled = false;
        persistAuth();
      } catch (e) {
        console.warn("Failed to load /me:", e);
      }
    }

    async function sendAction(playerId, action, amount = null) {
      if (!tableId || !playerId) return;
      try {
        await api(`/tables/${tableId}/action`, {
          method: "POST",
          body: JSON.stringify({
            player_id: playerId,
            action: action,
            amount: amount,
          }),
        });
      } catch (e) {
        alert(e.message);
      }
    }

    function animateChipsFromSeat(seatNumber, amount, isRaise = false, isViewer = false, playerName = "Player") {
      if (!chipAnimationLayer) return;
      const seatDiv = document.querySelector(`.seat[data-seat="${seatNumber}"]`);
      if (!seatDiv) return;

      const layerRect = chipAnimationLayer.getBoundingClientRect();
      const seatRect = seatDiv.getBoundingClientRect();

      const startX = seatRect.left + seatRect.width / 2 - layerRect.left;
      const startY = seatRect.top + seatRect.height * 0.2 - layerRect.top;
      const endX = layerRect.width / 2;
      const endY = layerRect.height / 2;

      const chipEl = document.createElement("div");
      chipEl.className = "chip-flight";
      chipEl.style.setProperty("--start-x", `${startX}px`);
      chipEl.style.setProperty("--start-y", `${startY}px`);
      chipEl.style.setProperty("--dx", `${endX - startX}px`);
      chipEl.style.setProperty("--dy", `${endY - startY}px`);
      chipEl.innerHTML = `
        <div class="chip-flight-stack"></div>
        <div class="chip-flight-amount">${isViewer ? "You" : playerName} ${isRaise ? "raise" : "call"} ${amount}</div>
      `;

      chipAnimationLayer.appendChild(chipEl);
      chipEl.addEventListener("animationend", () => chipEl.remove());
    }

    function detectNewBets(prevState, currentState) {
      if (!prevState) return;
      const prevCurrentBet = prevState.current_bet || 0;
      const currentBet = currentState.current_bet || 0;

      currentState.players.forEach(player => {
        const prevPlayer = prevState.players?.find(p => p.seat === player.seat);
        if (!prevPlayer) return;

        const prevCommitted = prevPlayer.committed || 0;
        const newCommitted = player.committed || 0;
        const diff = newCommitted - prevCommitted;
        if (diff <= 0) return;

        const isRaise = currentBet > prevCurrentBet && newCommitted >= currentBet;
        const isViewer = player.user_id === currentUserId;
        animateChipsFromSeat(player.seat, diff, isRaise, isViewer, player.name || "Player");
      });
    }

    function showBigCard(card) {
      if (!bigCardOverlay || !bigCard || !card) return;

      const rank = card[0];
      const suitChar = card[1] ? card[1].toLowerCase() : null;
      const suitMap = { s: "â™ ", h: "â™¥", d: "â™¦", c: "â™£" };

      bigCardRank.textContent = rank ? rank.toUpperCase() : "?";
      bigCardSuit.textContent = suitMap[suitChar] || "?";

      bigCard.classList.remove("red", "black");
      if (suitChar === "h" || suitChar === "d") {
        bigCard.classList.add("red");
      } else {
        bigCard.classList.add("black");
      }

      bigCardOverlay.classList.add("show");
      bigCard.classList.remove("animate");
      void bigCard.offsetWidth; // restart animation
      bigCard.classList.add("animate");

      setTimeout(() => {
        bigCardOverlay.classList.remove("show");
      }, 600);
    }

    function updateActionDock(state) {
      const pot = state.pot || 0;
      const currentBet = state.current_bet || 0;
      actingPlayer = null;

      if (actionDock) {
        actionDock.classList.remove("visible");
      }

      if (state.next_to_act_seat === null || state.next_to_act_seat === undefined) {
        actingPlayerLabel.textContent = "None";
        callMainBtn.disabled = true;
        foldMainBtn.disabled = true;
        raiseCustomBtn.disabled = true;
        raise30Btn.disabled = true;
        raise50Btn.disabled = true;
        raise100Btn.disabled = true;
        callAmountLabel.textContent = "0";
        return;
      }

      actingPlayer = state.players.find(p => p.seat === state.next_to_act_seat);
      if (!actingPlayer) {
        actingPlayerLabel.textContent = "None";
        callMainBtn.disabled = true;
        foldMainBtn.disabled = true;
        raiseCustomBtn.disabled = true;
        raise30Btn.disabled = true;
        raise50Btn.disabled = true;
        raise100Btn.disabled = true;
        callAmountLabel.textContent = "0";
        return;
      }

      actingPlayerLabel.textContent = `${actingPlayer.name} (seat ${actingPlayer.seat})`;

      const toCall = Math.max(0, currentBet - actingPlayer.committed);
      const viewerSeat = getViewerSeat(state);
      const isViewerTurn = viewerSeat != null && actingPlayer.user_id === currentUserId;
      const shouldShowDock =
        isViewerTurn && !actingPlayer.has_folded && actingPlayer.in_hand !== false && !actingPlayer.sitting_out;

      if (actionDock) {
        actionDock.classList.toggle("visible", shouldShowDock);
      }

      callAmountLabel.textContent = toCall > 0 ? toCall.toString() : "0 (check)";
      callMainBtn.disabled = !isViewerTurn;
      foldMainBtn.disabled = !isViewerTurn;

      const canRaise = isViewerTurn && !actingPlayer.all_in && !actingPlayer.has_folded;
      raiseCustomBtn.disabled = !canRaise;
      raise30Btn.disabled = !canRaise || pot <= 0;
      raise50Btn.disabled = !canRaise || pot <= 0;
      raise100Btn.disabled = !canRaise || pot <= 0;

      callMainBtn.onclick = () => sendAction(actingPlayer.id, "call");
      foldMainBtn.onclick = () => sendAction(actingPlayer.id, "fold");

      raiseCustomBtn.onclick = () => {
        const amt = Number(raiseCustomInput.value);
        if (!amt || amt <= currentBet) {
          alert("Raise must be > current bet");
          return;
        }
        sendAction(actingPlayer.id, "raise_to", amt);
      };

      const makePctHandler = fraction => () => {
        const basePot = pot > 0 ? pot : currentBet;
        let amt = Math.floor(basePot * fraction);
        if (amt <= currentBet) {
          amt = currentBet + 1;
        }
        raiseCustomInput.value = amt.toString();
        raiseCustomInput.focus();
      };

      raise30Btn.onclick = makePctHandler(0.3);
      raise50Btn.onclick = makePctHandler(0.5);
      raise100Btn.onclick = makePctHandler(1.0);
    }

    function createMiniCard(card) {
      const span = document.createElement("span");
      span.className = "card";
      const imgSrc = getCardImageSrc(card);
      if (imgSrc) {
        span.innerHTML = `<img class="card-img" src="${imgSrc}" alt="${card}">`;
      } else {
        span.textContent = card;
      }
      return span;
    }

    function renderHistoryBoard(container, cards) {
      if (!cards || !cards.length) return;
      const boardRow = document.createElement("div");
      boardRow.className = "board-small";
      cards.forEach(card => boardRow.appendChild(createMiniCard(card)));
      container.appendChild(boardRow);
    }

    function renderHandHistory(hands = []) {
      if (!handHistoryList) return;

      handHistoryList.innerHTML = "";
      if (!hands.length) {
        handHistoryList.innerHTML = '<div class="empty-history">No completed hands yet.</div>';
        return;
      }

      const ordered = [...hands].slice(-50).reverse();
      const streetOrder = ["preflop", "flop", "turn", "river"];

      ordered.forEach(hand => {
        const card = document.createElement("div");
        card.className = "hand-history-card";

        const header = document.createElement("div");
        header.className = "hand-history-top";
        const left = document.createElement("div");
        left.innerHTML = `<div class="hand-label">Hand #${hand.hand_number}</div>`;
        if (hand.board?.length) {
          renderHistoryBoard(left, hand.board);
        }

        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.gap = "8px";
        right.style.alignItems = "center";
        if (hand.result?.pot != null) {
          const potPill = document.createElement("div");
          potPill.className = "hand-result-pill";
          potPill.textContent = `Pot ${formatChips(hand.result.pot)}`;
          right.appendChild(potPill);
        }
        if (hand.result?.reason) {
          const reason = document.createElement("div");
          reason.className = "hand-history-sub";
          reason.textContent = hand.result.reason.replace("_", " ");
          right.appendChild(reason);
        }

        header.appendChild(left);
        header.appendChild(right);
        card.appendChild(header);

        const grid = document.createElement("div");
        grid.className = "hand-history-grid";

        streetOrder.forEach(street => {
          const column = document.createElement("div");
          column.className = "history-column";
          const title = document.createElement("h4");
          title.textContent = street;
          column.appendChild(title);

          const boardEvent = (hand.actions || []).find(a => a.type === "street" && a.street === street);
          if (boardEvent?.board?.length) {
            const boardLabel = document.createElement("div");
            boardLabel.className = "street-board-label";
            boardLabel.textContent = "Board";
            renderHistoryBoard(boardLabel, boardEvent.board);
            column.appendChild(boardLabel);
          }

          const streetActions = (hand.actions || []).filter(
            a => a.type === "action" && a.street === street
          );

          if (!streetActions.length) {
            const empty = document.createElement("div");
            empty.className = "history-action";
            empty.textContent = "No actions";
            column.appendChild(empty);
          } else {
            streetActions.forEach(a => {
              const row = document.createElement("div");
              row.className = "history-entry";

              const info = document.createElement("div");
              info.innerHTML = `<div class="history-player">${a.player_name || "Player"}</div><div class="history-action">${a.action}${a.auto ? " (auto)" : ""}</div>`;

              const amt = document.createElement("div");
              amt.className = "history-amount";
              amt.textContent = a.amount != null ? formatChips(a.amount) : "";

              row.appendChild(info);
              row.appendChild(amt);
              column.appendChild(row);
            });
          }

          grid.appendChild(column);
        });

        const resultCol = document.createElement("div");
        resultCol.className = "history-column";
        const resultTitle = document.createElement("h4");
        resultTitle.textContent = "Result";
        resultCol.appendChild(resultTitle);

        if (hand.result?.winners?.length) {
          hand.result.winners.forEach(w => {
            const chip = document.createElement("div");
            chip.className = "winner-chip";
            chip.innerHTML = `<strong>${w.player_name || "Winner"}</strong> +${formatChips(w.amount)}`;
            resultCol.appendChild(chip);
          });
        } else {
          const none = document.createElement("div");
          none.className = "history-action";
          none.textContent = "No result yet";
          resultCol.appendChild(none);
        }

        grid.appendChild(resultCol);
        card.appendChild(grid);
        handHistoryList.appendChild(card);
      });
    }

    function renderStateWithPacing(state, { immediate = false } = {}) {
      // Avoid delaying the very first render to prevent a blank screen on load.
      if (immediate || !lastState) {
        if (renderStateTimer) {
          clearTimeout(renderStateTimer);
          renderStateTimer = null;
          pendingRenderState = null;
        }
        renderState(state);
        return;
      }

      const isNewHand = lastState?.hand_number !== state.hand_number;
      const delay = STATE_RENDER_BASE_DELAY_MS + (isNewHand ? HAND_START_EXTRA_DELAY_MS : 0);

      pendingRenderState = state;
      if (renderStateTimer) {
        clearTimeout(renderStateTimer);
      }

      renderStateTimer = setTimeout(() => {
        renderStateTimer = null;
        if (pendingRenderState) {
          renderState(pendingRenderState);
          pendingRenderState = null;
        }
      }, delay);
    }

    function renderState(state) {
      const prevState = lastState;
      lastState = state;

      const computedStatsBySeat = computePlayerStatsFromHistory(state);
      if (Array.isArray(state.players)) {
        state.players = state.players.map(player => ({
          ...player,
          stats: computedStatsBySeat[player.seat] || player.stats || derivePlayerStats(player),
        }));
      }

      updateSeatLayoutForTable(state);

      const nextSeatChanged = prevState?.next_to_act_seat !== state.next_to_act_seat;
      const deadlineChanged = prevState?.action_deadline !== state.action_deadline;
      if (nextSeatChanged || deadlineChanged) {
        if (state.next_to_act_seat == null) {
          clearActingTimer();
        } else {
          startActingTimer(state.next_to_act_seat, state.action_deadline);
        }
      }

      applySeatLayout(state);
      updateEmptySeatVisibility(state);

      tableIdSpan.textContent = state.id;
      const headingText = formatTableName({
        id: state.id,
        table_name: state.table_name || currentTableName,
      });
      if (tableHeadingLabel) tableHeadingLabel.textContent = headingText;
      currentTableName = state.table_name || currentTableName;
      if (tableBlindsBadge) {
        tableBlindsBadge.textContent = `Blinds ${formatChips(state.small_blind)}/${formatChips(state.big_blind)}`;
      }
      if (tableGameTypeBadge) {
        tableGameTypeBadge.textContent = (state.game_type || "NLH").toUpperCase();
      }
      if (tablePanel) {
        tablePanel.classList.toggle("plo", state.game_type === "plo");
      }
      streetSpan.textContent = state.street;
      potSpan.textContent = formatChips(state.pot);
      currentBetSpan.textContent = formatChips(state.current_bet);
      nextToActSpan.textContent = state.next_to_act_seat ?? "-";
      blindsInfoSpan.textContent = `${formatChips(state.small_blind)}/${formatChips(state.big_blind)}`;
      dealerSeatLabel.textContent = state.dealer_button_seat ?? "-";
      sbSeatLabel.textContent = state.small_blind_seat ?? "-";
      bbSeatLabel.textContent = state.big_blind_seat ?? "-";
      console.log("STATE PLAYERS:", state.players);

      potCenterSpan.textContent = formatChips(state.pot);
      if (potChipAmount) {
        potChipAmount.textContent = formatChips(state.pot ?? 0);
      }

      // ---- BOARD CARDS ----
      const prevBoardLen = prevState ? prevState.board.length : 0;
      boardCardsSpan.innerHTML = "";
      state.board.forEach((c, idx) => {
      const span = document.createElement("span");
      span.className = "card";
      if (idx >= prevBoardLen) {
        span.classList.add("dealt");
        showBigCard(c);
      }

      const imgSrc = getCardImageSrc(c);
      if (imgSrc) {
        span.innerHTML = `<img class="card-img" src="${imgSrc}" alt="${c}">`;
      } else {
        // fallback to text if mapping fails
        span.textContent = c;
      }

      boardCardsSpan.appendChild(span);
    });


      // ---- SEATS & HOLE CARDS ----
      clearSeats();

      state.players.forEach(p => {
        const seatDiv = document.querySelector(`.seat[data-seat="${p.seat}"]`);
        if (!seatDiv) {
          console.warn("No seat div for seat", p.seat);
          return;
        }

        seatDiv.classList.remove("empty");
        seatDiv.classList.toggle("sitting-out", Boolean(p.sitting_out));
        const isViewer = currentUserId != null && p.user_id === currentUserId;
        seatDiv.classList.toggle("opponent-view", !isViewer);

        const nameEl = seatDiv.querySelector(".seat-name");
        const stackEl = seatDiv.querySelector(".seat-stack");
        const statusEl = seatDiv.querySelector(".seat-status");
        const betEl = seatDiv.querySelector(".seat-bet");
        const avatarInitialEl = seatDiv.querySelector(".seat-avatar-initial");
        const avatarImgEl = seatDiv.querySelector(".seat-avatar-img");
        const avatarBox = seatDiv.querySelector(".seat-avatar");
        const cardsEl = seatDiv.querySelector(".seat-cards");
        const dealerChip = seatDiv.querySelector(".dealer-chip");
        const sbChip = seatDiv.querySelector(".sb-chip");
        const bbChip = seatDiv.querySelector(".bb-chip");

        // Name + stack
        if (nameEl) nameEl.textContent = p.name || `Seat ${p.seat}`;
        if (stackEl) stackEl.textContent = formatChips(p.stack);

        // Avatar initial (first letter)
        if (avatarInitialEl) {
          const initialSource = p.name || p.email || "?";
          avatarInitialEl.textContent = initialSource.trim().charAt(0).toUpperCase() || "?";
        }

        if (avatarImgEl && avatarBox) {
          avatarBox.classList.remove("has-image");
          avatarImgEl.src = "";
          avatarImgEl.onerror = () => {
            avatarBox.classList.remove("has-image");
          };

          if (p.profile_picture_url) {
            avatarImgEl.src = p.profile_picture_url;
            avatarBox.classList.add("has-image");
          }
        }

        // Status
        if (statusEl) {
          if (p.sitting_out) {
            statusEl.textContent = "Sitting out";
          } else if (p.has_folded) {
            statusEl.textContent = "Folded";
          } else if (p.all_in) {
            statusEl.textContent = "All-in";
          } else if (!p.in_hand) {
            statusEl.textContent = "Sitting out";
          } else {
            statusEl.textContent = "In hand";
          }
        }

        // Bet
        if (betEl) {
          if (p.committed > 0) {
            betEl.innerHTML = `<div class="chip-pile muted"><span class="chip-amount-label">Bet ${formatChips(p.committed)}</span></div>`;
          } else {
            betEl.textContent = "";
          }
        }

        const isDealer = state.dealer_button_seat === p.seat;
        const isSB = state.small_blind_seat === p.seat;
        const isBB = state.big_blind_seat === p.seat;

        if (dealerChip) dealerChip.classList.toggle("hidden", !isDealer);
        if (sbChip) sbChip.classList.toggle("hidden", !isSB);
        if (bbChip) bbChip.classList.toggle("hidden", !isBB);

        // Cards
        if (cardsEl) {
          const prevPlayer = prevState?.players?.find(pp => pp.seat === p.seat);
          const prevCards = prevPlayer?.hole_cards || [];
          cardsEl.innerHTML = "";

          if (isViewer) {
            p.hole_cards.forEach((c, idx) => {
              const span = document.createElement("span");
              span.className = "seat-card";
              const imgSrc = getCardImageSrc(c);
              if (imgSrc) {
                span.innerHTML = `<img class="card-img" src="${imgSrc}" alt="${c}">`;
              } else {
                span.textContent = c;
              }
              cardsEl.appendChild(span);

              const isNewCard = idx >= prevCards.length || prevCards[idx] !== p.hole_cards[idx];
              if (isNewCard && imgSrc) {
                span.classList.add("dealt");
                animateDealtCardToSeat(imgSrc, span.querySelector("img") || span);
              }
            });
          }
        }

        const timerBar = seatDiv.querySelector(".seat-timer");
        const timerFill = seatDiv.querySelector(".seat-timer-fill");
        const isActingSeat = state.next_to_act_seat === p.seat;

        if (timerBar) {
          const timerShouldShow = !p.sitting_out && (isActingSeat || actingTimerSeat === p.seat);
          timerBar.classList.toggle("active", timerShouldShow);
        }

        if ((!isActingSeat || p.sitting_out) && timerFill && actingTimerSeat !== p.seat) {
          timerFill.style.width = "0%";
        }

        if (isActingSeat && !p.sitting_out) {
          seatDiv.classList.add("highlight");
        } else {
          seatDiv.classList.remove("highlight", "timer-warning");
        }
      });

      const statsPlayerStillSeated =
        openStatsSeat !== null &&
        state.players.some(p =>
          p.seat === openStatsSeat &&
          (openStatsPlayerId == null || p.user_id === openStatsPlayerId || p.id === openStatsPlayerId)
        );
      if (!statsPlayerStillSeated) {
        hidePlayerStats();
      }

      detectNewBets(prevState, state);

      rawStatePre.textContent = JSON.stringify(state, null, 2);

      if (Array.isArray(state.recent_hands)) {
        renderHandHistory(state.recent_hands);
      }

      dealFlopBtn.disabled = state.street !== "preflop";
      dealTurnBtn.disabled = state.street !== "flop";
      dealRiverBtn.disabled = state.street !== "turn";
      showdownBtn.disabled = state.street !== "river";

      updateActionDock(state);
      updateSeatChangeUI();
      updateLeaveButton();
    }

    function getViewerSeat(state) {
      if (!state || currentUserId == null) return null;
      const mine = state.players?.find(p => p.user_id === currentUserId);
      return mine ? mine.seat : null;
    }

    function getViewerPlayer(state) {
      if (!state || currentUserId == null) return null;
      return state.players?.find(p => p.user_id === currentUserId) || null;
    }

    function updateLeaveButton() {
      if (!leaveTableBtn) return;
      const mySeat = getViewerSeat(lastState);
      const viewer = getViewerPlayer(lastState);
      const sittingOut = viewer?.sitting_out;

      leaveTableBtn.disabled = !tableId || mySeat == null;
      leaveTableBtn.textContent = mySeat == null
        ? "Leave table"
        : `Leave table (seat ${mySeat})`;

      if (sitOutBtn) {
        sitOutBtn.disabled = !tableId || mySeat == null || Boolean(sittingOut);
      }

      if (returnToPlayBtn) {
        returnToPlayBtn.disabled = !tableId || mySeat == null || !Boolean(sittingOut);
      }
    }

    function updateSeatChangeUI() {
      if (!seatActionMessage || !lastState) return;
      const mySeat = getViewerSeat(lastState);
      const viewer = getViewerPlayer(lastState);
      if (mySeat == null) {
        seatActionMessage.textContent = "Tap an empty seat to join.";
        if (changeSeatBtn) changeSeatBtn.disabled = true;
        return;
      }
      if (viewer?.sitting_out) {
        seatActionMessage.textContent = `You are seated at #${mySeat} and sitting out. Tap I'm back to rejoin.`;
        if (changeSeatBtn) changeSeatBtn.disabled = false;
        return;
      }
      seatActionMessage.textContent = `You are seated at #${mySeat}. Use Change Seat to move.`;
      if (changeSeatBtn) changeSeatBtn.disabled = false;
    }

    function openSeatChangeModal() {
      if (!tableId || !lastState) {
        if (seatActionMessage) {
          seatActionMessage.textContent = "Join a table first.";
        }
        return;
      }

      if (seatChangeError) seatChangeError.textContent = "";
      if (seatChangeOptions) seatChangeOptions.innerHTML = "";

      const mySeat = getViewerSeat(lastState);
      if (seatChangeMessage) {
        seatChangeMessage.textContent =
          mySeat == null
            ? "Pick any open seat."
            : `Currently seated at #${mySeat}. Choose a free seat to move.`;
      }

      for (let seatIndex = 0; seatIndex < totalSeats; seatIndex++) {
        const occupant = lastState.players?.find(p => p.seat === seatIndex);
        const btn = document.createElement("button");
        btn.textContent = occupant
          ? occupant.user_id === currentUserId
            ? `Seat ${seatIndex} (You)`
            : `Seat ${seatIndex} (Taken)`
          : `Seat ${seatIndex}`;
        btn.style.width = "100%";
        btn.disabled = Boolean(occupant) && occupant.user_id !== currentUserId;
        if (!occupant || occupant.user_id === currentUserId) {
          btn.onclick = () => attemptSeatChange(seatIndex);
        }
        seatChangeOptions.appendChild(btn);
      }

      seatChangeModal?.classList.remove("hidden");
    }

    function closeSeatChangeModal() {
      seatChangeModal?.classList.add("hidden");
    }

    async function attemptSeatChange(targetSeat) {
      if (!tableId) return;
      try {
        await api(`/tables/${tableId}/change_seat`, {
          method: "POST",
          body: JSON.stringify({ seat: targetSeat }),
        });
        closeSeatChangeModal();
      } catch (err) {
        if (seatChangeError) {
          seatChangeError.textContent = err.message || "Unable to change seat.";
        } else {
          alert(err.message);
        }
      }
    }

    if (seatChangeCancelBtn) {
      seatChangeCancelBtn.onclick = closeSeatChangeModal;
    }

    async function handleLeaveTable() {
      if (!leaveTableBtn) return;
      if (!tableId) return;
      if (!accessToken) {
        alert("Login first");
        return;
      }

      try {
        leaveTableBtn.disabled = true;
        await api(`/tables/${tableId}/leave`, { method: "POST" });
        await fetchMe();
        const refreshedState = await api(`/tables/${tableId}`, { method: "GET" });
        renderStateWithPacing(refreshedState);
        const leaveNotice =
          "You'll leave the table after the current hand finishes. You can still play this hand.";
        if (typeof window.showCustomAlert === "function") {
          window.showCustomAlert(leaveNotice);
        } else if (typeof window.alert === "function") {
          window.alert(leaveNotice);
        }
      } catch (err) {
        alert(err.message);
      } finally {
        updateLeaveButton();
      }
    }

    if (leaveTableBtn) {
      leaveTableBtn.onclick = handleLeaveTable;
    }

    async function handleSitOut() {
      if (!sitOutBtn || !tableId) return;
      if (!accessToken) {
        alert("Login first");
        return;
      }

      try {
        sitOutBtn.disabled = true;
        const state = await api(`/tables/${tableId}/sit_out`, { method: "POST" });
        renderStateWithPacing(state);
      } catch (err) {
        alert(err.message);
      } finally {
        updateLeaveButton();
      }
    }

    async function handleReturnToPlay() {
      if (!returnToPlayBtn || !tableId) return;
      if (!accessToken) {
        alert("Login first");
        return;
      }

      try {
        returnToPlayBtn.disabled = true;
        const state = await api(`/tables/${tableId}/return`, { method: "POST" });
        renderStateWithPacing(state);
      } catch (err) {
        alert(err.message);
      } finally {
        updateLeaveButton();
      }
    }

    if (sitOutBtn) sitOutBtn.onclick = handleSitOut;
    if (returnToPlayBtn) returnToPlayBtn.onclick = handleReturnToPlay;

    function clearWebSocketTimers() {
      if (wsReconnectTimer) {
        clearTimeout(wsReconnectTimer);
        wsReconnectTimer = null;
      }
      if (wsHeartbeatTimer) {
        clearInterval(wsHeartbeatTimer);
        wsHeartbeatTimer = null;
      }
      if (wsPollTimer) {
        clearInterval(wsPollTimer);
        wsPollTimer = null;
      }
    }

    function connectWebSocket() {
      if (!tableId) return;

      if (tableSocket) {
        wsShouldReconnect = false;
        tableSocket.close();
        tableSocket = null;
      }

      wsShouldReconnect = true;
      clearWebSocketTimers();

      const protocol = window.location.protocol === "https:" ? "wss" : "ws";
      const tokenParam = accessToken ? `?token=${encodeURIComponent(accessToken)}` : "";
      const url = `${protocol}://${window.location.host}/ws/tables/${tableId}${tokenParam}`;
      tableSocket = new WebSocket(url);

      tableSocket.onopen = () => {
        // keep the connection alive and give the backend a nudge to push the latest state
        wsHeartbeatTimer = setInterval(() => {
          if (tableSocket?.readyState === WebSocket.OPEN) {
            tableSocket.send("ping");
          }
        }, WS_HEARTBEAT_MS);

        setChatConnected(true);

        // Stop any HTTP polling once a websocket is active
        if (wsPollTimer) {
          clearInterval(wsPollTimer);
          wsPollTimer = null;
        }
      };

      tableSocket.onmessage = (event) => {
        try {
          const state = JSON.parse(event.data);
          if (handleChatPayload(state)) return;
          renderStateWithPacing(state);
        } catch (e) {
          console.error("Bad WS message", e);
        }
      };

      tableSocket.onclose = () => {
        console.log("WebSocket closed");
        clearWebSocketTimers();
        setChatConnected(false);
        if (!wsShouldReconnect || !tableId) return;
        wsReconnectTimer = setTimeout(connectWebSocket, WS_RECONNECT_MS);

        // Fallback to periodic HTTP polling while websocket access is unavailable
        wsPollTimer = setInterval(async () => {
          if (!tableId) return;
          try {
            const state = await api(`/tables/${tableId}`, { method: "GET" });
            renderStateWithPacing(state);
          } catch (err) {
            console.warn("Polling failed", err);
          }
        }, WS_POLL_MS);
      };

      tableSocket.onerror = (err) => {
        console.error("WebSocket error", err);
        setChatConnected(false);
        if (!wsShouldReconnect || !tableId) return;
        clearWebSocketTimers();
        wsReconnectTimer = setTimeout(connectWebSocket, WS_RECONNECT_MS);
      };
    }

    // -------- Auth actions --------

    registerBtn.onclick = async () => {
      const username = usernameInput.value.trim();
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      if (!username || !email || !password) {
        alert("Enter username, email, and password");
        return;
      }
      try {
        const res = await fetch("/auth/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password, username }),
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Error ${res.status}: ${text}`);
        }
        await res.json();
        alert("Registered. Now login.");
      } catch (e) {
        alert(e.message);
      }
    };

    loginBtn.onclick = async () => {
      const username = usernameInput.value.trim();
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      if (!email || !password) {
        alert("Enter email and password");
        return;
      }
      try {
        const body = new URLSearchParams();
        body.append("username", email);
        body.append("password", password);

        const res = await fetch("/auth/token", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body,
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(`Error ${res.status}: ${text}`);
        }
        const data = await res.json();
        accessToken = data.access_token;
        currentUserEmail = email;
        currentUsername = username || currentUsername;
        if (currentUsernameSpan && currentUsername) {
          currentUsernameSpan.textContent = currentUsername;
        }
        currentUserEmailSpan.textContent = email;
        currentUserEmailSpan.style.display = "inline";

        setAuthEnabled(true);
        persistAuth();

        // Load persisted balance + club
        fetchMe();

        alert("Logged in!");
      } catch (e) {
        alert(e.message);
      }
    };

    if (logoutBtn) {
      logoutBtn.onclick = () => {
        accessToken = null;
        currentUserEmail = null;
        currentUsername = null;
        tableId = null;
        currentTableName = null;
        if (tableHeadingLabel) tableHeadingLabel.textContent = "Table -";
        if (tableIdSpan) tableIdSpan.textContent = "None";
        if (tableGameTypeBadge) tableGameTypeBadge.textContent = "NLH";
        if (tablePanel) tablePanel.classList.remove("plo");
        clearTableCountdown();
        if (tableSocket) {
          wsShouldReconnect = false;
          tableSocket.close();
          tableSocket = null;
        }
        clearWebSocketTimers();
        localStorage.removeItem(AUTH_STORAGE_KEY);
        localStorage.removeItem("poker_token");
        if (currentUsernameSpan) currentUsernameSpan.textContent = "Not logged in";
        if (currentUserEmailSpan) {
          currentUserEmailSpan.textContent = "";
          currentUserEmailSpan.style.display = "none";
        }
        tableOwnerUserId = null;
        lastState = null;
        clearChatMessages();
        setChatConnected(false);
        updateEngineControlsVisibility();
        setAuthEnabled(false);
        updateLeaveButton();
        window.location.href = "/";
      };
    }

    if (chatForm) {
      chatForm.addEventListener("submit", (event) => {
        event.preventDefault();
        const text = (chatInput?.value || "").trim();
        if (!tableId) {
          alert("Join a table to chat.");
          return;
        }
        if (!text) return;

        const preferredName = (currentUsername || usernameInput?.value || "").trim();
        const payload = {
          type: "chat_message",
          message: text,
          username: preferredName || "Player",
        };

        if (tableSocket?.readyState === WebSocket.OPEN) {
          tableSocket.send(JSON.stringify(payload));
          chatInput.value = "";
        } else {
          alert("Chat connection is not ready yet. Trying to reconnect...");
        }
      });
    }

    if (chatVisibilityToggle && tableArea) {
      setChatVisibility(true);

      chatVisibilityToggle.addEventListener("click", () => {
        const isCurrentlyHidden = tableArea.classList.contains("chat-hidden");
        setChatVisibility(isCurrentlyHidden);
      });
    }

    // -------- Wallet actions --------

    if (topupOpenBtn) {
      topupOpenBtn.onclick = () => {
        if (!accessToken) {
          alert("Login first");
          return;
        }
        topupModal.classList.remove("hidden");
      };
    }

    if (buyinRange) {
      buyinRange.addEventListener("input", () => {
        updateBuyinDisplay(Number(buyinRange.value));
      });
    }

    if (buyinCancelBtn) {
      buyinCancelBtn.onclick = hideBuyinModal;
    }

    if (buyinConfirmBtn) {
      buyinConfirmBtn.onclick = submitBuyin;
    }

    if (topupCancelBtn) {
      topupCancelBtn.onclick = () => {
        topupModal.classList.add("hidden");
      };
    }

    if (topupConfirmBtn) {
      topupConfirmBtn.onclick = async () => {
        const amount = Number(topupAmountInput.value);
        if (!amount || amount <= 0) {
          alert("Enter a positive amount");
          return;
        }
        try {
          const me = await api(`/wallet/topup?email=${encodeURIComponent(currentUserEmail)}`, {
            method: "POST",
            body: JSON.stringify({ amount }),
        });
          if (typeof me.balance === "number") {
            updateBalanceUI(me.balance);
          }
          topupModal.classList.add("hidden");
        } catch (e) {
          alert(e.message);
        }
      };
    }

    // -------- Club actions --------

    createClubBtn.onclick = async () => {
      if (!accessToken) {
        alert("Login first");
        return;
      }
      const name = clubNameInput.value.trim() || "My Club";

      try {
        const club = await api("/clubs/", {
          method: "POST",
          body: JSON.stringify({ name }),
        });
        currentClubId = club.id;
        currentClubIdSpan.textContent = String(currentClubId);
        alert(`Created club ID ${currentClubId}`);
        // Tell backend to remember this as my active club
        await api(`/me/club?email=${encodeURIComponent(currentUserEmail)}`, {
          method: "POST",
          body: JSON.stringify({ club_id: club.id }),
        });

   

        // If your backend sets current_club_id on /clubs/ create, /me will reflect it next time
      } catch (e) {
        alert(e.message);
      }
    };

    joinClubBtn.onclick = async () => {
      if (!accessToken) {
        alert("Login first");
        return;
      }
      const cid = Number(joinClubIdInput.value);
      if (!cid) {
        alert("Enter a club ID");
        return;
      }
      try {
        const club = await api(`/clubs/${cid}/join`, {
          method: "POST",
        });
        currentClubId = club.id;
        currentClubIdSpan.textContent = String(currentClubId);
        alert(`Joined club ID ${currentClubId}`);
        // Tell backend to remember this as my active club
        await api(`/me/club?email=${encodeURIComponent(currentUserEmail)}`, {
          method: "POST",
          body: JSON.stringify({ club_id: club.id }),
        });

    

        // For "remember my club", you can also make this update current_club_id server-side
      } catch (e) {
        alert(e.message);
      }
    };

    // -------- Table actions --------

    async function joinTableById(tid) {
      if (!accessToken) {
        alert("Login first");
        return;
      }
      const numericId = Number(tid);
      if (!numericId) {
        alert("Enter a table ID");
        return;
      }
      try {
        const [meta, state] = await Promise.all([
          api(`/tables/${numericId}/meta`, { method: "GET" }),
          api(`/tables/${numericId}`, { method: "GET" }),
        ]);
        tableOwnerUserId = meta?.created_by_user_id ?? null;
        currentTableName = (meta?.table_name || "").trim() || null;
        const createdAt = parseServerDatetime(meta?.created_at);
        if (createdAt != null) {
          startTableCountdown(createdAt + TABLE_EXPIRY_MS);
        } else {
          clearTableCountdown();
        }
        tableId = numericId;
        tableIdSpan.textContent = String(numericId);
        const headingName = formatTableName({
          id: numericId,
          table_name: currentTableName,
        });
        if (tableHeadingLabel) tableHeadingLabel.textContent = headingName;
        updateEngineControlsVisibility();
        clearChatMessages();
        setChatConnected(false);
        connectWebSocket();
        renderStateWithPacing(state);
        setControlsHidden(true);
      } catch (e) {
        tableOwnerUserId = null;
        currentTableName = null;
        clearTableCountdown();
        if (tableHeadingLabel) tableHeadingLabel.textContent = "Table -";
        updateEngineControlsVisibility();
        alert(e.message);
      }
    }

    if (refreshTablesBtn) {
      refreshTablesBtn.onclick = () => loadTableList();
    }
    if (hideFullTablesCheckbox) {
      hideFullTablesCheckbox.addEventListener("change", () => loadTableList());
    }

    dealFlopBtn.onclick = async () => {
      if (!tableId) return;
      try {
        await api(`/tables/${tableId}/deal_flop`, { method: "POST" });
      } catch (e) {
        alert(e.message);
      }
    };

    dealTurnBtn.onclick = async () => {
      if (!tableId) return;
      try {
        await api(`/tables/${tableId}/deal_turn`, { method: "POST" });
      } catch (e) {
        alert(e.message);
      }
    };

    dealRiverBtn.onclick = async () => {
      if (!tableId) return;
      try {
        await api(`/tables/${tableId}/deal_river`, { method: "POST" });
      } catch (e) {
        alert(e.message);
      }
    };

    showdownBtn.onclick = async () => {
      if (!tableId) return;
      try {
        const result = await api(`/tables/${tableId}/showdown`, { method: "POST" });
        alert(
          "Winners: " +
            result.winners.map(w => w.name + " (stack " + w.stack + ")").join(", ")
        );
      } catch (e) {
        alert(e.message);
      }
    };

    setControlsHidden(true);

    // Attempt to rehydrate authentication when the page loads
    restoreAuth();

    if (preselectedTableId) {
      if (accessToken) {
        joinTableById(preselectedTableId);
      } else {
        alert("Please log in to join table " + preselectedTableId);
      }
    }
  </script>

  <div class="legal-footer">
    Play-money entertainment only. Read our
    <a href="/legal.html" target="_blank" rel="noopener">legal disclaimer</a>
    and
    <a href="/terms.html" target="_blank" rel="noopener">terms of service</a>.
  </div>
</body>
</html>
